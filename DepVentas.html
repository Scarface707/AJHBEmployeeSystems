<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM AJHB - Sistema Inmobiliario Profesional</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js removido - usando implementación SVG personalizada -->
    <script>
        // Sistema de gráficos SVG personalizado - NO requiere conexión a internet
        class CustomChart {
            constructor(container, config) {
                this.container = container;
                this.config = config;
                this.svg = null;
                this.width = 800;
                this.height = 400;
                this.padding = { top: 40, right: 80, bottom: 60, left: 80 };
            }

            destroy() {
                if (this.svg) {
                    this.svg.remove();
                    this.svg = null;
                }
            }

            createLineChart() {
                this.destroy();
                
                const data = this.config.data;
                const datasets = data.datasets;
                const labels = data.labels;
                
                if (!labels || labels.length === 0) {
                    this.container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-chart-line" style="color: var(--text-muted);"></i>
                            <h3>Sin datos disponibles</h3>
                            <p>No hay información para mostrar en el gráfico</p>
                        </div>
                    `;
                    return;
                }

                // Crear SVG
                this.svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                this.svg.setAttribute('width', '100%');
                this.svg.setAttribute('height', this.height);
                this.svg.setAttribute('viewBox', `0 0 ${this.width} ${this.height}`);
                this.svg.style.background = 'transparent';

                // Área de gráfico
                const chartWidth = this.width - this.padding.left - this.padding.right;
                const chartHeight = this.height - this.padding.top - this.padding.bottom;

                // Calcular escalas con valores mínimos para evitar gráficos desproporcionados
                const maxX = labels.length - 1;
                
                // Solo para ventas: mínimo de 10 para evitar que 1-2 ventas se vean muy altas
                const rawMaxY1 = Math.max(...datasets[0].data, 0);
                const maxY1 = rawMaxY1 <= 3 ? Math.max(rawMaxY1 * 2, 10) : Math.max(rawMaxY1, 10);

                // Grid líneas
                this.drawGrid(chartWidth, chartHeight, labels.length, maxY1);

                // Ejes
                this.drawAxes(chartWidth, chartHeight, labels, maxY1, 0);

                // Líneas de datos - solo el primer dataset
                datasets.forEach((dataset, index) => {
                    const maxY = maxY1;  // Solo usar la escala principal
                    this.drawLine(dataset, chartWidth, chartHeight, maxX, maxY, index);
                });

                // Leyenda
                this.drawLegend(datasets);

                this.container.appendChild(this.svg);
            }

            drawGrid(chartWidth, chartHeight, xSteps, maxY) {
                const gridGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                
                // Líneas verticales
                for (let i = 0; i <= xSteps; i++) {
                    const x = this.padding.left + (i * chartWidth / (xSteps - 1));
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', x);
                    line.setAttribute('y1', this.padding.top);
                    line.setAttribute('x2', x);
                    line.setAttribute('y2', this.padding.top + chartHeight);
                    line.setAttribute('stroke', 'rgba(201, 169, 110, 0.1)');
                    line.setAttribute('stroke-width', '1');
                    gridGroup.appendChild(line);
                }

                // Líneas horizontales
                const ySteps = 5;
                for (let i = 0; i <= ySteps; i++) {
                    const y = this.padding.top + (i * chartHeight / ySteps);
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', this.padding.left);
                    line.setAttribute('y1', y);
                    line.setAttribute('x2', this.padding.left + chartWidth);
                    line.setAttribute('y2', y);
                    line.setAttribute('stroke', 'rgba(201, 169, 110, 0.1)');
                    line.setAttribute('stroke-width', '1');
                    gridGroup.appendChild(line);
                }

                this.svg.appendChild(gridGroup);
            }

            drawAxes(chartWidth, chartHeight, labels, maxY1, maxY2) {
                // Eje X (inferior)
                const xAxis = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                labels.forEach((label, i) => {
                    const x = this.padding.left + (i * chartWidth / (labels.length - 1));
                    
                    // Etiqueta
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', x);
                    text.setAttribute('y', this.padding.top + chartHeight + 20);
                    text.setAttribute('text-anchor', 'middle');
                    text.setAttribute('fill', '#C9A96E');
                    text.setAttribute('font-size', '12');
                    text.setAttribute('font-family', 'Inter');
                    text.textContent = label;
                    xAxis.appendChild(text);
                });

                // Eje Y1 (izquierdo) - Mostrar valores reales hasta el máximo calculado
                const ySteps = 5;
                for (let i = 0; i <= ySteps; i++) {
                    const value = Math.round((maxY1 / ySteps) * (ySteps - i));
                    const y = this.padding.top + (i * chartHeight / ySteps);
                    
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', this.padding.left - 10);
                    text.setAttribute('y', y + 4);
                    text.setAttribute('text-anchor', 'end');
                    text.setAttribute('fill', '#C9A96E');
                    text.setAttribute('font-size', '11');
                    text.setAttribute('font-family', 'Inter');
                    // Solo mostrar valores enteros para ventas
                    text.textContent = Number.isInteger(value) ? value : Math.ceil(value);
                    xAxis.appendChild(text);
                }

                // Eje Y2 (derecho) - No mostrar cuando solo hay un dataset
                // Removido para simplificar el gráfico

                this.svg.appendChild(xAxis);
            }

            drawLine(dataset, chartWidth, chartHeight, maxX, maxY, datasetIndex) {
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                
                let pathData = '';
                const points = [];

                dataset.data.forEach((value, i) => {
                    const x = this.padding.left + (i * chartWidth / maxX);
                    const y = this.padding.top + chartHeight - (value * chartHeight / maxY);
                    
                    points.push({ x, y, value });
                    
                    if (i === 0) {
                        pathData += `M ${x} ${y}`;
                    } else {
                        pathData += ` L ${x} ${y}`;
                    }
                });

                // Área de relleno si está habilitada (con animación)
                if (dataset.fill && dataset.backgroundColor) {
                    const fillPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    const fillData = pathData + ` L ${this.padding.left + chartWidth} ${this.padding.top + chartHeight} L ${this.padding.left} ${this.padding.top + chartHeight} Z`;
                    fillPath.setAttribute('d', fillData);
                    fillPath.setAttribute('fill', dataset.backgroundColor);
                    fillPath.setAttribute('stroke', 'none');
                    
                    // Agregar animación de relleno suave
                    fillPath.style.opacity = '0';
                    fillPath.style.transition = 'opacity 1.5s ease-in-out';
                    
                    // Animar después de un pequeño delay para que se vea gradual
                    setTimeout(() => {
                        fillPath.style.opacity = '1';
                    }, 500);
                    
                    line.appendChild(fillPath);
                }

                // Línea principal con animación de trazado
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', pathData);
                path.setAttribute('stroke', dataset.borderColor);
                path.setAttribute('stroke-width', dataset.borderWidth || 2);
                path.setAttribute('fill', 'none');
                path.setAttribute('stroke-linejoin', 'round');
                path.setAttribute('stroke-linecap', 'round');
                
                // Animación de trazado de línea
                const pathLength = path.getTotalLength();
                path.setAttribute('stroke-dasharray', pathLength + ' ' + pathLength);
                path.setAttribute('stroke-dashoffset', pathLength);
                path.style.transition = 'stroke-dashoffset 2s ease-in-out';
                
                // Iniciar animación después de agregar al DOM
                setTimeout(() => {
                    path.setAttribute('stroke-dashoffset', '0');
                }, 100);

                line.appendChild(path);

                // Puntos con animación escalonada
                points.forEach((point, i) => {
                    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    circle.setAttribute('cx', point.x);
                    circle.setAttribute('cy', point.y);
                    circle.setAttribute('r', dataset.pointRadius || 4);
                    circle.setAttribute('fill', dataset.pointBackgroundColor || dataset.borderColor);
                    circle.setAttribute('stroke', dataset.pointBorderColor || '#ffffff');
                    circle.setAttribute('stroke-width', dataset.pointBorderWidth || 2);
                    
                    // Animación de aparición escalonada para cada punto
                    circle.style.opacity = '0';
                    circle.style.transform = 'scale(0)';
                    circle.style.transformOrigin = 'center';
                    circle.style.transition = 'opacity 0.5s ease-out, transform 0.5s ease-out';
                    
                    // Delay escalonado: cada punto aparece 300ms después del anterior
                    setTimeout(() => {
                        circle.style.opacity = '1';
                        circle.style.transform = 'scale(1)';
                    }, 1000 + (i * 300));
                    
                    // Tooltip en hover
                    circle.addEventListener('mouseenter', (e) => {
                        this.showTooltip(e, point, dataset, datasetIndex);
                        // Efecto hover: hacer el punto más grande
                        circle.style.transition = 'transform 0.2s ease-out';
                        circle.style.transform = 'scale(1.3)';
                    });
                    
                    circle.addEventListener('mouseleave', () => {
                        this.hideTooltip();
                        // Volver al tamaño original
                        circle.style.transition = 'transform 0.2s ease-out';
                        circle.style.transform = 'scale(1)';
                    });
                    
                    line.appendChild(circle);
                });

                this.svg.appendChild(line);
            }

            drawLegend(datasets) {
                const legend = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                
                datasets.forEach((dataset, i) => {
                    const x = 50 + (i * 200);
                    const y = 25;
                    
                    // Línea de muestra
                    const sampleLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    sampleLine.setAttribute('x1', x);
                    sampleLine.setAttribute('y1', y);
                    sampleLine.setAttribute('x2', x + 20);
                    sampleLine.setAttribute('y2', y);
                    sampleLine.setAttribute('stroke', dataset.borderColor);
                    sampleLine.setAttribute('stroke-width', 3);
                    legend.appendChild(sampleLine);
                    
                    // Texto
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', x + 25);
                    text.setAttribute('y', y + 4);
                    text.setAttribute('fill', '#E5D5B7');
                    text.setAttribute('font-size', '13');
                    text.setAttribute('font-family', 'Inter');
                    text.textContent = dataset.label;
                    legend.appendChild(text);
                });

                this.svg.appendChild(legend);
            }

            showTooltip(event, point, dataset, datasetIndex) {
                // Crear tooltip simple
                let tooltip = document.getElementById('chartTooltip');
                if (!tooltip) {
                    tooltip = document.createElement('div');
                    tooltip.id = 'chartTooltip';
                    tooltip.style.cssText = `
                        position: absolute;
                        background: rgba(42, 42, 42, 0.95);
                        color: #E5D5B7;
                        padding: 8px 12px;
                        border-radius: 6px;
                        font-size: 12px;
                        font-family: Inter;
                        border: 1px solid #C9A96E;
                        z-index: 10000;
                        pointer-events: none;
                    `;
                    document.body.appendChild(tooltip);
                }

                const value = datasetIndex === 0 ? 
                    `${dataset.label}: ${point.value} propiedades` :
                    `${dataset.label}: ₡${(point.value * 1000000).toLocaleString()}`;

                tooltip.innerHTML = value;
                tooltip.style.display = 'block';
                tooltip.style.left = event.pageX + 10 + 'px';
                tooltip.style.top = event.pageY - 10 + 'px';
            }

            hideTooltip() {
                const tooltip = document.getElementById('chartTooltip');
                if (tooltip) {
                    tooltip.style.display = 'none';
                }
            }
        }

        // Compatibilidad con código existente que usa Chart
        window.Chart = {
            Chart: CustomChart
        };
    </script>
    <style>
        /* ===== RESET Y CONFIGURACIÓN BASE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            /* Colores principales - Esquema Dorado */
            --primary: #C9A96E;
            --primary-dark: #B8956A;
            --primary-light: #D4B477;
            --secondary: #8B7355;
            --accent: #E5D5B7;
            --success: #2ECC71;
            --warning: #F39C12;
            --error: #E74C3C;
            
            /* Backgrounds - Tonos oscuros con toques dorados */
            --bg-primary: #1a1a1a;
            --bg-secondary: #2a2a2a;
            --bg-tertiary: #3a3a3a;
            --bg-card: #2a2a2a;
            --bg-modal: rgba(26, 26, 26, 0.95);
            
            /* Textos */
            --text-primary: #F8F9FA;
            --text-secondary: #E5D5B7;
            --text-muted: #C9A96E;
            
            /* Bordes y sombras con toques dorados */
            --border: #C9A96E;
            --border-light: #D4B477;
            --shadow: 0 4px 6px -1px rgba(201, 169, 110, 0.3);
            --shadow-lg: 0 10px 15px -3px rgba(201, 169, 110, 0.2);
            --shadow-xl: 0 20px 25px -5px rgba(201, 169, 110, 0.1);
            
            /* Transiciones */
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-fast: all 0.15s ease-in-out;
            
            /* Espaciado */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
            --space-2xl: 3rem;
            
            /* Radius */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
            font-feature-settings: "cv01", "cv02", "cv03", "cv04";
        }

        /* ===== LAYOUT PRINCIPAL ===== */
        .app-container {
            display: flex;
            min-height: 100vh;
            position: relative;
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
            border-right: 1px solid var(--border);
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
            z-index: 1000;
            overflow-y: auto;
            transition: var(--transition);
            transform: translateX(-100%);
        }

        .sidebar.show {
            transform: translateX(0);
        }

        /* Overlay para cerrar sidebar */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .sidebar-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .logo {
            padding: var(--space-2xl) var(--space-xl);
            border-bottom: 1px solid var(--border);
            text-align: center;
            background: linear-gradient(135deg, rgba(201, 169, 110, 0.08) 0%, rgba(212, 180, 119, 0.05) 100%);
            position: relative;
        }

        .logo::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
        }

        .logo h1 {
            font-size: 1.75rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.025em;
        }

        .nav-menu {
            padding: var(--space-lg) 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: var(--space-md) var(--space-xl);
            margin: var(--space-xs) var(--space-md);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            color: var(--text-secondary);
            position: relative;
            border: 1px solid transparent;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(201, 169, 110, 0.1), transparent);
            transition: var(--transition);
        }

        .nav-item:hover::before {
            left: 100%;
        }

        .nav-item:hover {
            background: linear-gradient(90deg, rgba(201, 169, 110, 0.08) 0%, rgba(212, 180, 119, 0.12) 100%);
            color: var(--text-primary);
            transform: translateX(6px);
            border-color: rgba(201, 169, 110, 0.3);
            box-shadow: 0 4px 12px rgba(201, 169, 110, 0.15);
        }

        .nav-item.active {
            background: linear-gradient(90deg, rgba(201, 169, 110, 0.15) 0%, rgba(212, 180, 119, 0.1) 100%);
            color: var(--primary-light);
            border-left: 4px solid var(--primary);
            border-color: rgba(201, 169, 110, 0.4);
            box-shadow: 0 2px 8px rgba(201, 169, 110, 0.2);
            font-weight: 600;
        }

        .nav-item.active::after {
            content: '';
            position: absolute;
            right: var(--space-md);
            top: 50%;
            transform: translateY(-50%);
            width: 6px;
            height: 6px;
            background: var(--primary);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--primary);
        }

        .nav-item i {
            width: 20px;
            text-align: center;
            margin-right: var(--space-md);
            font-size: 1.1rem;
            transition: var(--transition);
            filter: drop-shadow(0 0 3px transparent);
        }

        .nav-item:hover i {
            transform: scale(1.1);
            color: var(--primary-light);
            filter: drop-shadow(0 0 6px rgba(201, 169, 110, 0.4));
        }

        .nav-item.active i {
            color: var(--primary);
            transform: scale(1.05);
            filter: drop-shadow(0 0 8px rgba(201, 169, 110, 0.6));
        }

        /* ===== CONTENIDO PRINCIPAL ===== */
        .main-content {
            flex: 1;
            margin-left: 0;
            transition: var(--transition);
            background: var(--bg-primary);
        }

        .main-content.with-sidebar {
            margin-left: 280px;
        }

        /* ===== HEADER ===== */
        .header {
            background: linear-gradient(90deg, var(--bg-secondary) 0%, rgba(201, 169, 110, 0.03) 50%, var(--bg-secondary) 100%);
            border-bottom: 1px solid var(--border);
            padding: var(--space-lg) var(--space-xl);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(201, 169, 110, 0.1);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .menu-toggle {
            display: block;
            background: linear-gradient(135deg, rgba(201, 169, 110, 0.1) 0%, rgba(212, 180, 119, 0.05) 100%);
            border: 1px solid rgba(201, 169, 110, 0.3);
            color: var(--text-primary);
            font-size: 1.25rem;
            cursor: pointer;
            padding: var(--space-sm);
            border-radius: var(--radius-md);
            transition: var(--transition-fast);
            position: relative;
            overflow: hidden;
        }

        .menu-toggle::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(201, 169, 110, 0.2), transparent);
            transition: var(--transition);
        }

        .menu-toggle:hover::before {
            left: 100%;
        }

        .menu-toggle:hover {
            background: linear-gradient(135deg, rgba(201, 169, 110, 0.15) 0%, rgba(212, 180, 119, 0.08) 100%);
            border-color: rgba(201, 169, 110, 0.5);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(201, 169, 110, 0.2);
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--primary-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
            position: relative;
        }

        .page-title::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 0;
            width: 40px;
            height: 2px;
            background: linear-gradient(90deg, var(--primary), transparent);
            border-radius: 2px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* ===== INDICADOR DE ROLES ===== */
        .user-role-indicator {
            animation: slideInRight 0.5s ease-out;
        }

        .role-badge {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-lg);
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .role-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .role-badge i {
            font-size: 1rem;
        }

        .role-subtitle {
            display: block;
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 2px;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* ===== CONTENIDO DEL DASHBOARD ===== */
        .dashboard-content {
            padding: var(--space-xl);
        }

        .content-section {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ===== GRID DE ESTADÍSTICAS ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-lg);
            margin-bottom: var(--space-2xl);
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-xl);
            padding: var(--space-xl);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
            border-color: var(--border-light);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: white;
        }

        .stat-icon.success { background: var(--success); }
        .stat-icon.primary { background: var(--primary); }
        .stat-icon.warning { background: var(--warning); }
        .stat-icon.accent { background: var(--accent); }

        .stat-summary {
            text-align: center;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
        }

        .stat-summary .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: var(--space-xs);
        }

        .stat-summary .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .stat-summary .stat-icon {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            font-size: 1rem;
        }

        /* ===== BADGES ADICIONALES ===== */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.375rem;
            background-color: var(--primary);
            color: white;
            border: 1px solid var(--primary);
        }

        .stat-value {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
            margin-bottom: var(--space-xs);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
        }

        /* ===== TARJETAS Y CONTENEDORES ===== */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-xl);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .card-header {
            padding: var(--space-xl);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .card-body {
            padding: var(--space-xl);
        }

        /* ===== BOTONES ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            padding: var(--space-md) var(--space-lg);
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: var(--transition-fast);
            text-decoration: none;
            min-height: 40px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: 1px solid var(--primary);
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: var(--transition);
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(201, 169, 110, 0.3);
            border-color: var(--primary-light);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: var(--error);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #dc2626;
        }

        .btn-sm {
            padding: var(--space-sm) var(--space-md);
            font-size: 0.75rem;
            min-height: 32px;
        }

        /* ===== TABLAS ===== */
        .table-container {
            overflow-x: auto;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-card);
        }

        .table th {
            background: var(--bg-tertiary);
            padding: var(--space-md) var(--space-lg);
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border);
            font-size: 0.875rem;
            white-space: nowrap;
        }

        .table td {
            padding: var(--space-md) var(--space-lg);
            border-bottom: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .table tbody tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .table tbody tr:last-child td {
            border-bottom: none;
        }

        /* ===== BADGES DE ESTADO ===== */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: var(--space-xs) var(--space-sm);
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .status-disponible,
        .status-available {
            background: rgba(46, 204, 113, 0.2);
            color: #2ECC71;
            border: 1px solid rgba(46, 204, 113, 0.3);
        }

        .status-vendida,
        .status-sold {
            background: rgba(231, 76, 60, 0.2);
            color: #E74C3C;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .status-reservada,
        .status-reserved {
            background: rgba(243, 156, 18, 0.2);
            color: #F39C12;
            border: 1px solid rgba(243, 156, 18, 0.3);
        }

        .status-ennegociacion,
        .status-negotiating,
        .status-en-negociacion {
            background: rgba(201, 169, 110, 0.2);
            color: #C9A96E;
            border: 1px solid rgba(201, 169, 110, 0.3);
        }

        /* ===== ESTADOS VACÍOS ===== */
        .empty-state {
            text-align: center;
            padding: var(--space-2xl);
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: var(--space-lg);
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: var(--space-sm);
            color: var(--text-secondary);
        }

        .empty-state p {
            font-size: 0.875rem;
        }

        /* ===== MODALES ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-modal);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            -webkit-backdrop-filter: blur(4px);
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-xl);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9) translateY(20px);
            transition: var(--transition);
        }

        .modal-overlay.active .modal {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            padding: var(--space-xl);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: var(--space-xs);
            border-radius: var(--radius-sm);
            transition: var(--transition-fast);
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .modal-body {
            padding: var(--space-xl);
        }

        /* ===== FORMULARIOS ===== */
        .form-group {
            margin-bottom: var(--space-lg);
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-sm);
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: var(--space-md);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: var(--transition-fast);
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-help {
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-top: 0.25rem;
            display: block;
        }

        /* ===== NOTIFICACIONES ===== */
        .notification {
            position: fixed;
            top: var(--space-lg);
            right: var(--space-lg);
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            color: var(--text-primary);
            transform: translateX(400px);
            opacity: 0;
            transition: var(--transition);
            z-index: 10001;
            max-width: 350px;
            box-shadow: var(--shadow-xl);
            display: flex;
            align-items: flex-start;
            gap: var(--space-md);
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
            animation: notificationSlide 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .notification.hide {
            animation: notificationSlideOut 0.3s ease-in;
        }

        @keyframes notificationSlide {
            0% {
                transform: translateX(400px);
                opacity: 0;
            }
            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes notificationSlideOut {
            0% {
                transform: translateX(0);
                opacity: 1;
            }
            100% {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .notification-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: var(--space-xs);
        }

        .notification-message {
            font-size: 0.8rem;
            opacity: 0.9;
            line-height: 1.4;
        }

        .notification-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: var(--space-xs);
            border-radius: var(--radius-sm);
            transition: var(--transition-fast);
            font-size: 1rem;
            flex-shrink: 0;
        }

        .notification-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .notification-success { 
            border-left: 4px solid var(--success);
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(46, 204, 113, 0.05) 100%);
        }
        .notification-success .notification-icon {
            background: var(--success);
            color: white;
        }

        .notification-error { 
            border-left: 4px solid var(--error);
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(231, 76, 60, 0.05) 100%);
        }
        .notification-error .notification-icon {
            background: var(--error);
            color: white;
        }

        .notification-info { 
            border-left: 4px solid var(--primary);
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(201, 169, 110, 0.05) 100%);
        }
        .notification-info .notification-icon {
            background: var(--primary);
            color: white;
        }

        .notification-warning { 
            border-left: 4px solid var(--warning);
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(243, 156, 18, 0.05) 100%);
        }
        .notification-warning .notification-icon {
            background: var(--warning);
            color: white;
        }

        /* Container para múltiples notificaciones */
        .notifications-container {
            position: fixed;
            top: var(--space-lg);
            right: var(--space-lg);
            z-index: 10001;
            pointer-events: none;
        }

        .notifications-container .notification {
            position: relative;
            top: auto;
            right: auto;
            margin-bottom: var(--space-md);
            pointer-events: all;
        }

        /* ===== GRÁFICOS BASE ===== */

        /* ===== UTILITIES ===== */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .section-header { margin-bottom: 2rem; }
        .section-title { margin-bottom: 2rem; }
        .gap-4 { gap: var(--space-md); }
        .calendar-layout { grid-template-columns: 2fr 1fr; gap: 2rem; }
        .card-spaced { margin-top: 2rem; }

        /* ===== ESTILOS ESPECÍFICOS ===== */
        .text-center-th { text-align: center; }
        .form-grid-2 { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 1rem; 
        }

        /* ===== ESTILOS PARA TENDENCIAS DE VENTAS ===== */
        .detailed-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
        }

        .stat-card {
            background: rgba(201, 169, 110, 0.1);
            border: 1px solid rgba(201, 169, 110, 0.2);
            border-radius: 12px;
            padding: 1.25rem;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            background: rgba(201, 169, 110, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(201, 169, 110, 0.15);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
        }

        /* ===== GRÁFICOS MEJORADOS ===== */
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
            margin: 1rem 0;
            padding: 1rem;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .chart-container canvas,
        .chart-container svg {
            max-height: 100%;
            max-width: 100%;
            border-radius: var(--radius-md);
        }

        .chart-container-300 {
            height: 300px;
        }

        /* Grid para gráficos de reportes */
        .revenue-chart-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .property-charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        /* Estados vacíos mejorados */
        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin: 0 0 0.5rem 0;
            color: var(--text-light);
        }

        .empty-state p {
            margin: 0;
            font-size: 0.875rem;
        }

        /* ===== ESTILOS DE CALENDARIO ===== */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
        }

        .calendar-header-day {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: var(--space-md);
            text-align: center;
            font-weight: 600;
            color: white;
            font-size: 0.875rem;
            letter-spacing: 0.5px;
        }

        .calendar-day {
            background: var(--bg-card);
            padding: var(--space-sm);
            min-height: 120px;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            display: flex;
            flex-direction: column;
            border: 1px solid transparent;
        }

        .calendar-day:hover {
            background: var(--bg-tertiary);
            border-color: var(--primary);
            transform: scale(1.02);
            z-index: 2;
            box-shadow: var(--shadow);
        }

        .calendar-day.today {
            background: linear-gradient(135deg, rgba(201, 169, 110, 0.15) 0%, rgba(212, 180, 119, 0.1) 100%);
            border: 2px solid var(--primary);
            box-shadow: 0 0 15px rgba(201, 169, 110, 0.3);
        }

        .calendar-day.selected {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            transform: scale(1.02);
            z-index: 3;
            box-shadow: var(--shadow-xl);
        }

        .calendar-day.other-month {
            color: var(--text-muted);
            background: var(--bg-primary);
            opacity: 0.5;
        }

        .calendar-day-number {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: var(--space-xs);
            flex-shrink: 0;
        }

        .calendar-appointment {
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
            font-weight: 500;
        }

        .calendar-appointment:hover {
            background: linear-gradient(90deg, var(--accent) 0%, var(--primary) 100%);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(201, 169, 110, 0.3);
        }

        .calendar-day.selected .calendar-appointment {
            background: rgba(255, 255, 255, 0.9);
            color: var(--primary);
            font-weight: 600;
        }

        .appointment-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            margin-bottom: var(--space-md);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .appointment-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
        }

        .appointment-item:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            background: var(--bg-tertiary);
        }

        .appointment-time {
            font-weight: 600;
            color: var(--primary);
            font-size: 0.875rem;
            margin-bottom: var(--space-xs);
        }

        .appointment-title {
            font-weight: 500;
            margin: var(--space-xs) 0;
            color: var(--text-primary);
        }

        .appointment-client,
        .appointment-property {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin: var(--space-xs) 0;
        }

        .appointment-client i,
        .appointment-property i,
        .appointment-time i {
            margin-right: var(--space-xs);
            width: 14px;
            text-align: center;
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
        }

        @media (max-width: 768px) {
            :root {
                --space-xs: 0.125rem;
                --space-sm: 0.25rem;
                --space-md: 0.5rem;
                --space-lg: 1rem;
                --space-xl: 1.5rem;
                --space-2xl: 2rem;
            }

            .sidebar {
                width: 100%;
                z-index: 10000;
            }

            .main-content {
                margin-left: 0;
            }

            .header {
                padding: var(--space-md) var(--space-lg);
            }

            .page-title {
                font-size: 1.25rem;
            }

            .dashboard-content {
                padding: var(--space-lg);
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: var(--space-md);
            }

            .stat-card {
                padding: var(--space-lg);
            }

            .stat-value {
                font-size: 1.75rem;
            }

            .card-header,
            .card-body {
                padding: var(--space-lg);
            }

            .table th,
            .table td {
                padding: var(--space-sm) var(--space-md);
                font-size: 0.75rem;
            }

            .btn {
                padding: var(--space-sm) var(--space-md);
                font-size: 0.75rem;
            }

            .modal {
                width: 95%;
                margin: var(--space-lg);
            }

            .modal-header,
            .modal-body {
                padding: var(--space-lg);
            }

            .notification {
                right: var(--space-md);
                left: var(--space-md);
                max-width: none;
            }

            /* Responsive para gráficos y reportes */
            .chart-container {
                height: 300px;
                padding: 0.5rem;
            }

            .chart-container-300 {
                height: 250px;
            }

            .property-charts-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .revenue-chart-grid {
                gap: 1rem;
            }

            .calendar-layout {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .calendar-day {
                min-height: 80px;
                padding: 0.25rem;
            }

            .calendar-appointment {
                font-size: 0.65rem;
                padding: 0.15rem 0.3rem;
            }

            .appointment-item {
                padding: 0.75rem;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                gap: var(--space-sm);
            }

            .stat-card {
                padding: var(--space-md);
            }

            .stat-value {
                font-size: 1.5rem;
            }

            .card-header,
            .card-body {
                padding: var(--space-md);
            }

            .dashboard-content {
                padding: var(--space-md);
            }

            .btn {
                min-height: 36px;
            }
        }

        /* ===== ANIMACIONES ADICIONALES ===== */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        .slide-up {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* ===== MEJORAS DE ACCESIBILIDAD ===== */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* ===== SCROLL PERSONALIZADO ===== */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--border-light);
        }

        /* ===== FEEDBACK VISUAL ADICIONAL ===== */
        .nav-item:active {
            transform: translateX(6px) scale(0.98);
        }

        .btn:active {
            transform: translateY(-1px) scale(0.98);
        }

        .menu-toggle:active {
            transform: scale(0.95);
        }

        /* Efecto de ondas para clics */
        .ripple {
            position: relative;
            overflow: hidden;
        }

        .ripple::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(201, 169, 110, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .ripple:active::after {
            width: 300px;
            height: 300px;
        }

        /* ===== ESTILOS SISTEMA DE METAS MENSUALES ===== */
        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: linear-gradient(135deg, rgba(201, 169, 110, 0.1) 0%, rgba(212, 180, 119, 0.05) 100%);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(201, 169, 110, 0.2);
        }

        .goal-header h4 {
            margin: 0;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
        }

        .goal-amount {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            text-shadow: 0 0 10px rgba(201, 169, 110, 0.3);
        }

        .goal-progress {
            margin-bottom: 1.5rem;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            border: 2px solid rgba(201, 169, 110, 0.2);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .progress-fill {
            height: 100%;
            border-radius: 8px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 50%, var(--primary) 100%);
            box-shadow: 0 0 20px rgba(201, 169, 110, 0.4);
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: progressShine 2s infinite;
        }

        @keyframes progressShine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-text {
            text-align: center;
            margin-top: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .goal-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .goal-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            border: 1px solid rgba(201, 169, 110, 0.1);
            transition: var(--transition);
        }

        .goal-stat:hover {
            border-color: rgba(201, 169, 110, 0.3);
            transform: translateY(-2px);
        }

        .goal-stat .stat-label {
            color: var(--text-muted);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .goal-stat .stat-value {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.875rem;
        }

        .goal-stat .stat-value.achieved {
            color: var(--success);
            text-decoration: line-through;
        }

        .goal-achievement {
            text-align: center;
            padding: 1rem;
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.15) 0%, rgba(46, 204, 113, 0.05) 100%);
            border: 2px solid var(--success);
            border-radius: var(--radius-lg);
            color: var(--success);
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            animation: goalAchieved 2s ease-in-out;
        }

        .goal-warning {
            text-align: center;
            padding: 1rem;
            background: linear-gradient(135deg, rgba(243, 156, 18, 0.15) 0%, rgba(243, 156, 18, 0.05) 100%);
            border: 2px solid var(--warning);
            border-radius: var(--radius-lg);
            color: var(--warning);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .goal-motivation {
            text-align: center;
            padding: 1rem;
            background: linear-gradient(135deg, rgba(201, 169, 110, 0.15) 0%, rgba(201, 169, 110, 0.05) 100%);
            border: 2px solid var(--primary);
            border-radius: var(--radius-lg);
            color: var(--primary);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        @keyframes goalAchieved {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.05); }
            50% { transform: scale(1.1); }
            75% { transform: scale(1.05); }
        }

        /* Responsive para metas */
        @media (max-width: 768px) {
            .goal-stats {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .goal-header {
                flex-direction: column;
                text-align: center;
                gap: 0.5rem;
            }
            
            .goal-amount {
                font-size: 1.25rem;
            }
        }
        
        /* ===== CLASES PARA ESTILOS INLINE REMOVIDOS ===== */
        .auto-width-select {
            width: auto;
        }
        
        .stat-icon-accent-color {
            color: #8B7355;
        }
        
        .revenue-chart-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }
        
        .property-charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }
        
        .chart-container-300 {
            height: 300px;
        }
        
        .empty-table-cell-padding {
            padding: 2rem;
            text-align: center;
        }
        
        .stat-icon-accent-bg {
            background: #8B7355;
        }

        .stat-icon-accent-color {
            color: #8B7355;
        }

        /* ===== MEJORAS PARA REPORTES ===== */
        .reports-section {
            min-height: 600px;
        }

        .report-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .report-controls .btn {
            flex: 0 0 auto;
        }

        .report-metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        /* ===== BADGES DE OPERACIONES ===== */
        .operation-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: capitalize;
            letter-spacing: 0.025em;
            gap: 0.375rem;
        }
        
        .operation-venta {
            background: rgba(46, 204, 113, 0.2);
            color: #2ECC71;
            border: 1px solid rgba(46, 204, 113, 0.3);
        }
        
        .operation-compra {
            background: rgba(52, 152, 219, 0.2);
            color: #3498DB;
            border: 1px solid rgba(52, 152, 219, 0.3);
        }
        
        .operation-arriendo {
            background: rgba(155, 89, 182, 0.2);
            color: #9B59B6;
            border: 1px solid rgba(155, 89, 182, 0.3);
        }
        
        .operation-sin-especificar {
            background: rgba(149, 165, 166, 0.2);
            color: #95A5A6;
            border: 1px solid rgba(149, 165, 166, 0.3);
        }
        
        /* ===== MODAL DE CONFIRMACIÓN DE ELIMINACIÓN ===== */
        .confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10002;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
        }
        
        .confirmation-modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .confirmation-dialog {
            background: var(--bg-card);
            border: 2px solid var(--error);
            border-radius: var(--radius-xl);
            width: 90%;
            max-width: 500px;
            padding: 0;
            transform: scale(0.9) translateY(20px);
            transition: var(--transition);
            box-shadow: 0 25px 50px rgba(231, 76, 60, 0.3);
            overflow: hidden;
        }
        
        .confirmation-modal.show .confirmation-dialog {
            transform: scale(1) translateY(0);
        }
        
        .confirmation-header {
            background: linear-gradient(135deg, var(--error) 0%, #dc2626 100%);
            color: white;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .confirmation-header .icon {
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .confirmation-header .content h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 700;
        }
        
        .confirmation-header .content p {
            margin: 0.25rem 0 0 0;
            opacity: 0.9;
            font-size: 0.875rem;
        }
        
        .confirmation-body {
            padding: 2rem;
            background: var(--bg-card);
        }
        
        .item-details {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .item-details h4 {
            color: var(--text-primary);
            margin: 0 0 1rem 0;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .detail-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .detail-label {
            color: var(--text-muted);
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .detail-value {
            color: var(--text-primary);
            font-weight: 600;
            text-align: right;
        }
        
        .warning-message {
            background: linear-gradient(135deg, rgba(243, 156, 18, 0.15) 0%, rgba(243, 156, 18, 0.05) 100%);
            border: 1px solid var(--warning);
            border-radius: var(--radius-md);
            padding: 1rem;
            color: var(--warning);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        
        .warning-message .icon {
            width: 24px;
            height: 24px;
            background: var(--warning);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            flex-shrink: 0;
        }
        
        .confirmation-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }
        
        .confirmation-actions .btn {
            min-width: 120px;
            font-weight: 600;
            position: relative;
            overflow: hidden;
        }
        
        .btn-confirm-delete {
            background: linear-gradient(135deg, var(--error) 0%, #dc2626 100%);
            color: white;
            border: 1px solid var(--error);
        }
        
        .btn-confirm-delete:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
        }
        
        .btn-cancel {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .btn-cancel:hover {
            background: var(--bg-secondary);
            border-color: var(--border-light);
        }
        
        /* ===== ESTILOS DE CALENDARIO AVANZADO ===== */
        .calendar-filters {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }
        
        .calendar-filters .form-label {
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
        }
        
        .btn-export-calendar {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }
        
        .color-legend {
            margin-top: 0.75rem;
        }
        
        .color-legend-container {
            flex-wrap: wrap;
        }
        
        .color-legend-text {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .color-legend-item {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .color-legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .color-legend-dot-venta { background: #E74C3C; }
        .color-legend-dot-compra { background: #2ECC71; }
        .color-legend-dot-arriendo { background: #F39C12; }
        .color-legend-dot-visita { background: #3498DB; }
        .color-legend-dot-otros { background: #C9A96E; }
        
        .color-legend-label {
            font-size: 0.75rem;
        }

        /* ===== EFECTOS VISUALES AVANZADOS ===== */
        .fade-in {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .fade-in.animate {
            opacity: 1;
            transform: translateY(0);
        }

        .smooth-loader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: opacity 0.3s ease;
        }

        .loader-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .loader-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(201, 169, 110, 0.2);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loader-text {
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
        }

        /* ===== NOTIFICACIONES MEJORADAS ===== */
        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1rem 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            z-index: 3000;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 300px;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left: 4px solid var(--success);
        }

        .notification.error {
            border-left: 4px solid var(--error);
        }

        .notification.warning {
            border-left: 4px solid var(--warning);
        }

        .notification.info {
            border-left: 4px solid var(--primary);
        }

        /* ===== SCROLL PERSONALIZADO ===== */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary), var(--primary-dark));
            border-radius: 4px;
            transition: background 0.3s ease;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, var(--primary-dark), var(--accent));
        }

        /* ===== ANIMACIONES FINALES ===== */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(201, 169, 110, 0.4);
            }
            50% {
                transform: scale(1.02);
                box-shadow: 0 0 0 8px rgba(201, 169, 110, 0.1);
            }
        }

        .pulse-animation {
            animation: pulse 2s infinite;
        }

        /* ===== TRANSICIONES SUAVES GLOBALES ===== */
        .content-section {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card:hover,
        .property-card:hover,
        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }
    </style>
</head>
<body>
    <!-- Overlay para sidebar -->
    <div id="sidebarOverlay" class="sidebar-overlay" onclick="closeSidebar()"></div>
    
    <!-- Aplicación principal -->
    <div class="app-container" id="appContainer">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="logo">
                <h1>CRM AJHB</h1>
            </div>
            <nav class="nav-menu">
                <div class="nav-item active ripple" onclick="switchSection('dashboard')" data-section="dashboard">
                    <i class="fas fa-chart-line"></i> Dashboard
                </div>
                <div class="nav-item ripple" onclick="switchSection('properties')" data-section="properties">
                    <i class="fas fa-building"></i> Propiedades
                </div>
                <div class="nav-item ripple" onclick="switchSection('clients')" data-section="clients">
                    <i class="fas fa-users"></i> Clientes
                </div>
                <div class="nav-item ripple" onclick="switchSection('prospects')" data-section="prospects">
                    <i class="fas fa-user-plus"></i> Clientes Potenciales
                </div>
                <div class="nav-item ripple" onclick="switchSection('contracts')" data-section="contracts">
                    <i class="fas fa-file-contract"></i> Contratos
                </div>
                <div class="nav-item ripple" onclick="switchSection('calendar')" data-section="calendar">
                    <i class="fas fa-calendar-alt"></i> Calendario
                </div>
                <div class="nav-item ripple" onclick="switchSection('reports')" data-section="reports">
                    <i class="fas fa-chart-bar"></i> Reportes
                </div>
            </nav>
        </aside>

        <!-- Contenido principal -->
        <main class="main-content" id="mainContent">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <button type="button" class="menu-toggle ripple" onclick="toggleSidebar()" title="Alternar menú">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h2 class="page-title" id="pageTitle">Dashboard</h2>
                </div>
                <div class="user-info">
                    <i class="fas fa-user-circle"></i>
                    <span>Sistema Inmobiliario AJHB</span>
                </div>
            </header>

            <!-- Dashboard -->
            <div id="dashboard" class="content-section active">
                <div class="dashboard-content">
                    <!-- Estadísticas -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon success">
                                    <i class="fas fa-building"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="totalProperties">0</div>
                            <div class="stat-label">Total Propiedades</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon primary">
                                    <i class="fas fa-users"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="totalClients">0</div>
                            <div class="stat-label">Total Clientes</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon warning">
                                    <i class="fas fa-handshake"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="totalSales">0</div>
                            <div class="stat-label">Ventas Realizadas</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon accent">
                                    <i class="fas fa-coins"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="totalRevenue">₡0</div>
                            <div class="stat-label">Ingresos Totales</div>
                        </div>
                    </div>

                    <!-- Gráfico de Ventas / Tendencias -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">📈 Tendencias de Ventas</h3>
                        </div>
                        <div class="card-body">
                            <div id="salesTrendsContainer">
                                <div class="chart-container">
                                    <!-- El gráfico SVG se creará dinámicamente aquí -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Estadísticas Detalladas de Propiedades -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">📊 Detalles por Estado</h3>
                        </div>
                        <div class="card-body">
                            <div class="stats-grid" id="propertiesDetailedStats">
                                <!-- Se llenará dinámicamente -->
                            </div>
                        </div>
                    </div>

                    <!-- Sistema de Metas Mensuales -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">🎯 Meta Mensual de Comisiones</h3>
                        </div>
                        <div class="card-body">
                            <div id="monthlyGoalContainer">
                                <!-- Se llenará dinámicamente -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Propiedades -->
            <div id="properties" class="content-section">
                <div class="dashboard-content">
                    <div class="flex items-center justify-between section-header">
                        <h2>Gestión de Propiedades</h2>
                        <button type="button" class="btn btn-success" onclick="showAddPropertyModal()">
                            <i class="fas fa-plus"></i> Nueva Propiedad
                        </button>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <div class="table-container">
                                <table class="table" id="propertiesTable">
                                    <thead>
                                        <tr>
                                            <th>Tipo</th>
                                            <th>Operación</th>
                                            <th>Ubicación</th>
                                            <th>Precio</th>
                                            <th>Área (m²)</th>
                                            <th class="text-center-th">Habit.</th>
                                            <th class="text-center-th">Baños</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="9">
                                                <div class="empty-state">
                                                    <i class="fas fa-home"></i>
                                                    <h3>No hay propiedades registradas</h3>
                                                    <p>Agrega tu primera propiedad para comenzar</p>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Clientes -->
            <div id="clients" class="content-section">
                <div class="dashboard-content">
                    <div class="flex items-center justify-between section-header">
                        <h2>Gestión de Clientes</h2>
                        <button type="button" class="btn btn-success" onclick="showAddClientModal()">
                            <i class="fas fa-plus"></i> Nuevo Cliente
                        </button>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <div class="table-container">
                                <table class="table" id="clientsTable">
                                    <thead>
                                        <tr>
                                            <th>Nombre</th>
                                            <th>Email</th>
                                            <th>Teléfono</th>
                                            <th>Interés</th>
                                            <th>Presupuesto</th>
                                            <th>Fecha</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="7">
                                                <div class="empty-state">
                                                    <i class="fas fa-users"></i>
                                                    <h3>No hay clientes registrados</h3>
                                                    <p>Agrega tu primer cliente para comenzar</p>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contratos -->
            <div id="contracts" class="content-section">
                <div class="dashboard-content">
                    <div class="flex items-center justify-between section-header">
                        <h2>Gestión de Contratos</h2>
                        <button type="button" class="btn btn-success" onclick="showAddContractModal()">
                            <i class="fas fa-plus"></i> Nuevo Contrato
                        </button>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <div class="table-container">
                                <table class="table" id="contractsTable">
                                    <thead>
                                        <tr>
                                            <th>Propiedad</th>
                                            <th>Cliente</th>
                                            <th>Tipo</th>
                                            <th>Valor</th>
                                            <th>Estado</th>
                                            <th>Fecha</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="7">
                                                <div class="empty-state">
                                                    <i class="fas fa-file-contract"></i>
                                                    <h3>No hay contratos registrados</h3>
                                                    <p>Crea tu primer contrato para comenzar</p>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reportes -->
            <div id="reports" class="content-section">
                <div class="dashboard-content">
                    <div class="section-header">
                        <h2 class="section-title">Reportes y Análisis Avanzado</h2>
                        <div class="flex gap-4">
                            <select id="reportPeriod" class="form-select auto-width-select" onchange="crm.updateReportPeriod(this.value)">
                                <option value="month">Este Mes</option>
                                <option value="quarter">Este Trimestre</option>
                                <option value="year">Este Año</option>
                                <option value="all">Todo el Período</option>
                            </select>
                            <button type="button" class="btn btn-primary" onclick="crm.exportReport()">
                                <i class="fas fa-download"></i> Exportar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Métricas Principales -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon success">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <span class="badge" id="growthBadge">+0%</span>
                            </div>
                            <div class="stat-value" id="reportsTotalRevenue">₡0</div>
                            <div class="stat-label">Ingresos Totales</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon primary">
                                    <i class="fas fa-home"></i>
                                </div>
                                <span class="badge" id="conversionBadge">0%</span>
                            </div>
                            <div class="stat-value" id="reportsTotalSales">0</div>
                            <div class="stat-label">Propiedades Vendidas</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon warning">
                                    <i class="fas fa-users"></i>
                                </div>
                                <span class="badge" id="clientGrowthBadge">+0</span>
                            </div>
                            <div class="stat-value" id="activeClients">0</div>
                            <div class="stat-label">Clientes Activos</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon accent stat-icon-accent-color">
                                    <i class="fas fa-calendar-check"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="avgDealTime">0</div>
                            <div class="stat-label">Días Promedio por Venta</div>
                        </div>
                    </div>

                    <!-- Gráficos y Análisis -->
                    <div class="revenue-chart-grid">
                        <!-- Gráfico de Ingresos -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Tendencia de Ingresos</h3>
                                <select id="revenueChartType" class="form-select auto-width-select" onchange="crm.updateRevenueChart(this.value)">
                                    <option value="monthly">Por Mes</option>
                                    <option value="quarterly">Por Trimestre</option>
                                    <option value="yearly">Por Año</option>
                                </select>
                            </div>
                            <div class="card-body">
                                <div id="revenueChartContainer" class="chart-container"></div>
                            </div>
                        </div>

                        <!-- Top Clientes -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Top Clientes</h3>
                            </div>
                            <div class="card-body">
                                <div id="topClientsContainer">
                                    <div class="empty-state">
                                        <i class="fas fa-user-tie"></i>
                                        <h4>Analizando clientes...</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="property-charts-grid">
                        <!-- Propiedades por Tipo -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Análisis por Tipo de Propiedad</h3>
                            </div>
                            <div class="card-body">
                                <div id="propertyTypeChartContainer" class="chart-container chart-container-300"></div>
                            </div>
                        </div>

                        <!-- Estados de Propiedades -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Estado del Inventario</h3>
                            </div>
                            <div class="card-body">
                                <div id="propertyStatusContainer">
                                    <div class="empty-state">
                                        <i class="fas fa-chart-pie"></i>
                                        <h4>Analizando inventario...</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla de Análisis Detallado -->
                    <div class="card card-spaced">
                        <div class="card-header">
                            <h3 class="card-title">Análisis Detallado de Ventas</h3>
                            <button type="button" class="btn btn-sm btn-primary" onclick="crm.refreshDetailedAnalysis()">
                                <i class="fas fa-sync"></i> Actualizar
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Período</th>
                                            <th>Propiedades Vendidas</th>
                                            <th>Ingresos</th>
                                            <th>Precio Promedio</th>
                                            <th>Margen</th>
                                            <th>Conversión</th>
                                        </tr>
                                    </thead>
                                    <tbody id="detailedAnalysisTable">
                                        <tr>
                                            <td colspan="6" class="text-center empty-table-cell-padding">
                                                <i class="fas fa-spinner fa-spin"></i> Cargando análisis...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- KPIs Adicionales -->
                    <div class="card card-spaced">
                        <div class="card-header">
                            <h3 class="card-title">Indicadores Clave de Rendimiento (KPIs)</h3>
                        </div>
                        <div class="card-body">
                            <div class="detailed-stats-grid">
                                <div class="stat-summary">
                                    <div class="stat-icon primary">
                                        <i class="fas fa-percentage"></i>
                                    </div>
                                    <div class="stat-value" id="closingRate">0%</div>
                                    <div class="stat-label">Tasa de Cierre</div>
                                </div>

                                <div class="stat-summary">
                                    <div class="stat-icon success">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                    <div class="stat-value" id="avgResponseTime">0h</div>
                                    <div class="stat-label">Tiempo Respuesta Prom.</div>
                                </div>

                                <div class="stat-summary">
                                    <div class="stat-icon warning">
                                        <i class="fas fa-trophy"></i>
                                    </div>
                                    <div class="stat-value" id="bestMonth">N/A</div>
                                    <div class="stat-label">Mejor Mes</div>
                                </div>

                                <div class="stat-summary">
                                    <div class="stat-icon accent stat-icon-accent-bg">
                                        <i class="fas fa-target"></i>
                                    </div>
                                    <div class="stat-value" id="monthlyGoal">0%</div>
                                    <div class="stat-label">Meta Mensual</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Clientes Potenciales -->
            <div id="prospects" class="content-section">
                <div class="dashboard-content">
                    <div class="flex items-center justify-between section-header">
                        <h2>Clientes Potenciales</h2>
                        <button type="button" class="btn btn-success" onclick="showAddProspectModal()">
                            <i class="fas fa-plus"></i> Nuevo Prospecto
                        </button>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Lista de Prospectos</h3>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="table" id="prospectsTable">
                                    <thead>
                                        <tr>
                                            <th>Nombre</th>
                                            <th>Email</th>
                                            <th>Teléfono</th>
                                            <th>Fuente</th>
                                            <th>Estado</th>
                                            <th>Fecha Contacto</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Se llenará dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendario -->
            <div id="calendar" class="content-section">
                <div class="dashboard-content">
                    <div class="flex items-center justify-between section-header">
                        <h2>Calendario y Citas</h2>
                        <button type="button" class="btn btn-success" onclick="showAddAppointmentModal()">
                            <i class="fas fa-plus"></i> Nueva Cita
                        </button>
                    </div>

                    <div class="stats-grid calendar-layout">
                        <!-- Calendario Principal -->
                        <div class="card">
                            <div class="card-header">
                                <div class="flex items-center justify-between">
                                    <h3 class="card-title" id="calendarTitle">Calendario</h3>
                                    <div class="flex items-center gap-4">
                                        <!-- Controles de navegación -->
                                        <button type="button" class="btn btn-primary btn-sm" onclick="crm.changeMonth(-1)">
                                            <i class="fas fa-chevron-left"></i>
                                        </button>
                                        <button type="button" class="btn btn-primary btn-sm" onclick="crm.goToToday()">Hoy</button>
                                        <button type="button" class="btn btn-primary btn-sm" onclick="crm.changeMonth(1)">
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Filtros del calendario -->
                                <div class="calendar-filters">
                                    <div class="flex items-center gap-4">
                                        <div class="filter-group">
                                            <label class="form-label calendar-filters">Filtrar por tipo:</label>
                                            <select class="form-select auto-width-select" id="appointmentTypeFilter" onchange="crm.filterAppointmentsByType(this.value)">
                                                <option value="">Todos los tipos</option>
                                                <option value="Venta">🏠 Ventas</option>
                                                <option value="Compra">💰 Compras</option>
                                                <option value="Arriendo">📅 Arriendos</option>
                                                <option value="Visita">👀 Visitas</option>
                                                <option value="Reunion">🤝 Reuniones</option>
                                                <option value="Llamada">📞 Llamadas</option>
                                                <option value="Firma">✒️ Firmas</option>
                                                <option value="Consulta">💬 Consultas</option>
                                            </select>
                                        </div>
                                        
                                        <div class="filter-group">
                                            <label class="form-label calendar-filters">Vista:</label>
                                            <select class="form-select auto-width-select" id="calendarView" onchange="crm.changeCalendarView(this.value)">
                                                <option value="month">Mes</option>
                                                <option value="week">Semana</option>
                                                <option value="agenda">Agenda</option>
                                            </select>
                                        </div>
                                        
                                        <div class="filter-group">
                                            <button type="button" class="btn btn-sm btn-export-calendar" onclick="crm.exportCalendar()">
                                                <i class="fas fa-download"></i> Exportar
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Leyenda de colores -->
                                    <div class="color-legend">
                                        <div class="flex items-center gap-4 color-legend-container">
                                            <span class="color-legend-text">Tipos:</span>
                                            <div class="color-legend-item">
                                                <span class="color-legend-dot color-legend-dot-venta"></span>
                                                <span class="color-legend-label">Ventas</span>
                                            </div>
                                            <div class="color-legend-item">
                                                <span class="color-legend-dot color-legend-dot-compra"></span>
                                                <span class="color-legend-label">Compras</span>
                                            </div>
                                            <div class="color-legend-item">
                                                <span class="color-legend-dot color-legend-dot-arriendo"></span>
                                                <span class="color-legend-label">Arriendos</span>
                                            </div>
                                            <div class="color-legend-item">
                                                <span class="color-legend-dot color-legend-dot-visita"></span>
                                                <span class="color-legend-label">Visitas</span>
                                            </div>
                                            <div class="color-legend-item">
                                                <span class="color-legend-dot color-legend-dot-otros"></span>
                                                <span class="color-legend-label">Otros</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="calendarGrid" class="calendar-grid">
                                    <!-- Se llenará dinámicamente -->
                                </div>
                            </div>
                        </div>

                        <!-- Panel de Citas del Día -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Citas de Hoy</h3>
                            </div>
                            <div class="card-body">
                                <div id="todayAppointments">
                                    <!-- Se llenará dinámicamente -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de Todas las Citas -->
                    <div class="card card-spaced">
                        <div class="card-header">
                            <h3 class="card-title">Todas las Citas</h3>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="table" id="appointmentsTable">
                                    <thead>
                                        <tr>
                                            <th>Fecha y Hora</th>
                                            <th>Cliente</th>
                                            <th>Propiedad</th>
                                            <th>Tipo</th>
                                            <th>Estado</th>
                                            <th>Recordatorio</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Se llenará dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Container de notificaciones -->
    <div id="notificationsContainer" class="notifications-container"></div>

    <!-- Modal de Confirmación de Eliminación -->
    <div id="confirmationModal" class="confirmation-modal">
        <div class="confirmation-dialog">
            <div class="confirmation-header">
                <div class="icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="content">
                    <h3 id="confirmationTitle">Confirmar Eliminación</h3>
                    <p id="confirmationSubtitle">Esta acción no se puede deshacer</p>
                </div>
            </div>
            <div class="confirmation-body">
                <div id="confirmationDetails" class="item-details">
                    <!-- Los detalles del elemento se llenarán dinámicamente -->
                </div>
                <div class="warning-message">
                    <div class="icon">
                        <i class="fas fa-exclamation"></i>
                    </div>
                    <div>
                        <strong>¡Atención!</strong> Esta acción eliminará permanentemente este elemento del sistema.
                    </div>
                </div>
                <div class="confirmation-actions">
                    <button type="button" class="btn btn-cancel" onclick="crm.closeConfirmationModal()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-confirm-delete" id="confirmDeleteBtn">
                        <i class="fas fa-trash-alt"></i> Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modales -->
    <!-- Modal Agregar Propiedad -->
    <div class="modal-overlay" id="propertyModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Agregar Nueva Propiedad</h3>
                <button type="button" class="modal-close" onclick="closeModal('propertyModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="propertyForm">
                    <div class="form-group">
                        <label class="form-label">Tipo de Propiedad</label>
                        <select class="form-select" id="propertyType" required>
                            <option value="">Seleccionar tipo</option>
                            <option value="Casa">Casa</option>
                            <option value="Departamento">Departamento</option>
                            <option value="Terreno">Terreno</option>
                            <option value="Local Comercial">Local Comercial</option>
                            <option value="Oficina">Oficina</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Tipo de Operación</label>
                        <select class="form-select" id="propertyOperation" required>
                            <option value="">Seleccionar operación</option>
                            <option value="venta">Venta (Comisión 7%)</option>
                            <option value="compra">Compra para Cartelera (Comisión 3%)</option>
                            <option value="arriendo">Arriendo por Día/Eventos</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Ubicación</label>
                        <input type="text" class="form-input" id="propertyAddress" placeholder="Dirección completa" required>
                    </div>

                    <div class="form-grid-2">
                        <div class="form-group">
                            <label class="form-label">Habitaciones</label>
                            <input type="number" class="form-input" id="propertyBedrooms" placeholder="0" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Baños</label>
                            <input type="number" class="form-input" id="propertyBathrooms" placeholder="0" min="0">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Precio (₡)</label>
                        <input type="number" class="form-input" id="propertyPrice" placeholder="50000000" min="1" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Área (m²)</label>
                        <input type="number" class="form-input" id="propertyArea" placeholder="0" min="1" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Estado</label>
                        <select class="form-select" id="propertyStatus" required>
                            <option value="disponible">🟢 Disponible</option>
                            <option value="en-proceso">🟡 En Proceso</option>
                            <option value="reservada">🟠 Reservada</option>
                            <option value="vendida">🔴 Vendida</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Descripción</label>
                        <textarea class="form-textarea" id="propertyDescription" placeholder="Descripción opcional"></textarea>
                    </div>
                    
                    <div class="flex gap-4">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('propertyModal')">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Agregar Cliente -->
    <div class="modal-overlay" id="clientModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Agregar Nuevo Cliente</h3>
                <button class="modal-close" onclick="closeModal('clientModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="clientForm">
                    <div class="form-group">
                        <label class="form-label">Nombre Completo</label>
                        <input type="text" class="form-input" id="clientName" placeholder="Nombre completo" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="clientEmail" placeholder="email@ejemplo.com" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Teléfono</label>
                        <input type="tel" class="form-input" id="clientPhone" placeholder="+1234567890" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Tipo de Propiedad de Interés</label>
                        <select class="form-select" id="clientInterest" required>
                            <option value="">Seleccionar tipo</option>
                            <option value="Casa">Casa</option>
                            <option value="Departamento">Departamento</option>
                            <option value="Terreno">Terreno</option>
                            <option value="Local Comercial">Local Comercial</option>
                            <option value="Oficina">Oficina</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Presupuesto Máximo (₡)</label>
                        <input type="number" class="form-input" id="clientBudget" placeholder="30000000" min="1" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Notas Adicionales</label>
                        <textarea class="form-textarea" id="clientNotes" placeholder="Información adicional sobre el cliente"></textarea>
                    </div>
                    
                    <div class="flex gap-4">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('clientModal')">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Agregar Contrato -->
    <div class="modal-overlay" id="contractModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Crear Nuevo Contrato</h3>
                <button class="modal-close" onclick="closeModal('contractModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="contractForm">
                    <div class="form-group">
                        <label class="form-label">Propiedad</label>
                        <select class="form-select" id="contractProperty" required>
                            <option value="">Seleccionar propiedad</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Cliente</label>
                        <select class="form-select" id="contractClient" required>
                            <option value="">Seleccionar cliente</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Tipo de Contrato</label>
                        <select class="form-select" id="contractType" required>
                            <option value="">Seleccionar tipo</option>
                            <option value="Compraventa">Compraventa</option>
                            <option value="Arrendamiento">Arrendamiento</option>
                            <option value="Opción de Compra">Opción de Compra</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Valor del Contrato (₡)</label>
                        <input type="number" class="form-input" id="contractValue" placeholder="40000000" min="1" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Fecha del Contrato</label>
                        <input type="date" class="form-input" id="contractDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Términos del Contrato</label>
                        <textarea class="form-textarea" id="contractTerms" placeholder="Detalles adicionales del contrato..."></textarea>
                    </div>
                    
                    <div class="flex gap-4">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('contractModal')">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Crear
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Agregar Prospecto -->
    <div class="modal-overlay" id="prospectModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Agregar Nuevo Prospecto</h3>
                <button class="modal-close" onclick="closeModal('prospectModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="prospectForm">
                    <div class="form-group">
                        <label class="form-label">Nombre Completo</label>
                        <input type="text" class="form-input" id="prospectName" placeholder="Nombre del prospecto" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="prospectEmail" placeholder="email@ejemplo.com" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Teléfono</label>
                        <input type="tel" class="form-input" id="prospectPhone" placeholder="+1234567890" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Fuente de Contacto</label>
                        <select class="form-select" id="prospectSource" required>
                            <option value="">Seleccionar fuente</option>
                            <option value="Referido">Referido</option>
                            <option value="Redes Sociales">Redes Sociales</option>
                            <option value="Web">Sitio Web</option>
                            <option value="Publicidad">Publicidad</option>
                            <option value="Evento">Evento</option>
                            <option value="Llamada">Llamada Fría</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Estado</label>
                        <select class="form-select" id="prospectStatus" required>
                            <option value="Nuevo">Nuevo</option>
                            <option value="Contactado">Contactado</option>
                            <option value="Interesado">Interesado</option>
                            <option value="Cita Programada">Cita Programada</option>
                            <option value="Seguimiento">Seguimiento</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Notas</label>
                        <textarea class="form-textarea" id="prospectNotes" placeholder="Notas sobre el prospecto..."></textarea>
                    </div>
                    
                    <div class="flex gap-4">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('prospectModal')">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Agregar Cita -->
    <div class="modal-overlay" id="appointmentModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Programar Nueva Cita</h3>
                <button class="modal-close" onclick="closeModal('appointmentModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="appointmentForm">
                    <div class="form-group">
                        <label class="form-label">Título de la Cita</label>
                        <input type="text" class="form-input" id="appointmentTitle" placeholder="Visita a propiedad, reunión, etc." required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Cliente (Opcional)</label>
                        <select class="form-select" id="appointmentClient">
                            <option value="">Cita general - sin cliente específico</option>
                            <!-- Se llenará dinámicamente -->
                        </select>
                        <small class="form-help">Puedes programar una cita sin asignar un cliente específico</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Propiedad (Opcional)</label>
                        <select class="form-select" id="appointmentProperty">
                            <option value="">Seleccionar propiedad</option>
                            <!-- Se llenará dinámicamente -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Fecha</label>
                        <input type="date" class="form-input" id="appointmentDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Hora</label>
                        <input type="time" class="form-input" id="appointmentTime" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Tipo de Cita</label>
                        <select class="form-select" id="appointmentType" required>
                            <option value="Venta">🏠 Presentación de Venta</option>
                            <option value="Compra">💰 Evaluación de Compra</option>
                            <option value="Arriendo">📅 Consulta de Arriendo</option>
                            <option value="Visita">👀 Visita a Propiedad</option>
                            <option value="Reunion">🤝 Reunión de Negocios</option>
                            <option value="Llamada">📞 Llamada de Seguimiento</option>
                            <option value="Firma">✒️ Firma de Contrato</option>
                            <option value="Consulta">💬 Consulta General</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Recordatorio</label>
                        <select class="form-select" id="appointmentReminder">
                            <option value="5">5 minutos antes</option>
                            <option value="15">15 minutos antes</option>
                            <option value="30" selected>30 minutos antes</option>
                            <option value="60">1 hora antes</option>
                            <option value="120">2 horas antes</option>
                            <option value="1440">1 día antes</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Descripción</label>
                        <textarea class="form-textarea" id="appointmentDescription" placeholder="Detalles adicionales sobre la cita..."></textarea>
                    </div>
                    
                    <div class="flex gap-4">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('appointmentModal')">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-calendar-plus"></i> Programar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ===== CONFIGURACIÓN GLOBAL =====
        class CRMSystem {
            constructor() {
                console.log('🚀 Creando instancia CRM...');
                this.db = null;
                this.charts = {};
                this.currentSection = 'dashboard';
                this.isMobile = window.innerWidth <= 768;
                this.currentDate = new Date();
                this.selectedDate = new Date();
                this.appointments = [];
                
                // Inicializar sistema de sesión mejorado
                this.initSessionManager();
                
                // Inicializar sistema de roles
                this.initRoleManager();
                
                // Inicializar efectos visuales
                this.initVisualEffects();
                
                // Continuar con inicialización normal
                
                // Variables para almacenar datos actuales
                this.currentProperties = [];
                this.currentContracts = [];
                this.currentClients = [];
                
                // Variables de estado
                this.editingAppointmentId = null;
                this.goalAchievedThisMonth = false;
                
                // Banderas para prevenir envíos múltiples
                this.isSubmitting = false;
                this.isSubmittingClient = false;
                this.isSubmittingContract = false;
                
                // Control de event listeners para evitar duplicaciones
                this.listenersConfigured = false;
                this._modalClicksConfigured = false;
                this._notificationRequested = false;
                this._contractAutoFillConfigured = false;
                this._propertySubmitHandler = null;
                this._clientSubmitHandler = null;
                this._contractSubmitHandler = null;
                this._prospectSubmitHandler = null;
                this._appointmentSubmitHandler = null;
                this._resizeHandler = null;
                
                // Inicializar de forma asíncrona
                setTimeout(() => this.init(), 100);
            }

            // ===== SISTEMA DE GESTIÓN DE SESIÓN MEJORADO =====
            initSessionManager() {
                this.sessionConfig = {
                    extendedTime: 2 * 60 * 1000, // 2 minutos después de cerrar pestaña
                    maxRefreshes: 30, // 30 refreshes antes de logout
                    warningTime: 30 * 1000 // Avisar 30 segundos antes
                };

                // Inicializar contadores de sesión
                if (!sessionStorage.getItem('vsystems_refresh_count')) {
                    sessionStorage.setItem('vsystems_refresh_count', '0');
                }
                
                // Incrementar contador en cada carga
                const currentCount = parseInt(sessionStorage.getItem('vsystems_refresh_count') || '0');
                sessionStorage.setItem('vsystems_refresh_count', (currentCount + 1).toString());

                this.checkSessionValidity();
                this.setupSessionMonitoring();
            }

            checkSessionValidity() {
                const isAuthenticated = sessionStorage.getItem('vsystems_authenticated');
                const authToken = sessionStorage.getItem('vsystems_token');
                const authTime = sessionStorage.getItem('vsystems_auth_time');
                const refreshCount = parseInt(sessionStorage.getItem('vsystems_refresh_count') || '0');

                if (!isAuthenticated || !authToken || !authTime) {
                    this.redirectToLogin();
                    return false;
                }

                // Verificar límite de refreshes
                if (refreshCount >= this.sessionConfig.maxRefreshes) {
                    console.log('🔐 Límite de refreshes alcanzado, cerrando sesión...');
                    this.showNotification(
                        `Límite de ${this.sessionConfig.maxRefreshes} recargas alcanzado por seguridad. Cerrando sesión...`,
                        'warning',
                        3000
                    );
                    setTimeout(() => this.logout(), 3000);
                    return false;
                }

                // Advertir cuando se acerque al límite
                if (refreshCount >= this.sessionConfig.maxRefreshes - 5) {
                    const remaining = this.sessionConfig.maxRefreshes - refreshCount;
                    this.showNotification(
                        `Quedan ${remaining} recargas antes del logout automático`,
                        'info',
                        2000
                    );
                }

                return true;
            }

            setupSessionMonitoring() {
                // Extender sesión cuando la pestaña se cierra/minimiza
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        // Usuario salió - extender sesión por 2 minutos
                        const extendedTime = Date.now() + this.sessionConfig.extendedTime;
                        localStorage.setItem('vsystems_extended_until', extendedTime.toString());
                        console.log('👋 Usuario salió, sesión extendida por 2 minutos');
                    } else {
                        // Usuario regresó - validar extensión
                        this.validateExtendedSession();
                    }
                });

                // Verificar extensión cada 30 segundos
                setInterval(() => {
                    this.checkExtendedSession();
                }, 30000);
            }

            validateExtendedSession() {
                const extendedUntil = localStorage.getItem('vsystems_extended_until');
                if (extendedUntil) {
                    const now = Date.now();
                    if (now > parseInt(extendedUntil)) {
                        localStorage.removeItem('vsystems_extended_until');
                        this.showNotification('Tiempo de sesión extendida expirado', 'info');
                    } else {
                        console.log('✅ Usuario regresó dentro del tiempo de gracia');
                    }
                }
            }

            checkExtendedSession() {
                const extendedUntil = localStorage.getItem('vsystems_extended_until');
                if (extendedUntil) {
                    const now = Date.now();
                    const timeLeft = parseInt(extendedUntil) - now;
                    
                    if (timeLeft <= 0) {
                        localStorage.removeItem('vsystems_extended_until');
                        if (document.hidden) {
                            console.log('⏰ Sesión extendida expirada, usuario aún ausente');
                            this.logout();
                        }
                    } else if (timeLeft <= this.sessionConfig.warningTime && !document.hidden) {
                        // Mostrar advertencia solo si el usuario está presente
                        this.showNotification(
                            `Sesión expirará en ${Math.ceil(timeLeft / 1000)} segundos por inactividad`,
                            'warning'
                        );
                    }
                }
            }

            logout() {
                // Limpiar toda la información de sesión
                sessionStorage.clear();
                localStorage.removeItem('vsystems_extended_until');
                
                // Mostrar mensaje de logout
                this.showNotification('Sesión cerrada por seguridad', 'info', 2000);
                
                // Redirigir después del mensaje
                setTimeout(() => {
                    this.redirectToLogin();
                }, 2000);
            }

            redirectToLogin() {
                window.location.href = 'Login2.html';
            }

            // ===== SISTEMA DE ROLES =====
            initRoleManager() {
                // Definir roles y permisos basados en los usuarios de Login2.html (usando nombres reales)
                this.roles = {
                    'GerenteTIMontana@ajhb.com': {
                        name: 'Montana',
                        role: 'Gerente TI',
                        level: 'admin',
                        color: '#ff6b35',
                        permissions: ['dashboard', 'properties', 'clients', 'contracts', 'reports', 'settings', 'calendar'],
                        features: ['advanced_analytics', 'user_management', 'system_config']
                    },
                    'DirectorEjecutivoHidalgo@ajhb.com': {
                        name: 'Hidalgo',
                        role: 'Director Ejecutivo',
                        level: 'executive',
                        color: '#7b68ee',
                        permissions: ['dashboard', 'properties', 'clients', 'contracts', 'reports', 'calendar'],
                        features: ['executive_reports', 'strategic_analytics']
                    },
                    'VargasGerenteVentas34@ajhb.com': {
                        name: 'Vargas',
                        role: 'Gerente de Ventas',
                        level: 'manager',
                        color: '#20bf6b',
                        permissions: ['dashboard', 'properties', 'clients', 'contracts', 'reports', 'calendar'],
                        features: ['sales_analytics', 'team_management']
                    },
                    'ArreondoAsesor054@ajhb.com': {
                        name: 'Arreondo',
                        role: 'Asesor',
                        level: 'advisor',
                        color: '#fd9644',
                        permissions: ['dashboard', 'properties', 'clients', 'contracts', 'calendar'],
                        features: ['client_management', 'contract_creation']
                    },
                    'AsistenciaGeneral@ajhb.com': {
                        name: 'Asistencia General',
                        role: 'Asistente General',
                        level: 'assistant',
                        color: '#a55eea',
                        permissions: ['dashboard', 'clients', 'calendar'],
                        features: ['appointment_management', 'client_support']
                    },
                    'AsesorMontoya00@ajhb.com': {
                        name: 'Montoya',
                        role: 'Asesor',
                        level: 'advisor',
                        color: '#26de81',
                        permissions: ['dashboard', 'properties', 'clients', 'calendar'],
                        features: ['property_showcase', 'client_tours']
                    },
                    'AsesorGorge098@ajhb.com': {
                        name: 'Jorge',
                        role: 'Asesor',
                        level: 'advisor',
                        color: '#2bcbba',
                        permissions: ['dashboard', 'properties', 'clients', 'calendar'],
                        features: ['property_showcase', 'client_tours']
                    },
                    'AsesorYasser087@ajhb.com': {
                        name: 'Yasser',
                        role: 'Asesor',
                        level: 'advisor',
                        color: '#45aaf2',
                        permissions: ['dashboard', 'properties', 'clients', 'calendar'],
                        features: ['property_showcase', 'client_tours']
                    }
                };

                // Obtener usuario actual de la sesión
                this.currentUser = sessionStorage.getItem('vsystems_user');
                this.userName = sessionStorage.getItem('vsystems_user_name');
                this.userRoleName = sessionStorage.getItem('vsystems_user_role');
                
                this.userRole = this.roles[this.currentUser] || {
                    name: this.userName || 'Usuario Desconocido',
                    role: this.userRoleName || 'Invitado',
                    level: 'guest',
                    color: '#95a5a6',
                    permissions: ['dashboard'],
                    features: []
                };

                // Aplicar personalización de interfaz
                this.customizeInterfaceForRole();
                
                // Mostrar información del usuario
                this.displayUserInfo();

                console.log('🎭 Usuario identificado:', this.userRole.name, '-', this.userRole.role);
            }

            customizeInterfaceForRole() {
                // Personalizar sidebar basado en permisos
                const sidebarItems = document.querySelectorAll('.sidebar-item');
                sidebarItems.forEach(item => {
                    const section = item.getAttribute('data-section');
                    if (section && !this.userRole.permissions.includes(section)) {
                        item.style.display = 'none';
                    }
                });

                // Agregar indicador visual del rol
                const header = document.querySelector('.header');
                if (header) {
                    const roleIndicator = document.createElement('div');
                    roleIndicator.className = 'user-role-indicator';
                    roleIndicator.innerHTML = `
                        <div class="role-badge" style="background: ${this.userRole.color}">
                            <i class="fas fa-user"></i>
                            <span>${this.userRole.role}</span>
                        </div>
                    `;
                    roleIndicator.style.cssText = `
                        position: absolute;
                        top: 15px;
                        right: 120px;
                        z-index: 1000;
                    `;
                    header.appendChild(roleIndicator);
                }
            }

            displayUserInfo() {
                // Mostrar notificación de bienvenida personalizada
                const welcomeMessage = this.getWelcomeMessage();
                this.showNotification(welcomeMessage, 'success', 4000);

                // Actualizar título de dashboard si existe
                const dashboardTitle = document.querySelector('.page-title');
                if (dashboardTitle) {
                    dashboardTitle.innerHTML = `
                        <i class="fas fa-tachometer-alt"></i>
                        Dashboard - ${this.userRole.name}
                        <span class="role-subtitle">${this.userRole.role}</span>
                    `;
                }

                // Mostrar información detallada del usuario en consola
                this.logUserDetails();
            }

            logUserDetails() {
                console.group('👤 Información del Usuario Autenticado');
                console.log('📧 Email:', this.currentUser);
                console.log('👨‍💼 Nombre:', this.userRole.name);
                console.log('🏷️ Rol:', this.userRole.role);
                console.log('⭐ Nivel:', this.userRole.level);
                console.log('🎨 Color:', this.userRole.color);
                console.log('🔑 Permisos:', this.userRole.permissions.join(', '));
                console.log('⚡ Características especiales:', this.userRole.features.join(', '));
                console.groupEnd();
                
                // Mostrar información en la interfaz si es un rol admin
                if (this.userRole.level === 'admin') {
                    this.showAdminInfo();
                }
            }

            showAdminInfo() {
                // Solo para administradores - mostrar información del sistema
                setTimeout(() => {
                    this.showNotification(
                        '🔧 Acceso administrativo activado. Panel completo disponible.',
                        'info',
                        3000
                    );
                }, 5000);
            }

            getWelcomeMessage() {
                const messages = {
                    'admin': `¡Bienvenido ${this.userRole.name}! Acceso completo al sistema como ${this.userRole.role}`,
                    'executive': `¡Bienvenido ${this.userRole.name}! Panel ejecutivo disponible`,
                    'manager': `¡Bienvenido ${this.userRole.name}! Gestión de ventas activada`,
                    'senior': `¡Bienvenido ${this.userRole.name}! Herramientas de asesor senior disponibles`,
                    'assistant': `¡Bienvenida ${this.userRole.name}! Panel de asistencia activado`,
                    'advisor': `¡Bienvenido ${this.userRole.name}! Herramientas de asesoría inmobiliaria disponibles`
                };
                return messages[this.userRole.level] || `¡Bienvenido ${this.userRole.name}!`;
            }

            // Función para verificar permisos
            hasPermission(permission) {
                return this.userRole.permissions.includes(permission);
            }

            // Función para verificar características especiales
            hasFeature(feature) {
                return this.userRole.features.includes(feature);
            }

            // ===== EFECTOS VISUALES =====
            initVisualEffects() {
                // Agregar animaciones de entrada a las secciones
                this.addEntranceAnimations();
                
                // Mejorar transiciones entre secciones
                this.enhanceTransitions();
                
                // Configurar notificaciones mejoradas
                this.setupNotifications();

                // Inicializar tooltips
                this.initTooltips();
            }

            addEntranceAnimations() {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('animate');
                            entry.target.style.animationDelay = Math.random() * 0.3 + 's';
                        }
                    });
                }, { threshold: 0.1 });

                // Observar elementos que necesitan animación
                setTimeout(() => {
                    document.querySelectorAll('.card, .metric-card, .appointment-item, .property-card').forEach(el => {
                        if (!el.classList.contains('fade-in')) {
                            el.classList.add('fade-in');
                            observer.observe(el);
                        }
                    });
                }, 100);
            }

            enhanceTransitions() {
                // Mejorar cambios de vista con transiciones suaves
                const originalShowSection = this.showSection;
                this.showSection = (sectionName) => {
                    // Fade out current section
                    const currentSection = document.querySelector('.content-section:not([style*="display: none"])');
                    if (currentSection) {
                        currentSection.style.opacity = '0.7';
                        currentSection.style.transform = 'translateY(10px)';
                        
                        setTimeout(() => {
                            originalShowSection.call(this, sectionName);
                            
                            // Fade in new section
                            const newSection = document.querySelector('.content-section:not([style*="display: none"])');
                            if (newSection) {
                                newSection.style.opacity = '0';
                                newSection.style.transform = 'translateY(20px)';
                                
                                setTimeout(() => {
                                    newSection.style.opacity = '1';
                                    newSection.style.transform = 'translateY(0)';
                                    
                                    // Re-animar elementos de la nueva sección
                                    newSection.querySelectorAll('.fade-in').forEach((el, index) => {
                                        setTimeout(() => {
                                            el.classList.add('animate');
                                        }, index * 50);
                                    });
                                }, 50);
                            }
                        }, 150);
                    } else {
                        originalShowSection.call(this, sectionName);
                    }
                };
            }

            setupNotifications() {
                // Sistema de notificaciones mejorado
                this.showNotification = (message, type = 'info', duration = 4000) => {
                    const notification = document.createElement('div');
                    notification.className = `notification ${type}`;
                    notification.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <div style="font-size: 1.25rem;">
                                ${type === 'success' ? '✅' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️'}
                            </div>
                            <div>
                                <div style="font-weight: 600; margin-bottom: 0.25rem;">
                                    ${type === 'success' ? 'Éxito' : type === 'error' ? 'Error' : type === 'warning' ? 'Advertencia' : 'Información'}
                                </div>
                                <div style="color: var(--text-secondary); font-size: 0.875rem;">${message}</div>
                            </div>
                        </div>
                    `;

                    document.body.appendChild(notification);
                    
                    setTimeout(() => notification.classList.add('show'), 100);
                    
                    setTimeout(() => {
                        notification.classList.remove('show');
                        setTimeout(() => notification.remove(), 300);
                    }, duration);
                };
            }

            initTooltips() {
                // Sistema de tooltips mejorado
                setTimeout(() => {
                    document.querySelectorAll('[data-tooltip]').forEach(element => {
                        element.addEventListener('mouseenter', (e) => {
                            const tooltip = document.createElement('div');
                            tooltip.className = 'tooltip show';
                            tooltip.textContent = e.target.dataset.tooltip;
                            
                            const rect = e.target.getBoundingClientRect();
                            tooltip.style.left = rect.left + (rect.width / 2) + 'px';
                            tooltip.style.top = (rect.top - 35) + 'px';
                            tooltip.style.transform = 'translateX(-50%)';
                            
                            document.body.appendChild(tooltip);
                            e.target.tooltipElement = tooltip;
                        });
                        
                        element.addEventListener('mouseleave', (e) => {
                            if (e.target.tooltipElement) {
                                e.target.tooltipElement.remove();
                                e.target.tooltipElement = null;
                            }
                        });
                    });
                }, 500);
            }

            // ===== INICIALIZACIÓN =====
            async init() {
                try {
                    console.log('🔄 Inicializando sistema CRM...');
                    
                    // Verificar soporte del navegador
                    if (!window.indexedDB) {
                        throw new Error('IndexedDB no está disponible en este navegador. Use Chrome, Firefox, Edge o Safari moderno.');
                    }
                    
                    // Asegurar que el DOM esté completamente listo
                    await new Promise(resolve => {
                        if (document.readyState === 'loading') {
                            document.addEventListener('DOMContentLoaded', resolve);
                        } else {
                            resolve();
                        }
                    });
                    
                    console.log('🔗 Conectando con base de datos...');
                    await this.initDatabase();
                    console.log('✅ Base de datos conectada');
                    
                    console.log('📊 Cargando datos iniciales...');
                    await this.loadInitialData();
                    console.log('✅ Datos cargados');
                    
                    console.log('🎧 Configurando eventos...');
                    this.setupEventListeners();
                    
                    // El sistema SVG personalizado siempre está disponible - no requiere carga externa
                    console.log('📈 Inicializando gráficos SVG...');
                    this.setupCharts();
                    console.log('✅ Sistema de gráficos disponible');
                    
                    // Recargar el dashboard después de configurar gráficos
                    setTimeout(() => {
                        console.log('🔄 Actualizando dashboard...');
                        this.reloadDashboard();
                    }, 300);
                    
                    this.checkResponsive();
                    
                    // Iniciar sistema de notificaciones de citas
                    console.log('🔔 Iniciando notificaciones...');
                    this.startAppointmentNotifications();
                    
                    console.log('✅ Sistema CRM inicializado completamente');
                    
                    // Mostrar notificación de éxito - comentado para evitar notificaciones múltiples
                    // this.showNotification('Sistema CRM iniciado correctamente', 'success', 3000, 'Sistema Listo');
                    
                } catch (error) {
                    console.error('❌ Error crítico inicializando sistema:', error);
                    
                    // Mostrar error específico según el tipo
                    if (error.message.includes('IndexedDB')) {
                        this.showDatabaseError(error.message);
                    } else {
                        console.error('Error general:', error);
                        this.showNotification('Error al inicializar el sistema. Recarga la página.', 'error', 6000, 'Error Crítico');
                    }
                    
                    throw error; // Re-lanzar para que sea capturado por el inicializador principal
                }
            }

            // ===== SISTEMA DE NOTIFICACIONES DE CITAS =====
            startAppointmentNotifications() {
                console.log('🔔 Iniciando sistema de notificaciones de citas...');
                
                // Solicitar permisos de notificación
                if ('Notification' in window) {
                    if (Notification.permission === 'default') {
                        Notification.requestPermission().then(permission => {
                            if (permission === 'granted') {
                                console.log('✅ Permisos de notificación otorgados');
                                this.showNotification('Notificaciones activadas para recordatorios de citas', 'success', 4000);
                            } else {
                                console.log('⚠️ Permisos de notificación denegados');
                                this.showNotification('Activa las notificaciones en tu navegador para recibir recordatorios', 'warning', 6000);
                            }
                        });
                    }
                } else {
                    console.log('⚠️ Navegador no soporta notificaciones');
                }
                
                // Verificar citas cada minuto
                this.appointmentCheckInterval = setInterval(() => {
                    this.checkUpcomingAppointments();
                }, 60000); // Cada 60 segundos
                
                // Verificar inmediatamente al iniciar
                setTimeout(() => this.checkUpcomingAppointments(), 5000);
            }

            checkUpcomingAppointments() {
                if (!this.appointments || this.appointments.length === 0) return;
                
                const now = new Date();
                const today = now.toISOString().split('T')[0];
                const currentTime = now.getHours() * 60 + now.getMinutes(); // Tiempo en minutos
                
                this.appointments.forEach(appointment => {
                    if (appointment.date === today && appointment.time) {
                        const [hours, minutes] = appointment.time.split(':').map(Number);
                        const appointmentTime = hours * 60 + minutes;
                        const timeDiff = appointmentTime - currentTime;
                        
                        // Notificar 30, 15 y 5 minutos antes
                        if ([30, 15, 5].includes(timeDiff)) {
                            this.sendAppointmentReminder(appointment, timeDiff);
                        } else if (timeDiff === 0) {
                            // Es la hora exacta de la cita
                            this.sendAppointmentAlert(appointment);
                        }
                    }
                });
            }

            sendAppointmentReminder(appointment, minutesUntil) {
                const typeIcon = this.getAppointmentTypeIcon(appointment.type);
                const typeColor = this.getAppointmentTypeColor(appointment.type);
                
                // Notificación visual en la app
                this.showNotification(
                    `${typeIcon} Cita en ${minutesUntil} minutos: ${appointment.title}`, 
                    'warning', 
                    8000,
                    'Recordatorio de Cita'
                );
                
                // Notificación del navegador
                if (Notification.permission === 'granted') {
                    const browserNotification = new Notification('Recordatorio de Cita - CRM AJHB', {
                        body: `${appointment.type}: ${appointment.title}\nCliente: ${appointment.clientName}\nEn ${minutesUntil} minutos (${appointment.time})`,
                        icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMzIiIGZpbGw9IiNDOUE5NkUiLz4KPHN2ZyB4PSIxNiIgeT0iMTYiIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cGF0aCBkPSJNMTIgMkMxMy4xIDIgMTQgMi45IDE0IDRWNUgxN0MxOC4xIDUgMTkgNS45IDE5IDdWMTlDMTkgMjAuMSAxOC4xIDIxIDE3IDIxSDdDNS45IDIxIDUgMjAuMSA1IDE5VjdDNSA1LjkgNS45IDUgNyA1SDEwVjRDMTAgMi45IDEwLjkgMiAxMiAyWiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+Cjwvc3ZnPgo=',
                        tag: `appointment-${appointment.id}-${minutesUntil}`,
                        requireInteraction: true
                    });

                    // Auto-cerrar después de 10 segundos
                    setTimeout(() => {
                        browserNotification.close();
                    }, 10000);

                    // Sonido de notificación
                    this.playNotificationSound('reminder');
                }
                
                console.log(`🔔 Recordatorio enviado: ${appointment.title} en ${minutesUntil} minutos`);
            }

            sendAppointmentAlert(appointment) {
                const typeIcon = this.getAppointmentTypeIcon(appointment.type);
                
                // Notificación visual urgente
                this.showNotification(
                    `${typeIcon} ¡AHORA! Cita: ${appointment.title} con ${appointment.clientName}`, 
                    'error', 
                    15000,
                    '🚨 Cita Ahora'
                );
                
                // Notificación del navegador urgente
                if (Notification.permission === 'granted') {
                    const browserNotification = new Notification('🚨 CITA AHORA - CRM AJHB', {
                        body: `${appointment.type}: ${appointment.title}\nCliente: ${appointment.clientName}\n¡Es hora de tu cita!`,
                        icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMzIiIGZpbGw9IiNFNzRDM0MiLz4KPHN2ZyB4PSIxNiIgeT0iMTYiIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cGF0aCBkPSJNMTIgMkMxMy4xIDIgMTQgMi45IDE0IDRWNUgxN0MxOC4xIDUgMTkgNS45IDE5IDdWMTlDMTkgMjAuMSAxOC4xIDIxIDE3IDIxSDdDNS45IDIxIDUgMjAuMSA1IDE5VjdDNSA1LjkgNS45IDUgNyA1SDEwVjRDMTAgMi45IDEwLjkgMiAxMiAyWii' +
                            'gZmlsbD0id2hpdGUiLz4KPC9zdmc+Cjwvc3ZnPgo=',
                        tag: `appointment-${appointment.id}-now`,
                        requireInteraction: true,
                        vibrate: [200, 100, 200]
                    });

                    // Sonido de alerta más fuerte
                    this.playNotificationSound('alert');
                }
                
                console.log(`🚨 Alerta enviada: Cita ${appointment.title} es AHORA`);
            }

            playNotificationSound(type) {
                try {
                    // Crear audio context
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    if (type === 'reminder') {
                        // Sonido suave para recordatorios (440Hz por 300ms)
                        this.createBeep(audioContext, 440, 300);
                    } else if (type === 'alert') {
                        // Sonido más urgente para alertas (880Hz por 200ms, 3 veces)
                        this.createBeep(audioContext, 880, 200);
                        setTimeout(() => this.createBeep(audioContext, 880, 200), 300);
                        setTimeout(() => this.createBeep(audioContext, 880, 200), 600);
                    }
                } catch (error) {
                    console.log('⚠️ No se pudo reproducir sonido de notificación:', error);
                }
            }

            createBeep(audioContext, frequency, duration) {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration / 1000);
            }

            // Limpiar intervalo de notificaciones
            stopAppointmentNotifications() {
                if (this.appointmentCheckInterval) {
                    clearInterval(this.appointmentCheckInterval);
                    console.log('🔕 Sistema de notificaciones detenido');
                }
            }

            // ===== BASE DE DATOS =====
            async initDatabase() {
                return new Promise((resolve, reject) => {
                    // Verificar si IndexedDB está disponible
                    if (!window.indexedDB) {
                        console.error('❌ IndexedDB no está disponible en este navegador');
                        reject(new Error('IndexedDB no está disponible. Use un navegador moderno (Chrome, Firefox, Edge, Safari).'));
                        return;
                    }

                    console.log('🔄 Iniciando conexión a IndexedDB...');
                    const request = indexedDB.open('CRM_AJHB', 2);
                    
                    request.onerror = (event) => {
                        console.error('❌ Error al conectar con IndexedDB:', event.target.error);
                        reject(new Error(`Error de base de datos: ${event.target.error?.message || 'Desconocido'}`));
                    };
                    
                    request.onblocked = (event) => {
                        console.warn('⚠️ Base de datos bloqueada. Cierre otras pestañas con la aplicación.');
                        // Intentar continuar después de un tiempo
                        setTimeout(() => {
                            if (this.db) {
                                resolve();
                            }
                        }, 1000);
                    };
                    
                    request.onsuccess = (event) => {
                        try {
                            this.db = event.target.result;
                            console.log('✅ Base de datos conectada exitosamente');
                            
                            // Verificar que la base de datos tiene los stores necesarios
                            const requiredStores = ['properties', 'clients', 'contracts', 'prospects', 'appointments'];
                            const missingStores = requiredStores.filter(store => !this.db.objectStoreNames.contains(store));
                            
                            if (missingStores.length > 0) {
                                console.warn('⚠️ Stores faltantes:', missingStores);
                                console.log('🔄 Se creará una nueva versión de la base de datos...');
                                this.db.close();
                                
                                // Crear nueva versión con stores faltantes
                                const upgradeRequest = indexedDB.open('CRM_AJHB', this.db.version + 1);
                                upgradeRequest.onsuccess = (upgradeEvent) => {
                                    this.db = upgradeEvent.target.result;
                                    console.log('✅ Base de datos actualizada');
                                    resolve();
                                };
                                upgradeRequest.onerror = (upgradeEvent) => {
                                    reject(new Error('Error al actualizar base de datos'));
                                };
                                return;
                            }
                            
                            resolve();
                        } catch (error) {
                            console.error('❌ Error en onsuccess:', error);
                            reject(error);
                        }
                    };
                    
                    request.onupgradeneeded = (event) => {
                        try {
                            console.log('🔄 Actualizando estructura de base de datos...');
                            this.db = event.target.result;
                            
                            // Crear store de propiedades
                            if (!this.db.objectStoreNames.contains('properties')) {
                                console.log('📦 Creando store: properties');
                                const propertyStore = this.db.createObjectStore('properties', { 
                                    keyPath: 'id', 
                                    autoIncrement: true 
                                });
                                propertyStore.createIndex('type', 'type', { unique: false });
                                propertyStore.createIndex('status', 'status', { unique: false });
                                propertyStore.createIndex('price', 'price', { unique: false });
                            }
                            
                            // Crear store de clientes
                            if (!this.db.objectStoreNames.contains('clients')) {
                                console.log('📦 Creando store: clients');
                                const clientStore = this.db.createObjectStore('clients', { 
                                    keyPath: 'id', 
                                    autoIncrement: true 
                                });
                                clientStore.createIndex('name', 'name', { unique: false });
                                clientStore.createIndex('email', 'email', { unique: false }); // Cambiado de unique: true
                            }
                            
                            // Crear store de contratos
                            if (!this.db.objectStoreNames.contains('contracts')) {
                                console.log('📦 Creando store: contracts');
                                const contractStore = this.db.createObjectStore('contracts', { 
                                    keyPath: 'id', 
                                    autoIncrement: true 
                                });
                                contractStore.createIndex('propertyId', 'propertyId', { unique: false });
                                contractStore.createIndex('clientId', 'clientId', { unique: false });
                            }
                            
                            // Crear store de prospectos
                            if (!this.db.objectStoreNames.contains('prospects')) {
                                console.log('📦 Creando store: prospects');
                                const prospectStore = this.db.createObjectStore('prospects', { 
                                    keyPath: 'id', 
                                    autoIncrement: true 
                                });
                                prospectStore.createIndex('name', 'name', { unique: false });
                                prospectStore.createIndex('status', 'status', { unique: false });
                            }
                            
                            // Crear store de citas
                            if (!this.db.objectStoreNames.contains('appointments')) {
                                console.log('📦 Creando store: appointments');
                                const appointmentStore = this.db.createObjectStore('appointments', { 
                                    keyPath: 'id', 
                                    autoIncrement: true 
                                });
                                appointmentStore.createIndex('date', 'date', { unique: false });
                                appointmentStore.createIndex('type', 'type', { unique: false });
                            }
                            
                            console.log('✅ Estructura de base de datos actualizada');
                        } catch (error) {
                            console.error('❌ Error al actualizar base de datos:', error);
                            reject(error);
                        }
                    };
                });
            }

            // ===== OPERACIONES DE BASE DE DATOS =====
            async getData(storeName) {
                return new Promise((resolve, reject) => {
                    if (!this.db) {
                        console.warn(`⚠️ Base de datos no inicializada para ${storeName}`);
                        resolve([]); // Devolver array vacío en lugar de error
                        return;
                    }

                    try {
                        const transaction = this.db.transaction([storeName], 'readonly');
                        const store = transaction.objectStore(storeName);
                        const request = store.getAll();
                        
                        request.onsuccess = () => {
                            const result = request.result || [];
                            console.log(`📊 ${storeName} cargados:`, result.length, 'registros');
                            resolve(result);
                        };
                        
                        request.onerror = () => {
                            console.error(`❌ Error cargando ${storeName}:`, request.error);
                            resolve([]); // Devolver array vacío en lugar de rechazar
                        };
                        
                        transaction.onerror = () => {
                            console.error(`❌ Error en transacción ${storeName}:`, transaction.error);
                            resolve([]);
                        };
                    } catch (error) {
                        console.error(`❌ Excepción en getData ${storeName}:`, error);
                        resolve([]);
                    }
                });
            }

            async addData(storeName, data) {
                return new Promise((resolve, reject) => {
                    if (!this.db) {
                        reject(new Error('Base de datos no inicializada'));
                        return;
                    }

                    try {
                        const transaction = this.db.transaction([storeName], 'readwrite');
                        const store = transaction.objectStore(storeName);
                        const request = store.add({
                            ...data,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        });
                        
                        request.onsuccess = () => {
                            console.log(`✅ Datos guardados en ${storeName}:`, request.result);
                            resolve(request.result);
                        };
                        
                        request.onerror = () => {
                            console.error(`❌ Error guardando en ${storeName}:`, request.error);
                            reject(request.error);
                        };

                        transaction.onerror = () => {
                            console.error(`❌ Error en transacción ${storeName}:`, transaction.error);
                            reject(transaction.error);
                        };
                    } catch (error) {
                        console.error(`❌ Error creando transacción para ${storeName}:`, error);
                        reject(error);
                    }
                });
            }

            async updateData(storeName, id, data) {
                return new Promise((resolve, reject) => {
                    if (!this.db) {
                        reject(new Error('Base de datos no inicializada'));
                        return;
                    }

                    try {
                        const transaction = this.db.transaction([storeName], 'readwrite');
                        const store = transaction.objectStore(storeName);
                        const getRequest = store.get(id);
                        
                        getRequest.onsuccess = () => {
                            const existingData = getRequest.result;
                            if (!existingData) {
                                reject(new Error(`No se encontró el registro con ID: ${id}`));
                                return;
                            }

                            const updatedData = {
                                ...existingData,
                                ...data,
                                updatedAt: new Date().toISOString()
                            };
                            
                            const updateRequest = store.put(updatedData);
                            updateRequest.onsuccess = () => {
                                console.log(`✅ Datos actualizados en ${storeName}:`, id);
                                resolve(updateRequest.result);
                            };
                            updateRequest.onerror = () => {
                                console.error(`❌ Error actualizando en ${storeName}:`, updateRequest.error);
                                reject(updateRequest.error);
                            };
                        };
                        
                        getRequest.onerror = () => {
                            console.error(`❌ Error obteniendo registro ${id} de ${storeName}:`, getRequest.error);
                            reject(getRequest.error);
                        };

                        transaction.onerror = () => {
                            console.error(`❌ Error en transacción de actualización ${storeName}:`, transaction.error);
                            reject(transaction.error);
                        };
                    } catch (error) {
                        console.error(`❌ Error en updateData para ${storeName}:`, error);
                        reject(error);
                    }
                });
            }

            async deleteData(storeName, id) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.delete(id);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }

            // ===== ESTADÍSTICAS DEL DASHBOARD =====
            updateDashboardStats(properties, clients, contracts, appointments = []) {
                try {
                    // Guardar los datos actuales para uso en otras funciones
                    this.currentProperties = properties || [];
                    this.currentClients = clients || [];
                    this.currentContracts = contracts || [];
                    
                    console.log('📊 Actualizando estadísticas del dashboard con:', {
                        propiedades: this.currentProperties.length,
                        clientes: this.currentClients.length,
                        contratos: this.currentContracts.length
                    });
                    
                    // === SISTEMA NEURONAL DE ESTADÍSTICAS INTELIGENTES ===
                    console.log('🧠 Actualizando estadísticas neurales del dashboard');
                    
                    // Análisis neuronal de propiedades por estado
                    const propertyStats = this.analyzePropertyStats(properties);
                    const clientStats = this.analyzeClientStats(clients);
                    const contractStats = this.analyzeContractStats(contracts);
                    const appointmentStats = this.analyzeAppointmentStats(appointments);
                    
                    // Actualizaciones básicas con conexiones neurales
                    const totalPropsEl = document.getElementById('totalProperties');
                    const totalClientsEl = document.getElementById('totalClients');
                    const totalSalesEl = document.getElementById('totalSales');
                    const totalRevenueEl = document.getElementById('totalRevenue');

                    if (totalPropsEl) {
                        totalPropsEl.textContent = properties.length;
                        totalPropsEl.title = `${propertyStats.available} disponibles • ${propertyStats.reserved} reservadas • ${propertyStats.sold} vendidas`;
                    }
                    if (totalClientsEl) {
                        totalClientsEl.textContent = clients.length;
                        totalClientsEl.title = `${clientStats.active} activos • ${clientStats.withContracts} con contratos • ${clientStats.withAppointments} con citas`;
                    }
                    
                    if (totalSalesEl) {
                        totalSalesEl.textContent = propertyStats.sold;
                        totalSalesEl.title = `${contractStats.sales} contratos de venta • ${contractStats.reservations} reservas`;
                    }
                    
                    if (totalRevenueEl) {
                        totalRevenueEl.textContent = this.formatCurrency(propertyStats.totalRevenue);
                        totalRevenueEl.title = `Promedio: ${this.formatCurrency(propertyStats.avgPrice)} • Reservado: ${this.formatCurrency(propertyStats.reservedValue)}`;
                    }
                
                    // Métricas neurales avanzadas
                    const currentMonth = new Date().getMonth();
                    const currentYear = new Date().getFullYear();
                    
                    const monthlyData = this.calculateMonthlyMetrics(properties, contracts, clients, appointments, currentMonth, currentYear);
                    
                    const monthlyGrowthEl = document.getElementById('monthlyGrowth');
                    if (monthlyGrowthEl) {
                        monthlyGrowthEl.textContent = `+${monthlyData.growth}%`;
                        monthlyGrowthEl.title = `${monthlyData.newProperties} propiedades nuevas • ${monthlyData.newClients} clientes nuevos • ${monthlyData.newContracts} contratos`;
                    }
                    
                    const avgDealTimeEl = document.getElementById('avgDealTime');
                    if (avgDealTimeEl) {
                        avgDealTimeEl.textContent = `${contractStats.avgDealTime} días`;
                        avgDealTimeEl.title = `Rango: ${contractStats.minDealTime}-${contractStats.maxDealTime} días • Contratos activos: ${contractStats.active}`;
                    }

                    // Actualizar estado de propiedades
                    this.updateSalesTrends(properties, contracts);
                    this.updateDetailedPropertyStats(properties, contracts);
                    
                    // ===== SISTEMA DE METAS MENSUALES =====
                    this.updateMonthlyGoals(properties, contracts, clients);
                    
                    // ===== ACTUALIZAR KPIs =====
                    this.updateKPIs(properties, clients, contracts, appointments);
                } catch (error) {
                    console.error('Error actualizando estadísticas del dashboard:', error);
                    this.showNotification('Error actualizando estadísticas', 'error');
                }
            }

            // ===== SISTEMA DE COMISIONES =====
            calculateCommission(property) {
                if (!property || !property.price || !property.operation) {
                    return 0;
                }
                
                const price = parseFloat(property.price);
                let commissionRate = 0;
                
                switch(property.operation) {
                    case 'venta':
                        commissionRate = 0.07; // 7% para ventas
                        break;
                    case 'compra':
                        commissionRate = 0.03; // 3% para compras (cartelera)
                        break;
                    case 'arriendo':
                        commissionRate = 0.05; // 5% para arriendos (eventos)
                        break;
                    default:
                        commissionRate = 0.05; // Valor por defecto para propiedades antiguas
                        break;
                }
                
                // Retornar solo el 50% de la comisión total (parte del asesor)
                const totalCommission = price * commissionRate;
                return totalCommission / 2; // Asesor recibe 50% de la comisión total
            }
            
            getTotalCommissions(properties) {
                return properties.reduce((total, property) => {
                    // Solo calcular comisiones para propiedades vendidas/alquiladas
                    const status = (property.status || '').toLowerCase();
                    if (status === 'vendida' || status === 'vendido' || status === 'alquilada' || status === 'alquilado') {
                        return total + this.calculateCommission(property);
                    }
                    return total;
                }, 0);
            }

            // ===== SISTEMA DE METAS MENSUALES =====
            updateMonthlyGoals(properties, contracts, clients) {
                try {
                    const currentDate = new Date();
                    const currentMonth = currentDate.getMonth();
                    const currentYear = currentDate.getFullYear();
                    
                    // Meta mensual: $10,000 USD en comisiones
                    const monthlyGoal = 10000; // USD
                    const commissionRate = 0.03; // 3% de comisión estándar
                    const usdToColones = 520; // Aproximado
                    
                    // Filtrar ventas del mes actual
                    const monthlyProperties = properties.filter(prop => {
                        const propDate = new Date(prop.dateAdded || prop.createdAt);
                        return propDate.getMonth() === currentMonth && 
                               propDate.getFullYear() === currentYear && 
                               ((prop.status || '').toLowerCase() === 'vendida' || 
                                (prop.status || '').toLowerCase() === 'vendido');
                    });
                    
                    // Calcular comisiones del mes usando el nuevo sistema
                    const monthlyCommissionColones = this.getTotalCommissions(monthlyProperties);
                    const monthlyCommissionUSD = monthlyCommissionColones / usdToColones;
                    
                    // Calcular progreso
                    const goalProgress = Math.min((monthlyCommissionUSD / monthlyGoal) * 100, 100);
                    const remainingGoal = Math.max(monthlyGoal - monthlyCommissionUSD, 0);
                    
                    // Días trabajados y restantes del mes
                    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
                    const currentDay = currentDate.getDate();
                    const remainingDays = daysInMonth - currentDay;
                    
                    // Promedio diario necesario
                    const dailyTarget = remainingDays > 0 ? remainingGoal / remainingDays : 0;
                    
                    // Actualizar UI si existe el contenedor
                    const monthlyGoalContainer = document.getElementById('monthlyGoalContainer');
                    if (monthlyGoalContainer) {
                        monthlyGoalContainer.innerHTML = `
                            <div class="goal-header">
                                <h4><i class="fas fa-target"></i> Meta Mensual - ${this.getMonthName(currentMonth)} ${currentYear}</h4>
                                <div class="goal-amount">$${monthlyGoal.toLocaleString()} USD</div>
                            </div>
                            
                            <div class="goal-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${goalProgress}%; background: ${goalProgress >= 100 ? 'var(--success)' : goalProgress >= 75 ? 'var(--warning)' : 'var(--primary)'}"></div>
                                </div>
                                <div class="progress-text">${goalProgress.toFixed(1)}% completado</div>
                            </div>
                            
                            <div class="goal-stats">
                                <div class="goal-stat">
                                    <span class="stat-label">Comisiones Ganadas:</span>
                                    <span class="stat-value">${this.formatCurrency(monthlyCommissionColones)} (≈$${Math.round(monthlyCommissionUSD).toLocaleString()})</span>
                                </div>
                                <div class="goal-stat">
                                    <span class="stat-label">Ventas del Mes:</span>
                                    <span class="stat-value">${monthlyProperties.length} propiedades</span>
                                </div>
                                <div class="goal-stat">
                                    <span class="stat-label">Restante para Meta:</span>
                                    <span class="stat-value ${remainingGoal === 0 ? 'achieved' : ''}">$${Math.round(remainingGoal).toLocaleString()}</span>
                                </div>
                                <div class="goal-stat">
                                    <span class="stat-label">Promedio Diario Necesario:</span>
                                    <span class="stat-value">$${Math.round(dailyTarget).toLocaleString()}/día</span>
                                </div>
                                <div class="goal-stat">
                                    <span class="stat-label">Días Restantes:</span>
                                    <span class="stat-value">${remainingDays} días</span>
                                </div>
                            </div>
                            
                            ${goalProgress >= 100 ? `
                                <div class="goal-achievement">
                                    <i class="fas fa-trophy"></i>
                                    <span>¡Meta Alcanzada!</span>
                                    <i class="fas fa-trophy"></i>
                                </div>
                            ` : goalProgress >= 75 ? `
                                <div class="goal-warning">
                                    <i class="fas fa-fire"></i>
                                    <span>¡Muy cerca de la meta!</span>
                                </div>
                            ` : `
                                <div class="goal-motivation">
                                    <i class="fas fa-rocket"></i>
                                    <span>¡Sigue adelante hacia tu meta!</span>
                                </div>
                            `}
                        `;
                    }
                    
                    // Notificación especial si se alcanza la meta
                    if (goalProgress >= 100 && !this.goalAchievedThisMonth) {
                        this.goalAchievedThisMonth = true;
                        this.showNotification(
                            '¡Felicitaciones! Has alcanzado tu meta mensual de $5,000 USD',
                            'success',
                            8000,
                            '🎉 Meta Alcanzada'
                        );
                    }
                    
                } catch (error) {
                    console.error('Error actualizando metas mensuales:', error);
                }
            }

            // ===== ESTADO DE PROPIEDADES =====
            // ===== TENDENCIAS DE VENTAS =====
            updateSalesTrends(properties, contracts) {
                const container = document.getElementById('salesTrendsContainer');
                if (!container) {
                    console.warn('❌ Contenedor de tendencias de ventas no encontrado');
                    return;
                }

                try {
                    console.log('📈 Actualizando tendencias de ventas con', properties.length, 'propiedades');
                    
                    // El sistema SVG personalizado siempre está disponible
                    console.log('✅ Sistema SVG personalizado disponible');

                    // Si no hay propiedades, mostrar gráfico con datos por defecto
                    if (properties.length === 0) {
                        console.log('📊 No hay propiedades, mostrando gráfico con datos por defecto');
                        const defaultData = this.generateDefaultSalesData();
                        this.createSalesTrendChart(defaultData);
                        return;
                    }

                    // Generar datos de ventas reales
                    const salesData = this.generateSalesDataFromProperties(properties, contracts);
                    
                    // Crear gráfico con un pequeño retraso para asegurar que el DOM esté listo
                    setTimeout(() => {
                        this.createSalesTrendChart(salesData);
                    }, 100);
                    
                } catch (error) {
                    console.error('❌ Error en updateSalesTrends:', error);
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-exclamation-triangle" style="color: var(--error);"></i>
                            <h3>Error al cargar datos</h3>
                            <p>No se pudieron procesar las tendencias de ventas</p>
                            <small style="color: var(--text-muted); margin-top: 0.5rem; display: block;">${error.message}</small>
                            <button class="btn btn-primary btn-sm" onclick="crm.reloadDashboard()" style="margin-top: 10px;">
                                <i class="fas fa-refresh"></i> Reintentar
                            </button>
                        </div>
                    `;
                }
            }

            updateDetailedPropertyStats(properties, contracts) {
                const container = document.getElementById('propertiesDetailedStats');
                if (!container) return;

                if (properties.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-chart-bar" style="color: var(--text-muted);"></i>
                            <h3>Sin datos para mostrar</h3>
                            <p>Agrega propiedades para ver las estadísticas detalladas</p>
                        </div>
                    `;
                    return;
                }

                // Calcular estadísticas por estado
                const statusStats = {
                    disponible: { count: 0, value: 0, avg: 0, color: 'success', icon: 'home', label: 'Disponibles' },
                    'en-proceso': { count: 0, value: 0, avg: 0, color: 'warning', icon: 'clock', label: 'En Proceso' },
                    reservada: { count: 0, value: 0, avg: 0, color: 'primary', icon: 'bookmark', label: 'Reservadas' },
                    vendida: { count: 0, value: 0, avg: 0, color: 'accent', icon: 'check-circle', label: 'Vendidas' }
                };

                properties.forEach(property => {
                    const status = (property.status || 'disponible').toLowerCase();
                    if (statusStats[status]) {
                        statusStats[status].count++;
                        statusStats[status].value += property.price || 0;
                    }
                });

                // Calcular promedios
                Object.keys(statusStats).forEach(status => {
                    const stat = statusStats[status];
                    stat.avg = stat.count > 0 ? stat.value / stat.count : 0;
                });

                container.innerHTML = Object.keys(statusStats).map(status => {
                    const stat = statusStats[status];
                    const percentage = properties.length > 0 ? ((stat.count / properties.length) * 100).toFixed(1) : 0;
                    
                    return `
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon ${stat.color}">
                                    <i class="fas fa-${stat.icon}"></i>
                                </div>
                                <span class="badge" style="background: var(--${stat.color});">${percentage}%</span>
                            </div>
                            <div class="stat-value">${stat.count}</div>
                            <div class="stat-label">${stat.label}</div>
                            <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--border); font-size: 0.75rem; color: var(--text-muted);">
                                <div>💰 Valor Total: ${this.formatCurrency(stat.value)}</div>
                                <div>📊 Promedio: ${this.formatCurrency(stat.avg)}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Generar datos por defecto cuando no hay propiedades
            generateDefaultSalesData() {
                console.log('📊 Generando datos por defecto (sin propiedades)');
                
                const months = [];
                const now = new Date();
                
                // Generar últimos 12 meses con datos mínimos
                for (let i = 11; i >= 0; i--) {
                    const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    months.push({
                        month: date.toLocaleDateString('es', { month: 'short', year: '2-digit' }),
                        sales: 0, // Sin ventas
                        revenue: 0 // Sin ingresos
                    });
                }
                
                return months;
            }

            // Generar datos basados en propiedades reales
            generateSalesDataFromProperties(properties, contracts) {
                try {
                    console.log('📊 Generando datos de ventas para', properties.length, 'propiedades');
                    
                    const months = [];
                    const now = new Date();
                    
                    // Generar últimos 12 meses
                    for (let i = 11; i >= 0; i--) {
                        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                        months.push({
                            month: date.toLocaleDateString('es', { month: 'short', year: '2-digit' }),
                            sales: 0,
                            revenue: 0,
                            monthYear: `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`
                        });
                    }

                    // Procesar propiedades vendidas con fechas reales si tienen
                    const soldProperties = properties.filter(p => {
                        const status = (p.status || '').toLowerCase();
                        return status === 'vendida' || status === 'vendido';
                    });
                    
                    console.log('🏠 Propiedades vendidas encontradas:', soldProperties.length);
                    
                    if (soldProperties.length > 0) {
                        soldProperties.forEach(property => {
                            // Usar fecha de agregado si existe, sino fecha actual
                            let saleDate = new Date();
                            if (property.dateAdded) {
                                saleDate = new Date(property.dateAdded);
                            } else if (property.createdAt) {
                                saleDate = new Date(property.createdAt);
                            } else if (property.dateCreated) {
                                saleDate = new Date(property.dateCreated);
                            } else {
                                // Si no tiene fecha, distribuir en los últimos 3 meses
                                saleDate = new Date();
                                saleDate.setMonth(saleDate.getMonth() - Math.floor(Math.random() * 3));
                            }
                            
                            const monthYear = `${saleDate.getFullYear()}-${String(saleDate.getMonth() + 1).padStart(2, '0')}`;
                            
                            // Encontrar el mes correspondiente en nuestros datos
                            const monthData = months.find(m => m.monthYear === monthYear);
                            if (monthData) {
                                monthData.sales += 1;
                                monthData.revenue += property.price || 50000000; // Valor por defecto si no tiene precio
                                console.log(`� Venta agregada: ${property.address || 'Propiedad'} en ${monthData.month} por $${property.price || 50000000}`);
                            }
                        });
                    } else {
                        // Datos mínimos para demostrar el gráfico sin propiedades
                        console.log('📊 No hay propiedades vendidas - gráfico vacío');
                    }

                    console.log('📈 Datos finales generados:', months);
                    return months;
                    
                } catch (error) {
                    console.error('❌ Error generando datos de ventas:', error);
                    // Retornar datos por defecto en caso de error
                    return this.generateDefaultSalesData();
                }
            }

            createSalesTrendChart(salesData) {
                try {
                    const container = document.getElementById('salesTrendsContainer');
                    if (!container) {
                        console.warn('❌ Contenedor del gráfico de ventas no encontrado');
                        return;
                    }

                    console.log('🎨 Creando gráfico de tendencias con sistema SVG personalizado:', salesData);

                    // Verificar que tenemos datos válidos
                    if (!salesData || salesData.length === 0) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-chart-line" style="color: var(--text-muted);"></i>
                                <h3>Sin datos de ventas</h3>
                                <p>Los datos aparecerán cuando haya actividad de ventas</p>
                            </div>
                        `;
                        return;
                    }

                    // Limpiar contenedor
                    container.innerHTML = '';
                    
                    // Crear contenedor del gráfico
                    const chartContainer = document.createElement('div');
                    chartContainer.className = 'chart-container';
                    chartContainer.style.cssText = `
                        position: relative;
                        height: 350px;
                        width: 100%;
                        margin: 0;
                        padding: 0;
                        background: transparent;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    `;
                    
                    // Inicializar charts object si no existe
                    if (!this.charts) {
                        this.charts = {};
                    }
                    
                    // Destruir gráfico existente si existe
                    if (this.charts.salesTrend) {
                        this.charts.salesTrend.destroy();
                    }

                    // Configuración del gráfico personalizado - Solo mostrar ventas
                    const chartConfig = {
                        type: 'line',
                        data: {
                            labels: salesData.map(d => d.month),
                            datasets: [
                                {
                                    label: 'Propiedades Vendidas',
                                    data: salesData.map(d => d.sales),
                                    borderColor: '#C9A96E',
                                    backgroundColor: 'rgba(201, 169, 110, 0.15)',
                                    borderWidth: 3,
                                    fill: true,
                                    pointBackgroundColor: '#C9A96E',
                                    pointBorderColor: '#ffffff',
                                    pointBorderWidth: 2,
                                    pointRadius: 6
                                }
                            ]
                        }
                    };

                    // Crear el gráfico personalizado
                    this.charts.salesTrend = new CustomChart(chartContainer, chartConfig);
                    this.charts.salesTrend.createLineChart();
                    
                    container.appendChild(chartContainer);
                    
                    console.log('✅ Gráfico SVG personalizado creado exitosamente');
                    
                } catch (error) {
                    console.error('❌ Error creando gráfico de tendencias:', error);
                    const container = document.getElementById('salesTrendsContainer');
                    if (container) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-exclamation-triangle" style="color: var(--error);"></i>
                                <h3>Error al crear gráfico</h3>
                                <p>No se pudo generar la visualización</p>
                                <small style="color: var(--text-muted); margin-top: 0.5rem; display: block;">${error.message}</small>
                                <button class="btn btn-primary btn-sm" onclick="crm.reloadDashboard()" style="margin-top: 10px;">
                                    <i class="fas fa-refresh"></i> Reintentar
                                </button>
                            </div>
                        `;
                    }
                }
            }

            // ===== CARGA DE TABLAS =====
            loadTables(properties, clients, contracts) {
                this.loadPropertiesTable(properties);
                this.loadClientsTable(clients);
                this.loadContractsTable(contracts);
                this.loadRecentProperties(properties.slice(-5));
            }

            loadPropertiesTable(properties) {
                const tbody = document.querySelector('#propertiesTable tbody');
                
                if (properties.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9">
                                <div class="empty-state">
                                    <i class="fas fa-home"></i>
                                    <h3>No hay propiedades registradas</h3>
                                    <p>Agrega tu primera propiedad para comenzar</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = properties.map(property => `
                    <tr>
                        <td><i class="fas fa-${this.getPropertyIcon(property.type)}"></i> ${property.type}</td>
                        <td>
                            <span class="operation-badge operation-${(property.operation || 'sin-especificar').toLowerCase()}">
                                ${this.getOperationIcon(property.operation)} ${this.getOperationShortLabel(property.operation)}
                            </span>
                        </td>
                        <td><i class="fas fa-map-marker-alt"></i> ${property.address || property.location || 'Sin dirección'}</td>
                        <td><strong>${this.formatCurrency(property.price)}</strong></td>
                        <td>${property.area} m²</td>
                        <td style="text-align: center;">${property.bedrooms || 0} <i class="fas fa-bed" title="Habitaciones"></i></td>
                        <td style="text-align: center;">${property.bathrooms || 0} <i class="fas fa-bath" title="Baños"></i></td>
                        <td>
                            <span class="status-badge status-${(property.status || 'disponible').toLowerCase().replace(/\s+/g, '-').replace('á', 'a').replace('ó', 'o').replace('í', 'i')}">
                                ${this.getStatusIcon(property.status || 'disponible')} ${property.status || 'Disponible'}
                            </span>
                        </td>
                        <td>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-primary btn-sm" onclick="crm.editProperty(${property.id})" title="Editar Propiedad">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="crm.deleteProperty(${property.id})" title="Eliminar Propiedad" style="background: var(--error);">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }

            loadClientsTable(clients) {
                const tbody = document.querySelector('#clientsTable tbody');
                
                if (clients.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7">
                                <div class="empty-state">
                                    <i class="fas fa-users"></i>
                                    <h3>No hay clientes registrados</h3>
                                    <p>Agrega tu primer cliente para comenzar</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = clients.map(client => `
                    <tr>
                        <td><i class="fas fa-user"></i> ${client.name}</td>
                        <td><a href="mailto:${client.email}" style="color: var(--primary);"><i class="fas fa-envelope"></i> ${client.email}</a></td>
                        <td><a href="tel:${client.phone}" style="color: var(--primary);"><i class="fas fa-phone"></i> ${client.phone}</a></td>
                        <td><i class="fas fa-${this.getPropertyIcon(client.interest)}"></i> ${client.interest}</td>
                        <td><strong>${this.formatCurrency(client.budget)}</strong></td>
                        <td>${this.formatDate(client.createdAt)}</td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="crm.editClient(${client.id})" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="crm.deleteClient(${client.id})" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            loadContractsTable(contracts) {
                const tbody = document.querySelector('#contractsTable tbody');
                
                if (contracts.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7">
                                <div class="empty-state">
                                    <i class="fas fa-file-contract"></i>
                                    <h3>No hay contratos registrados</h3>
                                    <p>Crea tu primer contrato para comenzar</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = contracts.map(contract => `
                    <tr>
                        <td><i class="fas fa-building"></i> ${contract.propertyInfo}</td>
                        <td><i class="fas fa-user"></i> ${contract.clientName}</td>
                        <td><span class="badge">${contract.type}</span></td>
                        <td><strong>${this.formatCurrency(contract.value)}</strong></td>
                        <td><span class="status-badge status-${contract.status.toLowerCase().replace(/\s+/g, '').replace('á', 'a').replace('ó', 'o')}">${contract.status}</span></td>
                        <td>${this.formatDate(contract.createdAt)}</td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="crm.editContract(${contract.id})" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="crm.deleteContract(${contract.id})" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            loadRecentProperties(properties) {
                const tbody = document.getElementById('recentPropertiesTable');
                
                if (properties.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="4">
                                <div class="empty-state">
                                    <i class="fas fa-building"></i>
                                    <p>No hay propiedades recientes</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = properties.map(property => `
                    <tr>
                        <td><i class="fas fa-${this.getPropertyIcon(property.type)}"></i> ${property.type}</td>
                        <td><i class="fas fa-map-marker-alt"></i> ${property.location}</td>
                        <td><strong>${this.formatCurrency(property.price)}</strong></td>
                        <td><span class="status-badge status-${property.status.toLowerCase().replace(/\s+/g, '').replace('á', 'a').replace('ó', 'o')}">${property.status}</span></td>
                    </tr>
                `).join('');
            }

            // ===== GRÁFICOS =====
            setupCharts() {
                try {
                    console.log('🎨 Configurando gráficos del sistema...');
                    
                    // Inicializar objeto de gráficos si no existe
                    if (!this.charts) {
                        this.charts = {};
                    }
                    
                    // El gráfico se creará dinámicamente cuando se carguen los datos
                    // mediante updateSalesTrends, no aquí
                    console.log('✅ Sistema de gráficos inicializado - se crearán dinámicamente');
                    
                } catch (error) {
                    console.error('❌ Error configurando gráficos:', error);
                    // El sistema puede funcionar sin gráficos
                }
            }

            // Nueva función para recargar el dashboard
            async reloadDashboard() {
                try {
                    console.log('🔄 Recargando dashboard...');
                    
                    const [properties, clients, contracts, appointments] = await Promise.all([
                        this.getData('properties'),
                        this.getData('clients'),
                        this.getData('contracts'),
                        this.getData('appointments')
                    ]);

                    // Actualizar las estadísticas y gráficos
                    this.updateDashboardStats(properties, clients, contracts, appointments);
                    
                } catch (error) {
                    console.error('❌ Error recargando dashboard:', error);
                }
            }

            // Función para mostrar error de Chart.js
            showChartError() {
                const container = document.getElementById('salesTrendsContainer');
                if (container) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-exclamation-triangle" style="color: var(--error);"></i>
                            <h3>Error al cargar Chart.js</h3>
                            <p>No se pudo cargar la librería de gráficos</p>
                            <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">
                                Verifica tu conexión a internet y recarga la página
                            </p>
                            <button class="btn btn-primary btn-sm" onclick="location.reload()" style="margin-top: 10px;">
                                <i class="fas fa-refresh"></i> Recargar Página
                            </button>
                        </div>
                    `;
                }
            }

            // ===== NAVEGACIÓN =====
            switchSection(section) {
                // Evitar cambio a la misma sección
                if (this.currentSection === section) {
                    return;
                }

                // Agregar efecto de transición
                const currentSection = document.querySelector('.content-section.active');
                if (currentSection) {
                    currentSection.style.opacity = '0';
                    currentSection.style.transform = 'translateX(-20px)';
                }

                setTimeout(() => {
                    // Ocultar todas las secciones
                    document.querySelectorAll('.content-section').forEach(el => {
                        el.classList.remove('active');
                        el.style.opacity = '';
                        el.style.transform = '';
                    });
                    
                    // Mostrar sección seleccionada
                    const newSection = document.getElementById(section);
                    if (newSection) {
                        newSection.classList.add('active');
                        newSection.style.opacity = '0';
                        newSection.style.transform = 'translateX(20px)';
                        
                        setTimeout(() => {
                            newSection.style.transition = 'all 0.3s ease';
                            newSection.style.opacity = '1';
                            newSection.style.transform = 'translateX(0)';
                        }, 50);
                    }
                    
                    // Actualizar navegación activa
                    document.querySelectorAll('.nav-item').forEach(el => {
                        el.classList.remove('active');
                    });
                    const activeNavItem = document.querySelector(`[data-section="${section}"]`);
                    if (activeNavItem) {
                        activeNavItem.classList.add('active');
                    }
                    
                    // Actualizar título con animación
                    const titleElement = document.getElementById('pageTitle');
                    if (titleElement) {
                        titleElement.style.opacity = '0';
                        titleElement.style.transform = 'translateY(-10px)';
                        
                        setTimeout(() => {
                            const titles = {
                                dashboard: 'Dashboard',
                                properties: 'Propiedades',
                                clients: 'Clientes',
                                prospects: 'Clientes Potenciales',
                                contracts: 'Contratos',
                                calendar: 'Calendario',
                                reports: 'Reportes'
                            };
                            
                            titleElement.textContent = titles[section] || section;
                            titleElement.style.transition = 'all 0.3s ease';
                            titleElement.style.opacity = '1';
                            titleElement.style.transform = 'translateY(0)';
                        }, 100);
                    }
                    
                    this.currentSection = section;
                    
                    // Cargar datos específicos de sección
                    if (section === 'calendar') {
                        setTimeout(() => this.loadCalendarData(), 200);
                    } else if (section === 'reports') {
                        setTimeout(() => this.loadReportsData(), 300);
                    } else if (section === 'prospects') {
                        setTimeout(() => this.loadProspectsData(), 200);
                    }
                    
                    // Mostrar notificación discreta
                    const sectionNames = {
                        dashboard: 'Dashboard',
                        properties: 'Gestión de Propiedades',
                        clients: 'Gestión de Clientes',
                        prospects: 'Clientes Potenciales',
                        contracts: 'Gestión de Contratos',
                        calendar: 'Calendario de Citas',
                        reports: 'Reportes y Análisis'
                    };
                    
                    this.showNotification(`Navegando a ${sectionNames[section] || section}`, 'info', 2000);
                    
                }, 150);
                
                // En dispositivos móviles, cerrar sidebar después de seleccionar una sección
                if (this.isMobile) {
                    setTimeout(() => this.closeSidebar(), 600);
                }
            }

            // ===== SIDEBAR =====
            toggleSidebar() {
                const sidebar = document.getElementById('sidebar');
                const mainContent = document.getElementById('mainContent');
                const overlay = document.getElementById('sidebarOverlay');
                
                if (sidebar.classList.contains('show')) {
                    sidebar.classList.remove('show');
                    mainContent.classList.remove('with-sidebar');
                    overlay.classList.remove('show');
                } else {
                    sidebar.classList.add('show');
                    mainContent.classList.add('with-sidebar');
                    overlay.classList.add('show');
                }
            }

            closeSidebar() {
                const sidebar = document.getElementById('sidebar');
                const mainContent = document.getElementById('mainContent');
                const overlay = document.getElementById('sidebarOverlay');
                
                sidebar.classList.remove('show');
                mainContent.classList.remove('with-sidebar');
                overlay.classList.remove('show');
            }

            // ===== MODALES =====
            openModal(modalId) {
                document.getElementById(modalId).classList.add('active');
                document.body.style.overflow = 'hidden';
            }

            closeModal(modalId) {
                document.getElementById(modalId).classList.remove('active');
                document.body.style.overflow = '';
                
                // Limpiar formularios
                const form = document.querySelector(`#${modalId} form`);
                if (form) form.reset();
            }

            // ===== OPERACIONES CRUD =====
            async showAddPropertyModal() {
                this.resetPropertyModal();
                this.openModal('propertyModal');
            }

            async showAddClientModal() {
                this.resetClientModal();
                this.openModal('clientModal');
            }

            async showAddContractModal() {
                try {
                    const [properties, clients] = await Promise.all([
                        this.getData('properties'),
                        this.getData('clients')
                    ]);

                    if (properties.length === 0) {
                        this.showNotification('Primero debes agregar propiedades', 'warning');
                        return;
                    }

                    if (clients.length === 0) {
                        this.showNotification('Primero debes agregar clientes', 'warning');
                        return;
                    }

                    // Resetear modal antes de llenar
                    this.resetContractModal();

                    // Llenar selects con datos reales
                    const propertySelect = document.getElementById('contractProperty');
                    const clientSelect = document.getElementById('contractClient');

                    // Filtrar propiedades disponibles (comparación mejorada)
                    const availableProperties = properties.filter(p => {
                        const status = (p.status || '').toLowerCase();
                        return status === 'disponible' || status === 'available' || status === '';
                    });

                    console.log('🏠 Propiedades disponibles para contrato:', availableProperties.length);

                    propertySelect.innerHTML = '<option value="">Seleccionar propiedad</option>' +
                        availableProperties
                            .map(p => `<option value="${p.id}" data-price="${p.price || 0}">${p.type || 'Sin tipo'} - ${p.address || 'Sin dirección'} - $${(p.price || 0).toLocaleString()}</option>`)
                            .join('');

                    clientSelect.innerHTML = '<option value="">Seleccionar cliente</option>' +
                        clients.map(c => `<option value="${c.id}">${c.name} - ${c.email || ''}</option>`).join('');

                    // Agregar evento para autocompletar precio cuando se selecciona propiedad
                    propertySelect.addEventListener('change', function() {
                        const selectedOption = this.options[this.selectedIndex];
                        const price = selectedOption.getAttribute('data-price');
                        const contractValueInput = document.getElementById('contractValue');
                        
                        if (price && contractValueInput) {
                            contractValueInput.value = price;
                            console.log('💰 Precio autocompletado:', price);
                        }
                    });

                    this.openModal('contractModal');
                } catch (error) {
                    console.error('Error preparando modal de contrato:', error);
                    this.showNotification('Error preparando formulario', 'error');
                }
            }

            // ===== EVENTOS DE FORMULARIOS =====
            setupEventListeners() {
                console.log('🎧 Configurando event listeners...');
                
                // Prevenir múltiples configuraciones
                if (this.listenersConfigured) {
                    console.log('⚠️ Event listeners ya configurados, saltando...');
                    return;
                }

                // Formularios con verificaciones de existencia
                const propertyForm = document.getElementById('propertyForm');
                if (propertyForm) {
                    // Remover listener existente si existe
                    propertyForm.removeEventListener('submit', this._propertySubmitHandler);
                    this._propertySubmitHandler = (e) => this.handlePropertySubmit(e);
                    propertyForm.addEventListener('submit', this._propertySubmitHandler);
                    console.log('✅ Event listener para propiedades configurado');
                }
                
                const clientForm = document.getElementById('clientForm');
                if (clientForm) {
                    // Remover listener existente si existe
                    clientForm.removeEventListener('submit', this._clientSubmitHandler);
                    this._clientSubmitHandler = (e) => this.handleClientSubmit(e);
                    clientForm.addEventListener('submit', this._clientSubmitHandler);
                    console.log('✅ Event listener para clientes configurado');
                }
                
                const contractForm = document.getElementById('contractForm');
                if (contractForm) {
                    // Remover listener existente si existe
                    contractForm.removeEventListener('submit', this._contractSubmitHandler);
                    this._contractSubmitHandler = (e) => this.handleContractSubmit(e);
                    contractForm.addEventListener('submit', this._contractSubmitHandler);
                    console.log('✅ Event listener para contratos configurado');
                } else {
                    console.error('❌ Formulario contractForm no encontrado');
                }
                
                const prospectForm = document.getElementById('prospectForm');
                if (prospectForm) {
                    // Remover listener existente si existe
                    prospectForm.removeEventListener('submit', this._prospectSubmitHandler);
                    this._prospectSubmitHandler = (e) => this.handleProspectSubmit(e);
                    prospectForm.addEventListener('submit', this._prospectSubmitHandler);
                    console.log('✅ Event listener para prospectos configurado');
                }
                
                const appointmentForm = document.getElementById('appointmentForm');
                if (appointmentForm) {
                    // Remover listener existente si existe
                    appointmentForm.removeEventListener('submit', this._appointmentSubmitHandler);
                    this._appointmentSubmitHandler = (e) => this.handleAppointmentSubmit(e);
                    appointmentForm.addEventListener('submit', this._appointmentSubmitHandler);
                    console.log('✅ Event listener para citas configurado');
                }
                
                // Responsive - solo una vez
                if (!this._resizeHandler) {
                    this._resizeHandler = () => this.checkResponsive();
                    window.addEventListener('resize', this._resizeHandler);
                }
                
                // Modal overlay clicks - verificar que no se hayan configurado antes
                if (!this._modalClicksConfigured) {
                    document.querySelectorAll('.modal-overlay').forEach(modal => {
                        modal.addEventListener('click', (e) => {
                            if (e.target === modal) {
                                this.closeModal(modal.id);
                            }
                        });
                    });
                    this._modalClicksConfigured = true;
                }
                
                // Solicitar permisos de notificación - solo una vez
                if ('Notification' in window && Notification.permission === 'default' && !this._notificationRequested) {
                    Notification.requestPermission();
                    this._notificationRequested = true;
                }
                
                // Auto-llenar valor de contrato - solo una vez
                const contractPropertySelect = document.getElementById('contractProperty');
                if (contractPropertySelect && !this._contractAutoFillConfigured) {
                    contractPropertySelect.addEventListener('change', (e) => {
                        const selectedOption = e.target.selectedOptions[0];
                        if (selectedOption && selectedOption.dataset.price) {
                            const contractValueInput = document.getElementById('contractValue');
                            if (contractValueInput) {
                                contractValueInput.value = selectedOption.dataset.price;
                                console.log('💰 Precio autocompletado:', selectedOption.dataset.price);
                            }
                        }
                    });
                    this._contractAutoFillConfigured = true;
                }
                
                // Marcar como configurados para evitar duplicaciones
                this.listenersConfigured = true;
                console.log('✅ Todos los event listeners configurados correctamente');
            }

            async handlePropertySubmit(e) {
                e.preventDefault();
                e.stopPropagation(); // Evitar propagación del evento
                
                // Protección más fuerte contra envío múltiple
                if (this.isSubmitting) {
                    console.log('⚠️ Ya se está procesando un envío de propiedad, ignorando...');
                    return;
                }
                this.isSubmitting = true;
                
                console.log('📝 Procesando envío de propiedad...');
                
                // Mostrar indicador de carga
                const submitBtn = document.querySelector('#propertyForm button[type="submit"]');
                if (!submitBtn) {
                    console.error('❌ Botón de envío no encontrado');
                    this.isSubmitting = false;
                    return;
                }
                
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
                submitBtn.disabled = true;
                
                try {
                    const formData = {
                        type: document.getElementById('propertyType').value,
                        operation: document.getElementById('propertyOperation').value,
                        address: document.getElementById('propertyAddress').value.trim(),
                        price: parseFloat(document.getElementById('propertyPrice').value),
                        bedrooms: parseInt(document.getElementById('propertyBedrooms').value) || 0,
                        bathrooms: parseInt(document.getElementById('propertyBathrooms').value) || 0,
                        area: parseFloat(document.getElementById('propertyArea').value),
                        status: document.getElementById('propertyStatus').value,
                        description: document.getElementById('propertyDescription').value.trim(),
                        dateAdded: new Date().toISOString(), // Fecha de agregado
                        createdAt: new Date().toISOString()  // Marca de tiempo
                    };

                    // Validación de datos mejorada
                    if (!formData.type) {
                        this.showNotification('⚠️ Por favor seleccione el tipo de propiedad', 'warning');
                        return;
                    }
                    if (!formData.address) {
                        this.showNotification('⚠️ Por favor ingrese la ubicación de la propiedad', 'warning');
                        return;
                    }
                    if (!formData.price || formData.price <= 0) {
                        this.showNotification('⚠️ Por favor ingrese un precio válido', 'warning');
                        return;
                    }
                    if (!formData.area || formData.area <= 0) {
                        this.showNotification('⚠️ Por favor ingrese un área válida', 'warning');
                        return;
                    }

                    if (this.editingPropertyId) {
                        // Modo edición
                        await this.updateData('properties', this.editingPropertyId, formData);
                        this.showNotification('✅ Propiedad actualizada exitosamente', 'success');
                        this.editingPropertyId = null; // Limpiar el ID de edición
                        // Actualizar título del modal
                        document.querySelector('#propertyModal .modal-title').textContent = 'Agregar Nueva Propiedad';
                    } else {
                        // Modo creación
                        await this.addData('properties', formData);
                        this.showNotification('✅ Propiedad agregada exitosamente', 'success');
                    }

                    await this.loadInitialData();
                    this.closeModal('propertyModal');
                    
                    // Resetear el modal para próximo uso
                    this.resetPropertyModal();
                    
                } catch (error) {
                    console.error('Error guardando propiedad:', error);
                    this.showNotification(`❌ Error al guardar propiedad: ${error.message}`, 'error');
                } finally {
                    // Restaurar botón y permitir nuevo envío
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    this.isSubmitting = false;
                    console.log('✅ Envío de propiedad completado');
                }
            }

            async handleClientSubmit(e) {
                e.preventDefault();
                
                // Prevenir envío múltiple
                if (this.isSubmittingClient) return;
                this.isSubmittingClient = true;
                
                // Mostrar indicador de carga
                const submitBtn = document.querySelector('#clientForm button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
                submitBtn.disabled = true;
                
                try {
                    const formData = {
                        name: document.getElementById('clientName').value.trim(),
                        email: document.getElementById('clientEmail').value.trim(),
                        phone: document.getElementById('clientPhone').value.trim(),
                        interest: document.getElementById('clientInterest').value,
                        budget: parseFloat(document.getElementById('clientBudget').value) || 0,
                        notes: document.getElementById('clientNotes') ? document.getElementById('clientNotes').value.trim() : '',
                        dateAdded: new Date().toISOString(), // Fecha de agregado
                        createdAt: new Date().toISOString()  // Marca de tiempo
                    };

                    // Validación mejorada
                    if (!formData.name || !formData.email || !formData.phone) {
                        this.showNotification('⚠️ Por favor complete los campos obligatorios: Nombre, Email y Teléfono', 'warning');
                        return;
                    }

                    if (!formData.interest) {
                        this.showNotification('⚠️ Por favor seleccione el tipo de propiedad de interés', 'warning');
                        return;
                    }

                    // Validar email
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(formData.email)) {
                        this.showNotification('⚠️ Por favor ingrese un email válido', 'warning');
                        return;
                    }

                    if (this.editingClientId) {
                        // Modo edición
                        await this.updateData('clients', this.editingClientId, formData);
                        this.showNotification('✅ Cliente actualizado exitosamente', 'success');
                        this.editingClientId = null; // Limpiar el ID de edición
                        // Actualizar título del modal
                        document.querySelector('#clientModal .modal-title').textContent = 'Agregar Nuevo Cliente';
                    } else {
                        // Modo creación
                        await this.addData('clients', formData);
                        this.showNotification('✅ Cliente agregado exitosamente', 'success');
                    }

                    await this.loadInitialData();
                    this.closeModal('clientModal');
                    
                    // Resetear el modal para próximo uso
                    this.resetClientModal();
                } catch (error) {
                    console.error('Error guardando cliente:', error);
                    if (error.name === 'ConstraintError') {
                        this.showNotification('❌ Ya existe un cliente con este email', 'error');
                    } else {
                        this.showNotification(`❌ Error al guardar cliente: ${error.message}`, 'error');
                    }
                } finally {
                    // Restaurar botón y permitir nuevo envío
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    this.isSubmittingClient = false;
                }
            }

            async handleContractSubmit(e) {
                e.preventDefault();
                
                try {
                    console.log('🚀 Iniciando guardado de contrato...');
                    
                    const propertySelect = document.getElementById('contractProperty');
                    const clientSelect = document.getElementById('contractClient');
                    
                    if (!propertySelect.value) {
                        this.showNotification('Por favor selecciona una propiedad', 'warning');
                        return;
                    }
                    
                    if (!clientSelect.value) {
                        this.showNotification('Por favor selecciona un cliente', 'warning');
                        return;
                    }
                    
                    const propertyOption = propertySelect.selectedOptions[0];
                    const clientOption = clientSelect.selectedOptions[0];

                    const formData = {
                        propertyId: parseInt(propertySelect.value),
                        propertyInfo: propertyOption ? propertyOption.text : '',
                        clientId: parseInt(clientSelect.value),
                        clientName: clientOption ? clientOption.text : '',
                        type: document.getElementById('contractType').value,
                        value: parseFloat(document.getElementById('contractValue').value) || 0,
                        date: document.getElementById('contractDate').value,
                        terms: document.getElementById('contractTerms') ? document.getElementById('contractTerms').value : '',
                        status: 'Activo',
                        dateAdded: new Date().toISOString(),
                        createdAt: new Date().toISOString()
                    };

                    console.log('📝 Datos del contrato:', formData);

                    if (this.editingContractId) {
                        // Modo edición
                        console.log('✏️ Actualizando contrato existente:', this.editingContractId);
                        await this.updateData('contracts', this.editingContractId, formData);
                        this.showNotification('Contrato actualizado exitosamente', 'success');
                        this.editingContractId = null; // Limpiar el ID de edición
                    } else {
                        // Modo creación
                        console.log('➕ Creando nuevo contrato...');
                        const contractId = await this.addData('contracts', formData);
                        console.log('✅ Contrato creado con ID:', contractId);
                        
                        // Actualizar estado de propiedad según tipo de contrato
                        if (formData.propertyId) {
                            let newStatus = 'Reservada'; // Por defecto
                            
                            // Si es venta, marcar como vendida
                            if (formData.type && formData.type.toLowerCase().includes('venta')) {
                                newStatus = 'Vendida';
                            }
                            
                            console.log(`🏠 Actualizando propiedad ${formData.propertyId} a estado: ${newStatus}`);
                            await this.updateData('properties', formData.propertyId, { 
                                status: newStatus,
                                soldAt: newStatus === 'Vendida' ? new Date().toISOString() : null
                            });
                            
                            console.log(`🏠 Propiedad ${formData.propertyId} actualizada a estado: ${newStatus}`);
                        }
                        
                        this.showNotification('✅ Contrato creado exitosamente', 'success');
                    }
                    
                    console.log('🔄 Recargando datos...');
                    await this.loadInitialData();
                    this.closeModal('contractModal');
                    
                    // Resetear el modal para próximo uso
                    this.resetContractModal();
                } catch (error) {
                    console.error('❌ Error completo guardando contrato:', error);
                    console.error('Stack trace:', error.stack);
                    this.showNotification(`Error al guardar contrato: ${error.message}`, 'error');
                }
            }

            // ===== FUNCIONES RESET DE MODALES =====
            resetPropertyModal() {
                document.querySelector('#propertyModal .modal-title').textContent = 'Agregar Nueva Propiedad';
                const submitBtn = document.querySelector('#propertyForm button[type="submit"]');
                submitBtn.innerHTML = '<i class="fas fa-plus"></i> Agregar Propiedad';
                
                // Reset todos los campos específicamente
                document.getElementById('propertyType').value = '';
                document.getElementById('propertyOperation').value = '';
                document.getElementById('propertyAddress').value = '';
                document.getElementById('propertyPrice').value = '';
                document.getElementById('propertyBedrooms').value = '';
                document.getElementById('propertyBathrooms').value = '';
                document.getElementById('propertyArea').value = '';
                document.getElementById('propertyStatus').value = 'disponible'; // Valor por defecto
                document.getElementById('propertyDescription').value = '';
                
                this.editingPropertyId = null;
            }

            resetClientModal() {
                document.querySelector('#clientModal .modal-title').textContent = 'Agregar Nuevo Cliente';
                const submitBtn = document.querySelector('#clientForm button[type="submit"]');
                submitBtn.innerHTML = '<i class="fas fa-plus"></i> Agregar Cliente';
                
                // Reset todos los campos específicamente
                document.getElementById('clientName').value = '';
                document.getElementById('clientEmail').value = '';
                document.getElementById('clientPhone').value = '';
                document.getElementById('clientInterest').value = '';
                document.getElementById('clientBudget').value = '';
                document.getElementById('clientNotes').value = '';
                
                this.editingClientId = null;
            }

            resetContractModal() {
                document.querySelector('#contractModal .modal-title').textContent = 'Crear Nuevo Contrato';
                const submitBtn = document.querySelector('#contractForm button[type="submit"]');
                submitBtn.innerHTML = '<i class="fas fa-plus"></i> Crear Contrato';
                
                // Reset todos los campos específicamente
                document.getElementById('contractProperty').value = '';
                document.getElementById('contractClient').value = '';
                document.getElementById('contractType').value = '';
                document.getElementById('contractValue').value = '';
                document.getElementById('contractTerms').value = '';
                
                // Establecer fecha actual
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('contractDate').value = today;
                
                this.editingContractId = null;
            }

            resetProspectModal() {
                document.querySelector('#prospectModal .modal-title').textContent = 'Agregar Nuevo Prospecto';
                const submitBtn = document.querySelector('#prospectForm button[type="submit"]');
                submitBtn.innerHTML = '<i class="fas fa-plus"></i> Agregar Prospecto';
                document.getElementById('prospectForm').reset();
                this.editingProspectId = null;
            }

            // ===== SISTEMA DE CONFIRMACIÓN DE ELIMINACIÓN =====
            showConfirmationModal(type, item, onConfirm) {
                const modal = document.getElementById('confirmationModal');
                const title = document.getElementById('confirmationTitle');
                const subtitle = document.getElementById('confirmationSubtitle');
                const details = document.getElementById('confirmationDetails');
                const confirmBtn = document.getElementById('confirmDeleteBtn');
                
                // Configurar títulos según el tipo
                const typeConfig = {
                    property: { title: 'Eliminar Propiedad', subtitle: 'Se eliminará permanentemente del catálogo', icon: 'fas fa-home' },
                    client: { title: 'Eliminar Cliente', subtitle: 'Se eliminará el cliente y su historial', icon: 'fas fa-user' },
                    contract: { title: 'Eliminar Contrato', subtitle: 'Se eliminará el contrato del sistema', icon: 'fas fa-file-contract' },
                    prospect: { title: 'Eliminar Prospecto', subtitle: 'Se eliminará el prospecto de la base de datos', icon: 'fas fa-user-plus' },
                    appointment: { title: 'Eliminar Cita', subtitle: 'Se cancelará la cita programada', icon: 'fas fa-calendar-times' }
                };
                
                const config = typeConfig[type] || typeConfig.property;
                title.textContent = config.title;
                subtitle.textContent = config.subtitle;
                
                // Generar detalles específicos según el tipo
                let detailsHTML = `<h4><i class="${config.icon}"></i> Información del ${type === 'property' ? 'Inmueble' : type === 'client' ? 'Cliente' : type === 'contract' ? 'Contrato' : type === 'prospect' ? 'Prospecto' : 'Cita'}</h4>`;
                
                if (type === 'property') {
                    const commission = this.calculateCommission(item);
                    const commissionUSD = commission / 520; // Conversión aproximada
                    detailsHTML += `
                        <div class="detail-row">
                            <span class="detail-label">Tipo:</span>
                            <span class="detail-value">${item.type || 'No especificado'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Operación:</span>
                            <span class="detail-value">${this.getOperationLabel(item.operation) || 'No especificada'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Ubicación:</span>
                            <span class="detail-value">${item.address || 'No especificada'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Precio:</span>
                            <span class="detail-value">${this.formatCurrency(item.price || 0)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Estado:</span>
                            <span class="detail-value status-${(item.status || '').toLowerCase()}">${item.status || 'Disponible'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Comisión Potencial:</span>
                            <span class="detail-value" style="color: var(--warning);">${this.formatCurrency(commission)} (≈$${commissionUSD.toFixed(0)})</span>
                        </div>`;
                } else if (type === 'client') {
                    detailsHTML += `
                        <div class="detail-row">
                            <span class="detail-label">Nombre:</span>
                            <span class="detail-value">${item.name || 'Sin nombre'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Email:</span>
                            <span class="detail-value">${item.email || 'Sin email'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Teléfono:</span>
                            <span class="detail-value">${item.phone || 'Sin teléfono'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Fecha de Registro:</span>
                            <span class="detail-value">${new Date(item.dateAdded || Date.now()).toLocaleDateString('es-ES')}</span>
                        </div>`;
                } else if (type === 'appointment') {
                    detailsHTML += `
                        <div class="detail-row">
                            <span class="detail-label">Cliente:</span>
                            <span class="detail-value">${item.clientName || 'Sin cliente'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Fecha:</span>
                            <span class="detail-value">${new Date(item.date || Date.now()).toLocaleDateString('es-ES')}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Hora:</span>
                            <span class="detail-value">${item.time || 'Sin hora'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Tipo:</span>
                            <span class="detail-value">${item.type || 'Sin especificar'}</span>
                        </div>`;
                }
                
                details.innerHTML = detailsHTML;
                
                // Configurar botón de confirmación
                confirmBtn.onclick = () => {
                    onConfirm();
                    this.closeConfirmationModal();
                };
                
                // Mostrar modal
                modal.classList.add('show');
            }
            
            closeConfirmationModal() {
                const modal = document.getElementById('confirmationModal');
                modal.classList.remove('show');
            }
            
            getOperationLabel(operation) {
                const labels = {
                    'venta': 'Venta (7% comisión)',
                    'compra': 'Compra para Cartelera (3% comisión)',
                    'arriendo': 'Arriendo por Día/Eventos (5% comisión)'
                };
                return labels[operation] || operation;
            }

            // ===== OPERACIONES DE ELIMINACIÓN =====
            async deleteProperty(id) {
                try {
                    const properties = await this.getData('properties');
                    const property = properties.find(p => p.id === id);
                    
                    if (!property) {
                        this.showNotification('Propiedad no encontrada', 'error');
                        return;
                    }
                    
                    this.showConfirmationModal('property', property, async () => {
                        try {
                            await this.deleteData('properties', id);
                            await this.loadInitialData();
                            this.showNotification(`Propiedad eliminada: ${property.address || 'Sin dirección'}`, 'success', 5000);
                        } catch (error) {
                            console.error('Error eliminando propiedad:', error);
                            this.showNotification('Error al eliminar la propiedad', 'error');
                        }
                    });
                } catch (error) {
                    console.error('Error obteniendo propiedad:', error);
                    this.showNotification('Error al obtener información de la propiedad', 'error');
                }
            }

            async deleteClient(id) {
                try {
                    const clients = await this.getData('clients');
                    const client = clients.find(c => c.id === id);
                    
                    if (!client) {
                        this.showNotification('Cliente no encontrado', 'error');
                        return;
                    }
                    
                    this.showConfirmationModal('client', client, async () => {
                        try {
                            await this.deleteData('clients', id);
                            await this.loadInitialData();
                            this.showNotification(`Cliente eliminado: ${client.name || 'Sin nombre'}`, 'success', 5000);
                        } catch (error) {
                            console.error('Error eliminando cliente:', error);
                            this.showNotification('Error al eliminar el cliente', 'error');
                        }
                    });
                } catch (error) {
                    console.error('Error obteniendo cliente:', error);
                    this.showNotification('Error al obtener información del cliente', 'error');
                }
            }

            async deleteContract(id) {
                try {
                    const contracts = await this.getData('contracts');
                    const contract = contracts.find(c => c.id === id);
                    
                    if (!contract) {
                        this.showNotification('Contrato no encontrado', 'error');
                        return;
                    }
                    
                    this.showConfirmationModal('contract', contract, async () => {
                        try {
                            await this.deleteData('contracts', id);
                            await this.loadInitialData();
                            this.showNotification(`Contrato eliminado: ${contract.type || 'Sin tipo'}`, 'success', 5000);
                        } catch (error) {
                            console.error('Error eliminando contrato:', error);
                            this.showNotification('Error al eliminar el contrato', 'error');
                        }
                    });
                } catch (error) {
                    console.error('Error obteniendo contrato:', error);
                    this.showNotification('Error al obtener información del contrato', 'error');
                }
            }

            // ===== OPERACIONES DE EDICIÓN =====
            async editProperty(id) {
                try {
                    // Obtener los datos de la propiedad
                    const properties = await this.getData('properties');
                    const property = properties.find(p => p.id === id);
                    
                    if (!property) {
                        this.showNotification('Propiedad no encontrada', 'error');
                        return;
                    }

                    // Llenar el formulario con los datos existentes
                    document.getElementById('propertyType').value = property.type || '';
                    document.getElementById('propertyOperation').value = property.operation || '';
                    document.getElementById('propertyAddress').value = property.address || '';
                    document.getElementById('propertyPrice').value = property.price || '';
                    document.getElementById('propertyBedrooms').value = property.bedrooms || '';
                    document.getElementById('propertyBathrooms').value = property.bathrooms || '';
                    document.getElementById('propertyArea').value = property.area || '';
                    document.getElementById('propertyStatus').value = property.status || '';
                    document.getElementById('propertyDescription').value = property.description || '';

                    // Cambiar el título y el botón del modal
                    document.querySelector('#propertyModal .modal-title').textContent = 'Editar Propiedad';
                    const submitBtn = document.querySelector('#propertyForm button[type="submit"]');
                    submitBtn.innerHTML = '<i class="fas fa-save"></i> Actualizar Propiedad';

                    // Guardar el ID de la propiedad que se está editando
                    this.editingPropertyId = id;

                    // Mostrar el modal
                    this.openModal('propertyModal');
                    
                    this.showNotification('Editando propiedad', 'info', 2000);
                } catch (error) {
                    console.error('Error al editar propiedad:', error);
                    this.showNotification('Error al cargar datos de la propiedad', 'error');
                }
            }

            async editClient(id) {
                try {
                    // Obtener los datos del cliente
                    const clients = await this.getData('clients');
                    const client = clients.find(c => c.id === id);
                    
                    if (!client) {
                        this.showNotification('Cliente no encontrado', 'error');
                        return;
                    }

                    // Llenar el formulario con los datos existentes
                    document.getElementById('clientName').value = client.name || '';
                    document.getElementById('clientEmail').value = client.email || '';
                    document.getElementById('clientPhone').value = client.phone || '';
                    document.getElementById('clientInterest').value = client.interest || '';
                    document.getElementById('clientBudget').value = client.budget || '';
                    document.getElementById('clientNotes').value = client.notes || '';

                    // Cambiar el título y el botón del modal
                    document.querySelector('#clientModal .modal-title').textContent = 'Editar Cliente';
                    const submitBtn = document.querySelector('#clientForm button[type="submit"]');
                    submitBtn.innerHTML = '<i class="fas fa-save"></i> Actualizar Cliente';

                    // Guardar el ID del cliente que se está editando
                    this.editingClientId = id;

                    // Mostrar el modal
                    this.openModal('clientModal');
                    
                    this.showNotification('Editando cliente', 'info', 2000);
                } catch (error) {
                    console.error('Error editando cliente:', error);
                    this.showNotification('Error al cargar datos del cliente', 'error');
                }
            }

            async editContract(id) {
                try {
                    // Obtener los datos del contrato
                    const contracts = await this.getData('contracts');
                    const contract = contracts.find(c => c.id === id);
                    
                    if (!contract) {
                        this.showNotification('Contrato no encontrado', 'error');
                        return;
                    }

                    // Cargar datos necesarios para los selects
                    const [properties, clients] = await Promise.all([
                        this.getData('properties'),
                        this.getData('clients')
                    ]);

                    // Llenar los selects de propiedades y clientes
                    const propertySelect = document.getElementById('contractProperty');
                    const clientSelect = document.getElementById('contractClient');

                    propertySelect.innerHTML = properties.map(p => 
                        `<option value="${p.id}" ${p.id === contract.propertyId ? 'selected' : ''}>
                            ${p.type} - ${p.address} - ${this.formatCurrency(p.price)}
                        </option>`
                    ).join('');

                    clientSelect.innerHTML = clients.map(c => 
                        `<option value="${c.id}" ${c.id === contract.clientId ? 'selected' : ''}>
                            ${c.name} - ${c.email}
                        </option>`
                    ).join('');

                    // Llenar el resto del formulario
                    document.getElementById('contractType').value = contract.type || '';
                    document.getElementById('contractDate').value = contract.date ? contract.date.split('T')[0] : '';
                    document.getElementById('contractTerms').value = contract.terms || '';

                    // Cambiar el título y el botón del modal
                    document.querySelector('#contractModal .modal-title').textContent = 'Editar Contrato';
                    const submitBtn = document.querySelector('#contractForm button[type="submit"]');
                    submitBtn.innerHTML = '<i class="fas fa-save"></i> Actualizar Contrato';

                    // Guardar el ID del contrato que se está editando
                    this.editingContractId = id;

                    // Mostrar el modal
                    this.openModal('contractModal');
                    
                    this.showNotification('Editando contrato', 'info', 2000);
                } catch (error) {
                    console.error('Error al editar contrato:', error);
                    this.showNotification('Error al cargar datos del contrato', 'error');
                }
            }

            // ===== UTILIDADES =====
            formatCurrency(amount) {
                return new Intl.NumberFormat('es-CR', {
                    style: 'currency',
                    currency: 'CRC',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(amount || 0);
            }

            formatDate(dateString) {
                return new Intl.DateTimeFormat('es-ES', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                }).format(new Date(dateString));
            }

            getPropertyIcon(type) {
                const icons = {
                    'Casa': 'home',
                    'Departamento': 'building',
                    'Terreno': 'square',
                    'Local Comercial': 'store',
                    'Oficina': 'briefcase'
                };
                return icons[type] || 'building';
            }

            getStatusIcon(status) {
                const icons = {
                    'disponible': '🟢',
                    'en-proceso': '🟡',
                    'reservada': '🟠',
                    'vendida': '🔴'
                };
                return icons[status] || '🟢';
            }

            getOperationIcon(operation) {
                const icons = {
                    'venta': '<i class="fas fa-hand-holding-usd"></i>',
                    'compra': '<i class="fas fa-shopping-cart"></i>',
                    'arriendo': '<i class="fas fa-calendar-day"></i>'
                };
                return icons[operation] || '<i class="fas fa-question-circle"></i>';
            }

            getOperationShortLabel(operation) {
                const labels = {
                    'venta': 'Venta',
                    'compra': 'Compra',
                    'arriendo': 'Arriendo'
                };
                return labels[operation] || 'Sin especificar';
            }

            // ===== NOTIFICACIONES =====
            showNotification(message, type = 'info', duration = 4000, title = null) {
                const container = document.getElementById('notificationsContainer');
                if (!container) {
                    console.warn('Container de notificaciones no encontrado');
                    return;
                }

                const notificationId = `notification-${Date.now()}`;
                const notification = document.createElement('div');
                notification.id = notificationId;
                notification.className = `notification notification-${type}`;
                
                // Títulos por defecto según el tipo
                const defaultTitles = {
                    'success': 'Éxito',
                    'error': 'Error',
                    'warning': 'Advertencia',
                    'info': 'Información'
                };

                const notificationTitle = title || defaultTitles[type] || 'Notificación';
                const iconClass = this.getNotificationIcon(type);
                
                notification.innerHTML = `
                    <div class="notification-icon">
                        <i class="fas fa-${iconClass}"></i>
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">${notificationTitle}</div>
                        <div class="notification-message">${message}</div>
                    </div>
                    <button class="notification-close" onclick="crm.closeNotification('${notificationId}')">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                container.appendChild(notification);
                
                // Mostrar con animación
                setTimeout(() => {
                    notification.classList.add('show');
                }, 10);
                
                // Auto-cerrar después del tiempo especificado
                setTimeout(() => {
                    this.closeNotification(notificationId);
                }, duration);
                
                // Limitar número de notificaciones visible (máximo 5)
                const allNotifications = container.querySelectorAll('.notification');
                if (allNotifications.length > 5) {
                    const oldest = allNotifications[0];
                    this.closeNotification(oldest.id);
                }
            }

            closeNotification(notificationId) {
                const notification = document.getElementById(notificationId);
                if (!notification) return;
                
                notification.classList.add('hide');
                notification.classList.remove('show');
                
                setTimeout(() => {
                    if (notification && notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }

            getNotificationIcon(type) {
                const icons = {
                    'success': 'check-circle',
                    'error': 'times-circle',
                    'warning': 'exclamation-triangle',
                    'info': 'info-circle'
                };
                return icons[type] || 'info-circle';
            }

            // ===== MANEJO DE ERRORES DE BASE DE DATOS =====
            showDatabaseError(message) {
                console.error('💾 Error de base de datos:', message);
                
                // Crear mensaje de error específico para la UI
                const errorContainer = document.createElement('div');
                errorContainer.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(26, 26, 26, 0.95);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 99999;
                    font-family: 'Inter', sans-serif;
                `;
                
                errorContainer.innerHTML = `
                    <div style="
                        background: #2a2a2a;
                        border: 1px solid #C9A96E;
                        border-radius: 12px;
                        padding: 2rem;
                        max-width: 500px;
                        width: 90%;
                        text-align: center;
                        color: #F8F9FA;
                        box-shadow: 0 20px 25px -5px rgba(201, 169, 110, 0.1);
                    ">
                        <div style="
                            width: 64px;
                            height: 64px;
                            margin: 0 auto 1.5rem;
                            background: #E74C3C;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 1.5rem;
                            color: white;
                        ">
                            <i class="fas fa-database"></i>
                        </div>
                        
                        <h2 style="
                            margin: 0 0 1rem 0;
                            color: #F8F9FA;
                            font-size: 1.5rem;
                            font-weight: 600;
                        ">Error de Base de Datos</h2>
                        
                        <p style="
                            margin: 0 0 1.5rem 0;
                            color: #E5D5B7;
                            line-height: 1.5;
                        ">${message}</p>
                        
                        <div style="
                            background: #3a3a3a;
                            border: 1px solid #C9A96E;
                            border-radius: 8px;
                            padding: 1rem;
                            margin-bottom: 1.5rem;
                            text-align: left;
                        ">
                            <h4 style="
                                margin: 0 0 0.5rem 0;
                                color: #C9A96E;
                                font-size: 1rem;
                            ">💡 Posibles soluciones:</h4>
                            <ul style="
                                margin: 0;
                                padding-left: 1.5rem;
                                color: #E5D5B7;
                                font-size: 0.875rem;
                                line-height: 1.4;
                            ">
                                <li>Usa un navegador moderno (Chrome, Firefox, Edge, Safari)</li>
                                <li>Verifica que JavaScript esté habilitado</li>
                                <li>Limpia el caché y cookies del navegador</li>
                                <li>Cierra otras pestañas de la aplicación</li>
                                <li>Reinicia el navegador</li>
                            </ul>
                        </div>
                        
                        <button onclick="location.reload()" style="
                            background: linear-gradient(135deg, #C9A96E 0%, #B8956A 100%);
                            color: white;
                            border: none;
                            padding: 0.75rem 1.5rem;
                            border-radius: 6px;
                            font-weight: 600;
                            cursor: pointer;
                            margin-right: 0.5rem;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                            <i class="fas fa-redo"></i> Recargar Página
                        </button>
                        
                        <button onclick="window.open('https://www.google.com/chrome/', '_blank')" style="
                            background: transparent;
                            color: #C9A96E;
                            border: 1px solid #C9A96E;
                            padding: 0.75rem 1.5rem;
                            border-radius: 6px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.background='rgba(201, 169, 110, 0.1)'" onmouseout="this.style.background='transparent'">
                            <i class="fas fa-download"></i> Descargar Chrome
                        </button>
                    </div>
                `;
                
                document.body.appendChild(errorContainer);
            }

            // ===== RESPONSIVE =====
            checkResponsive() {
                this.isMobile = window.innerWidth <= 768;
                // Ya no modificamos automáticamente la visibilidad del sidebar
                // El usuario tiene control total a través del botón hamburguesa
            }

            // ===== GESTIÓN DE PROSPECTOS =====
            async showAddProspectModal() {
                this.resetProspectModal();
                this.openModal('prospectModal');
            }

            async handleProspectSubmit(e) {
                e.preventDefault();
                
                try {
                    const formData = {
                        name: document.getElementById('prospectName').value,
                        email: document.getElementById('prospectEmail').value,
                        phone: document.getElementById('prospectPhone').value,
                        source: document.getElementById('prospectSource').value,
                        status: document.getElementById('prospectStatus').value,
                        notes: document.getElementById('prospectNotes').value,
                        createdAt: new Date().toISOString()
                    };

                    if (this.editingProspectId) {
                        // Modo edición
                        await this.updateData('prospects', this.editingProspectId, formData);
                        this.showNotification('Prospecto actualizado exitosamente', 'success');
                        this.editingProspectId = null; // Limpiar el ID de edición
                    } else {
                        // Modo creación
                        await this.addData('prospects', formData);
                        this.showNotification('Prospecto agregado exitosamente', 'success');
                    }

                    await this.loadInitialData();
                    this.closeModal('prospectModal');
                    
                    // Resetear el modal para próximo uso
                    this.resetProspectModal();
                } catch (error) {
                    console.error('Error guardando prospecto:', error);
                    this.showNotification('Error al guardar prospecto', 'error');
                }
            }

            loadProspectsTable(prospects) {
                const tbody = document.querySelector('#prospectsTable tbody');
                
                if (prospects.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7">
                                <div class="empty-state">
                                    <i class="fas fa-user-plus"></i>
                                    <h3>No hay prospectos registrados</h3>
                                    <p>Agrega tu primer prospecto para comenzar</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = prospects.map(prospect => `
                    <tr>
                        <td><i class="fas fa-user"></i> ${prospect.name}</td>
                        <td><a href="mailto:${prospect.email}" style="color: var(--primary);"><i class="fas fa-envelope"></i> ${prospect.email}</a></td>
                        <td><a href="tel:${prospect.phone}" style="color: var(--primary);"><i class="fas fa-phone"></i> ${prospect.phone}</a></td>
                        <td><span class="badge">${prospect.source}</span></td>
                        <td><span class="status-badge status-${prospect.status.toLowerCase().replace(/\s+/g, '').replace('á', 'a').replace('ó', 'o')}">${prospect.status}</span></td>
                        <td>${this.formatDate(prospect.createdAt)}</td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="crm.editProspect(${prospect.id})" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="crm.deleteProspect(${prospect.id})" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            async deleteProspect(id) {
                try {
                    const prospects = await this.getData('prospects');
                    const prospect = prospects.find(p => p.id === id);
                    
                    if (!prospect) {
                        this.showNotification('Prospecto no encontrado', 'error');
                        return;
                    }
                    
                    this.showConfirmationModal('prospect', prospect, async () => {
                        try {
                            await this.deleteData('prospects', id);
                            await this.loadInitialData();
                            this.showNotification(`Prospecto eliminado: ${prospect.name || 'Sin nombre'}`, 'success', 5000);
                        } catch (error) {
                            console.error('Error eliminando prospecto:', error);
                            this.showNotification('Error al eliminar el prospecto', 'error');
                        }
                    });
                } catch (error) {
                    console.error('Error obteniendo prospecto:', error);
                    this.showNotification('Error al obtener información del prospecto', 'error');
                }
            }

            async editProspect(id) {
                try {
                    // Obtener los datos del prospecto
                    const prospects = await this.getData('prospects');
                    const prospect = prospects.find(p => p.id === id);
                    
                    if (!prospect) {
                        this.showNotification('Prospecto no encontrado', 'error');
                        return;
                    }

                    // Llenar el formulario con los datos existentes
                    document.getElementById('prospectName').value = prospect.name || '';
                    document.getElementById('prospectEmail').value = prospect.email || '';
                    document.getElementById('prospectPhone').value = prospect.phone || '';
                    document.getElementById('prospectSource').value = prospect.source || '';
                    document.getElementById('prospectStatus').value = prospect.status || 'Nuevo';
                    document.getElementById('prospectNotes').value = prospect.notes || '';

                    // Cambiar el título y el botón del modal
                    document.querySelector('#prospectModal .modal-title').textContent = 'Editar Prospecto';
                    const submitBtn = document.querySelector('#prospectForm button[type="submit"]');
                    submitBtn.innerHTML = '<i class="fas fa-save"></i> Actualizar Prospecto';

                    // Guardar el ID del prospecto que se está editando
                    this.editingProspectId = id;

                    // Mostrar el modal
                    this.openModal('prospectModal');
                    
                    this.showNotification('Editando prospecto', 'info', 2000);
                } catch (error) {
                    console.error('Error al editar prospecto:', error);
                    this.showNotification('Error al cargar datos del prospecto', 'error');
                }
            }

            // ===== GESTIÓN DE CALENDARIO Y CITAS =====
            async showAddAppointmentModal() {
                try {
                    const [clients, properties] = await Promise.all([
                        this.getData('clients'),
                        this.getData('properties')
                    ]);

                    // Llenar select de clientes con información más detallada
                    const clientSelect = document.getElementById('appointmentClient');
                    clientSelect.innerHTML = '<option value="">Seleccionar cliente</option>' +
                        clients.map(c => `<option value="${c.id}" data-email="${c.email || ''}" data-phone="${c.phone || ''}">${c.name} - ${c.email || ''}</option>`).join('');

                    // Llenar select de propiedades con información más detallada
                    const propertySelect = document.getElementById('appointmentProperty');
                    const availableProperties = properties.filter(p => {
                        const status = (p.status || '').toLowerCase();
                        return status === 'disponible' || status === 'available' || status === '';
                    });
                    
                    propertySelect.innerHTML = '<option value="">Seleccionar propiedad (opcional)</option>' +
                        availableProperties.map(p => `<option value="${p.id}" data-price="${p.price || 0}">${p.type || 'Sin tipo'} - ${p.address || 'Sin dirección'} - $${(p.price || 0).toLocaleString()}</option>`).join('');

                    console.log(`👥 ${clients.length} clientes y 🏠 ${availableProperties.length} propiedades disponibles cargadas`);

                    // Establecer fecha mínima como hoy
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('appointmentDate').min = today;
                    document.getElementById('appointmentDate').value = today;

                    this.openModal('appointmentModal');
                } catch (error) {
                    console.error('Error preparando modal de cita:', error);
                    this.showNotification('Error preparando formulario', 'error');
                }
            }

            async handleAppointmentSubmit(e) {
                e.preventDefault();
                
                try {
                    const clientSelect = document.getElementById('appointmentClient');
                    const propertySelect = document.getElementById('appointmentProperty');
                    const clientOption = clientSelect.selectedOptions[0];
                    const propertyOption = propertySelect.selectedOptions[0];
                    
                    const formData = {
                        title: document.getElementById('appointmentTitle').value.trim(),
                        clientId: clientSelect.value ? parseInt(clientSelect.value) : null,
                        clientName: clientOption && clientSelect.value ? clientOption.textContent.split(' - ')[0] : 'Cita general',
                        clientEmail: clientOption && clientSelect.value ? clientOption.getAttribute('data-email') || '' : '',
                        clientPhone: clientOption && clientSelect.value ? clientOption.getAttribute('data-phone') || '' : '',
                        propertyId: propertySelect.value ? parseInt(propertySelect.value) : null,
                        propertyInfo: propertyOption ? propertyOption.textContent : null,
                        date: document.getElementById('appointmentDate').value,
                        time: document.getElementById('appointmentTime').value,
                        type: document.getElementById('appointmentType').value,
                        reminder: parseInt(document.getElementById('appointmentReminder').value) || 30,
                        description: document.getElementById('appointmentDescription').value.trim(),
                        status: 'Programada'
                    };

                    // Validación mejorada - cliente ya no es obligatorio
                    if (!formData.title || !formData.date || !formData.time || !formData.type) {
                        this.showNotification('⚠️ Complete los campos obligatorios: título, fecha, hora y tipo de cita', 'warning');
                        return;
                    }

                    // Crear fecha y hora completa
                    const appointmentDateTime = new Date(`${formData.date}T${formData.time}`);
                    formData.datetime = appointmentDateTime.toISOString();

                    // Verificar si es edición o creación
                    if (this.editingAppointmentId) {
                        // Es edición - mantener algunos campos originales
                        const originalAppointment = this.appointments.find(apt => apt.id === this.editingAppointmentId);
                        formData.dateAdded = originalAppointment?.dateAdded || new Date().toISOString();
                        formData.createdAt = originalAppointment?.createdAt || new Date().toISOString();
                        formData.updatedAt = new Date().toISOString();
                        
                        await this.updateData('appointments', this.editingAppointmentId, formData);
                        this.showNotification('Cita actualizada exitosamente', 'success');
                        
                        // Limpiar flag de edición
                        this.editingAppointmentId = null;
                        
                        // Restaurar título del modal
                        const modalTitle = document.querySelector('#appointmentModal .modal-title');
                        const submitButton = document.querySelector('#appointmentModal .btn-primary');
                        if (modalTitle) modalTitle.textContent = 'Nueva Cita';
                        if (submitButton) submitButton.textContent = 'Programar Cita';
                    } else {
                        // Es creación nueva
                        formData.dateAdded = new Date().toISOString();
                        formData.createdAt = new Date().toISOString();
                        
                        await this.addData('appointments', formData);
                        this.showNotification('Cita programada exitosamente', 'success');
                        
                        // Programar recordatorio solo para citas nuevas
                        this.scheduleReminder(formData);
                    }

                    await this.loadCalendarData();
                    this.closeModal('appointmentModal');
                    
                } catch (error) {
                    console.error('Error procesando cita:', error);
                    this.showNotification('Error al procesar la cita', 'error');
                }
            }

            async loadCalendarData() {
                try {
                    this.appointments = await this.getData('appointments');
                    this.renderCalendar();
                    this.loadTodayAppointments();
                    this.loadAppointmentsTable();
                } catch (error) {
                    console.error('Error cargando datos del calendario:', error);
                }
            }

            async loadProspectsData() {
                try {
                    const prospects = await this.getData('prospects');
                    this.loadProspectsTable(prospects);
                    console.log('📊 Datos de prospectos cargados:', prospects.length);
                } catch (error) {
                    console.error('Error cargando datos de prospectos:', error);
                    this.loadProspectsTable([]);
                }
            }

            renderCalendar() {
                const calendarGrid = document.getElementById('calendarGrid');
                const calendarTitle = document.getElementById('calendarTitle');
                
                if (!calendarGrid || !calendarTitle) return;

                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();
                
                calendarTitle.textContent = `${this.getMonthName(month)} ${year}`;

                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startingDayOfWeek = firstDay.getDay();

                let html = '';

                // Encabezados de días de la semana
                const dayHeaders = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
                dayHeaders.forEach(day => {
                    html += `<div class="calendar-header-day">${day}</div>`;
                });

                // Días del mes anterior (grises)
                const prevMonth = new Date(year, month - 1, 0);
                for (let i = startingDayOfWeek - 1; i >= 0; i--) {
                    const day = prevMonth.getDate() - i;
                    const prevMonthNum = month === 0 ? 11 : month - 1;
                    const prevYear = month === 0 ? year - 1 : year;
                    const dateStr = `${prevYear}-${String(prevMonthNum + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    html += `<div class="calendar-day other-month" data-date="${dateStr}">
                        <div class="calendar-day-number">${day}</div>
                    </div>`;
                }

                // Días del mes actual
                const today = new Date();
                for (let day = 1; day <= daysInMonth; day++) {
                    const currentDay = new Date(year, month, day);
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const isToday = currentDay.toDateString() === today.toDateString();
                    const dayAppointments = this.appointments ? 
                        this.appointments.filter(apt => apt.date === dateStr && (!this.currentFilter || apt.type === this.currentFilter)) : [];
                    
                    let dayClass = 'calendar-day';
                    if (isToday) dayClass += ' today';

                    html += `<div class="${dayClass}" data-date="${dateStr}" onclick="crm.selectCalendarDay('${dateStr}')">
                        <div class="calendar-day-number">${day}</div>
                        ${dayAppointments.map(apt => {
                            const typeColor = this.getAppointmentTypeColor(apt.type);
                            const typeIcon = this.getAppointmentTypeIcon(apt.type);
                            return `<div class="calendar-appointment" style="background: ${typeColor};" title="${apt.type}: ${apt.title} - ${apt.time}">${typeIcon} ${apt.title}</div>`;
                        }).join('')}
                    </div>`;
                }

                // Días del mes siguiente (grises) - Solo llenar hasta completar la grilla
                const totalCells = startingDayOfWeek + daysInMonth;
                const remainingCells = Math.ceil(totalCells / 7) * 7 - totalCells;
                const nextMonth = month === 11 ? 0 : month + 1;
                const nextYear = month === 11 ? year + 1 : year;
                
                for (let day = 1; day <= remainingCells && day <= 14; day++) {
                    const dateStr = `${nextYear}-${String(nextMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    html += `<div class="calendar-day other-month" data-date="${dateStr}">
                        <div class="calendar-day-number">${day}</div>
                    </div>`;
                }

                calendarGrid.innerHTML = html;
                
                // Auto-seleccionar el día de hoy si estamos en el mes actual
                if (year === today.getFullYear() && month === today.getMonth()) {
                    const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                    setTimeout(() => this.selectCalendarDay(todayStr), 100);
                }
            }

            selectCalendarDay(dateStr) {
                try {
                    // Remover selección anterior
                    document.querySelectorAll('.calendar-day').forEach(day => {
                        day.classList.remove('selected');
                    });
                    
                    // Agregar selección actual
                    const dayElement = document.querySelector(`[data-date="${dateStr}"]`);
                    if (dayElement) {
                        dayElement.classList.add('selected');
                    }
                    
                    this.selectedDate = new Date(dateStr);
                    this.loadSelectedDayAppointments(dateStr);
                } catch (error) {
                    console.error('Error seleccionando día del calendario:', error);
                }
            }

            // Funciones para colores e iconos de tipos de cita
            getAppointmentTypeColor(type) {
                const colors = {
                    'Venta': '#E74C3C',       // Rojo para ventas
                    'Compra': '#2ECC71',      // Verde para compras  
                    'Arriendo': '#F39C12',    // Naranja para arriendos
                    'Visita': '#3498DB',      // Azul para visitas
                    'Reunion': '#C9A96E',     // Dorado para reuniones
                    'Llamada': '#9B59B6',     // Púrpura para llamadas
                    'Firma': '#1ABC9C',       // Turquesa para firmas
                    'Consulta': '#95A5A6'     // Gris para consultas
                };
                return colors[type] || '#C9A96E';
            }

            getAppointmentTypeIcon(type) {
                const icons = {
                    'Venta': '🏠',
                    'Compra': '💰',
                    'Arriendo': '📅',
                    'Visita': '👀',
                    'Reunion': '🤝',
                    'Llamada': '📞',
                    'Firma': '✒️',
                    'Consulta': '💬'
                };
                return icons[type] || '📌';
            }

            loadSelectedDayAppointments(dateStr) {
                const container = document.getElementById('todayAppointments');
                if (!container) return;

                const appointments = this.appointments ? this.appointments.filter(apt => apt.date === dateStr) : [];
                
                if (appointments.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-calendar-alt"></i>
                            <h3>Sin citas</h3>
                            <p>No hay citas para este día</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = appointments.map(apt => {
                    const typeColor = this.getAppointmentTypeColor(apt.type);
                    const typeIcon = this.getAppointmentTypeIcon(apt.type);
                    return `
                    <div class="appointment-item" style="border-left: 4px solid ${typeColor};">
                        <div class="appointment-type" style="color: ${typeColor}; font-weight: 600; margin-bottom: 0.5rem;">
                            ${typeIcon} ${apt.type}
                        </div>
                        <div class="appointment-time"><i class="fas fa-clock"></i> ${apt.time}</div>
                        <div class="appointment-title">${apt.title}</div>
                        <div class="appointment-client"><i class="fas fa-user"></i> ${apt.clientName}</div>
                        ${apt.propertyInfo ? `<div class="appointment-property"><i class="fas fa-home"></i> ${apt.propertyInfo}</div>` : ''}
                    </div>
                    `;
                }).join('');
            }

            loadTodayAppointments() {
                const today = new Date().toISOString().split('T')[0];
                this.loadSelectedDayAppointments(today);
            }

            loadAppointmentsTable() {
                const tbody = document.querySelector('#appointmentsTable tbody');
                
                if (!tbody) return; // Si no existe la tabla, salir
                
                if (this.appointments.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7">
                                <div class="empty-state">
                                    <i class="fas fa-calendar-alt"></i>
                                    <h3>No hay citas programadas</h3>
                                    <p>Programa tu primera cita para comenzar</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = this.appointments
                    .sort((a, b) => new Date(a.datetime) - new Date(b.datetime))
                    .map(appointment => `
                        <tr>
                            <td>${this.formatDate(appointment.date)} ${appointment.time}</td>
                            <td><i class="fas fa-user"></i> ${appointment.clientName}</td>
                            <td>${appointment.propertyInfo || 'N/A'}</td>
                            <td>${appointment.type}</td>
                            <td><span class="status-badge status-${appointment.status.toLowerCase()}">${appointment.status}</span></td>
                            <td>${appointment.reminder} min antes</td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="crm.editAppointment(${appointment.id})" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="crm.deleteAppointment(${appointment.id})" title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
            }

            changeMonth(direction) {
                this.currentDate.setMonth(this.currentDate.getMonth() + direction);
                this.renderCalendar();
                
                // Limpiar selección al cambiar de mes
                const container = document.getElementById('todayAppointments');
                if (container) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-calendar-alt"></i>
                            <h3>Selecciona un día</h3>
                            <p>Haz clic en cualquier día para ver las citas</p>
                        </div>
                    `;
                }
            }

            goToToday() {
                this.currentDate = new Date();
                this.selectedDate = new Date();
                this.renderCalendar();
                
                // Auto-seleccionar el día de hoy
                const today = new Date();
                const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                setTimeout(() => this.selectCalendarDay(todayStr), 200);
            }

            // ===== NUEVAS FUNCIONES DEL CALENDARIO =====
            filterAppointmentsByType(type) {
                this.currentFilter = type;
                this.renderCalendar();
                console.log('🔍 Filtro aplicado:', type || 'Todos');
                
                // Mostrar notificación
                const message = type ? `Mostrando solo citas de: ${type}` : 'Mostrando todas las citas';
                this.showNotification(message, 'info', 3000);
            }

            changeCalendarView(view) {
                this.currentView = view;
                console.log('👁️ Vista cambiada a:', view);
                
                switch (view) {
                    case 'month':
                        this.renderCalendar();
                        break;
                    case 'week':
                        this.renderWeekView();
                        break;
                    case 'agenda':
                        this.renderAgendaView();
                        break;
                }
            }

            renderWeekView() {
                const calendarGrid = document.getElementById('calendarGrid');
                if (!calendarGrid) return;

                const today = new Date();
                const startOfWeek = new Date(today);
                startOfWeek.setDate(today.getDate() - today.getDay());

                let html = `
                    <div class="week-view">
                        <div class="week-header">
                            <h4>Semana del ${startOfWeek.toLocaleDateString('es-ES')}</h4>
                        </div>
                        <div class="week-grid">
                `;

                for (let i = 0; i < 7; i++) {
                    const currentDay = new Date(startOfWeek);
                    currentDay.setDate(startOfWeek.getDate() + i);
                    const dateStr = currentDay.toISOString().split('T')[0];
                    const dayName = currentDay.toLocaleDateString('es-ES', { weekday: 'long' });
                    
                    const dayAppointments = this.appointments ? 
                        this.appointments.filter(apt => apt.date === dateStr && (!this.currentFilter || apt.type === this.currentFilter)) : [];

                    html += `
                        <div class="week-day ${currentDay.toDateString() === today.toDateString() ? 'today' : ''}" onclick="crm.selectCalendarDay('${dateStr}')">
                            <div class="week-day-header">
                                <div class="day-name">${dayName}</div>
                                <div class="day-number">${currentDay.getDate()}</div>
                            </div>
                            <div class="week-appointments">
                                ${dayAppointments.slice(0, 3).map(apt => {
                                    const color = this.getAppointmentTypeColor(apt.type);
                                    return `<div class="week-appointment" style="background: ${color};" title="${apt.type}: ${apt.title} - ${apt.time}">${apt.time} ${apt.title}</div>`;
                                }).join('')}
                                ${dayAppointments.length > 3 ? `<div class="more-appointments">+${dayAppointments.length - 3} más</div>` : ''}
                            </div>
                        </div>
                    `;
                }

                html += `
                        </div>
                    </div>
                    
                    <style>
                        .week-view { padding: 1rem; }
                        .week-header { text-align: center; margin-bottom: 1rem; }
                        .week-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--border); border-radius: 8px; overflow: hidden; }
                        .week-day { background: var(--bg-card); min-height: 120px; cursor: pointer; transition: var(--transition); }
                        .week-day:hover { background: var(--bg-tertiary); }
                        .week-day.today { background: rgba(201, 169, 110, 0.2); }
                        .week-day-header { padding: 0.5rem; border-bottom: 1px solid var(--border); text-align: center; }
                        .day-name { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; }
                        .day-number { font-weight: 600; color: var(--text-primary); }
                        .week-appointments { padding: 0.5rem; }
                        .week-appointment { font-size: 0.7rem; padding: 2px 4px; margin-bottom: 2px; border-radius: 3px; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
                        .more-appointments { font-size: 0.7rem; color: var(--text-muted); text-align: center; }
                    </style>
                `;

                calendarGrid.innerHTML = html;
            }

            renderAgendaView() {
                const calendarGrid = document.getElementById('calendarGrid');
                if (!calendarGrid) return;

                // Obtener citas de los próximos 30 días
                const today = new Date();
                const upcomingAppointments = [];
                
                for (let i = 0; i < 30; i++) {
                    const checkDate = new Date(today);
                    checkDate.setDate(today.getDate() + i);
                    const dateStr = checkDate.toISOString().split('T')[0];
                    
                    const dayAppointments = this.appointments ? 
                        this.appointments.filter(apt => apt.date === dateStr && (!this.currentFilter || apt.type === this.currentFilter)) : [];
                    
                    dayAppointments.forEach(apt => {
                        upcomingAppointments.push({
                            ...apt,
                            dateObj: checkDate
                        });
                    });
                }

                upcomingAppointments.sort((a, b) => {
                    const dateCompare = a.dateObj - b.dateObj;
                    if (dateCompare !== 0) return dateCompare;
                    return a.time.localeCompare(b.time);
                });

                let html = `
                    <div class="agenda-view">
                        <div class="agenda-header">
                            <h4>Próximas Citas (30 días)</h4>
                            <p style="color: var(--text-muted); font-size: 0.875rem;">${upcomingAppointments.length} citas programadas</p>
                        </div>
                        <div class="agenda-list">
                `;

                if (upcomingAppointments.length === 0) {
                    html += `
                        <div class="empty-state">
                            <i class="fas fa-calendar-check"></i>
                            <h3>No hay citas próximas</h3>
                            <p>Tu agenda está libre para los próximos 30 días</p>
                        </div>
                    `;
                } else {
                    let currentDate = '';
                    upcomingAppointments.forEach(apt => {
                        const dateStr = apt.dateObj.toLocaleDateString('es-ES', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        });
                        
                        if (currentDate !== dateStr) {
                            currentDate = dateStr;
                            html += `<div class="agenda-date-header">${dateStr}</div>`;
                        }
                        
                        const typeColor = this.getAppointmentTypeColor(apt.type);
                        const typeIcon = this.getAppointmentTypeIcon(apt.type);
                        
                        html += `
                            <div class="agenda-item" style="border-left: 4px solid ${typeColor};">
                                <div class="agenda-item-header">
                                    <span class="agenda-time">${apt.time}</span>
                                    <span class="agenda-type" style="color: ${typeColor};">${typeIcon} ${apt.type}</span>
                                </div>
                                <div class="agenda-title">${apt.title}</div>
                                <div class="agenda-client">👤 ${apt.clientName}</div>
                                ${apt.propertyInfo ? `<div class="agenda-property">🏠 ${apt.propertyInfo}</div>` : ''}
                            </div>
                        `;
                    });
                }

                html += `
                        </div>
                    </div>
                    
                    <style>
                        .agenda-view { padding: 1rem; }
                        .agenda-header { text-align: center; margin-bottom: 1.5rem; }
                        .agenda-list { max-height: 400px; overflow-y: auto; }
                        .agenda-date-header { font-weight: 600; color: var(--primary); padding: 1rem 0 0.5rem 0; border-top: 1px solid var(--border); margin-top: 1rem; text-transform: capitalize; }
                        .agenda-date-header:first-child { border-top: none; margin-top: 0; }
                        .agenda-item { background: var(--bg-tertiary); border-radius: 8px; padding: 1rem; margin-bottom: 0.5rem; transition: var(--transition); }
                        .agenda-item:hover { background: var(--bg-secondary); }
                        .agenda-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
                        .agenda-time { font-weight: 600; color: var(--text-primary); }
                        .agenda-type { font-size: 0.875rem; font-weight: 500; }
                        .agenda-title { font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem; }
                        .agenda-client, .agenda-property { font-size: 0.875rem; color: var(--text-secondary); }
                    </style>
                `;

                calendarGrid.innerHTML = html;
            }

            exportCalendar() {
                try {
                    const currentMonth = this.currentDate.getMonth();
                    const currentYear = this.currentDate.getFullYear();
                    const monthName = this.getMonthName(currentMonth);
                    
                    const monthAppointments = this.appointments ? 
                        this.appointments.filter(apt => {
                            const aptDate = new Date(apt.date);
                            return aptDate.getMonth() === currentMonth && aptDate.getFullYear() === currentYear;
                        }).sort((a, b) => {
                            const dateCompare = a.date.localeCompare(b.date);
                            if (dateCompare !== 0) return dateCompare;
                            return a.time.localeCompare(b.time);
                        }) : [];

                    const exportContent = `# CALENDARIO DE CITAS CRM AJHB - ${monthName} ${currentYear}
**Exportado el:** ${new Date().toLocaleDateString('es-ES')} a las ${new Date().toLocaleTimeString('es-ES')}

## RESUMEN
- **Total de Citas:** ${monthAppointments.length}
- **Período:** ${monthName} ${currentYear}

## DETALLE DE CITAS
${monthAppointments.length > 0 ? monthAppointments.map((apt, index) => `
${index + 1}. **${apt.title}**
   - Tipo: ${apt.type}
   - Fecha: ${new Date(apt.date).toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
   - Hora: ${apt.time}
   - Cliente: ${apt.clientName}${apt.propertyInfo ? `\n   - Propiedad: ${apt.propertyInfo}` : ''}
   - Notas: ${apt.notes || 'Sin notas'}
`).join('') : 'No hay citas programadas para este período.'}

---
*Calendario exportado desde CRM AJHB*
*Sistema Inmobiliario Profesional*
                    `;

                    // Crear y descargar archivo
                    const blob = new Blob([exportContent], { type: 'text/plain;charset=utf-8' });
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    
                    const fileName = `Calendario_${monthName}_${currentYear}.txt`;
                    link.download = fileName;
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);

                    this.showNotification(`Calendario exportado: ${fileName}`, 'success', 4000);
                    console.log('📤 Calendario exportado:', fileName);

                } catch (error) {
                    console.error('Error exportando calendario:', error);
                    this.showNotification('Error al exportar el calendario', 'error');
                }
            }

            getMonthName(month) {
                const months = [
                    'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                    'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
                ];
                return months[month];
            }

            async deleteAppointment(id) {
                try {
                    const appointments = await this.getData('appointments');
                    const appointment = appointments.find(a => a.id === id);
                    
                    if (!appointment) {
                        this.showNotification('Cita no encontrada', 'error');
                        return;
                    }
                    
                    this.showConfirmationModal('appointment', appointment, async () => {
                        try {
                            await this.deleteData('appointments', id);
                            await this.loadCalendarData();
                            this.showNotification(`Cita cancelada: ${appointment.clientName || 'Sin cliente'}`, 'success', 5000);
                        } catch (error) {
                            console.error('Error eliminando cita:', error);
                            this.showNotification('Error al cancelar la cita', 'error');
                        }
                    });
                } catch (error) {
                    console.error('Error obteniendo cita:', error);
                    this.showNotification('Error al obtener información de la cita', 'error');
                }
            }

            async editAppointment(id) {
                try {
                    const appointment = this.appointments.find(apt => apt.id === id);
                    if (!appointment) {
                        this.showNotification('Cita no encontrada', 'error');
                        return;
                    }

                    // Cargar datos necesarios
                    const [clients, properties] = await Promise.all([
                        this.getData('clients'),
                        this.getData('properties')
                    ]);

                    // Llenar select de clientes
                    const clientSelect = document.getElementById('appointmentClient');
                    clientSelect.innerHTML = '<option value="">Seleccionar cliente</option>' +
                        clients.map(c => `<option value="${c.id}" data-email="${c.email || ''}" data-phone="${c.phone || ''}" ${c.id === appointment.clientId ? 'selected' : ''}>${c.name} - ${c.email || ''}</option>`).join('');

                    // Llenar select de propiedades
                    const propertySelect = document.getElementById('appointmentProperty');
                    const availableProperties = properties.filter(p => {
                        const status = (p.status || '').toLowerCase();
                        return status === 'disponible' || status === 'available' || status === '' || p.id === appointment.propertyId;
                    });
                    
                    propertySelect.innerHTML = '<option value="">Seleccionar propiedad (opcional)</option>' +
                        availableProperties.map(p => `<option value="${p.id}" data-price="${p.price || 0}" ${p.id === appointment.propertyId ? 'selected' : ''}>${p.type || 'Sin tipo'} - ${p.address || 'Sin dirección'} - $${(p.price || 0).toLocaleString()}</option>`).join('');

                    // Llenar formulario con datos existentes
                    document.getElementById('appointmentTitle').value = appointment.title || '';
                    document.getElementById('appointmentDate').value = appointment.date || '';
                    document.getElementById('appointmentTime').value = appointment.time || '';
                    document.getElementById('appointmentType').value = appointment.type || '';
                    document.getElementById('appointmentReminder').value = appointment.reminder || 30;
                    document.getElementById('appointmentDescription').value = appointment.description || '';

                    // Cambiar el título del modal y el botón
                    const modalTitle = document.querySelector('#appointmentModal .modal-title');
                    const submitButton = document.querySelector('#appointmentModal .btn-primary');
                    
                    if (modalTitle) modalTitle.textContent = 'Editar Cita';
                    if (submitButton) submitButton.textContent = 'Actualizar Cita';

                    // Marcar como edición
                    this.editingAppointmentId = id;

                    this.openModal('appointmentModal');
                } catch (error) {
                    console.error('Error cargando datos para edición:', error);
                    this.showNotification('Error preparando formulario de edición', 'error');
                }
            }

            // ===== SISTEMA DE RECORDATORIOS =====
            scheduleReminder(appointment) {
                const appointmentTime = new Date(appointment.datetime);
                const reminderTime = new Date(appointmentTime.getTime() - (appointment.reminder * 60 * 1000));
                const now = new Date();

                if (reminderTime > now) {
                    const timeUntilReminder = reminderTime.getTime() - now.getTime();
                    
                    setTimeout(() => {
                        this.showReminder(appointment);
                    }, timeUntilReminder);
                }
            }

            showReminder(appointment) {
                this.showNotification(
                    `Recordatorio: ${appointment.title} con ${appointment.clientName} a las ${appointment.time}`,
                    'warning',
                    10000
                );

                // Opcional: mostrar notificación del navegador
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification('Recordatorio de Cita', {
                        body: `${appointment.title} con ${appointment.clientName} a las ${appointment.time}`,
                        icon: '/favicon.ico'
                    });
                }
            }

            // Actualizar loadInitialData para incluir nuevas entidades
            async loadInitialData() {
                try {
                    console.log('📊 Cargando datos iniciales...');
                    
                    const [properties, clients, contracts, prospects, appointments] = await Promise.all([
                        this.getData('properties'),
                        this.getData('clients'),
                        this.getData('contracts'),
                        this.getData('prospects'),
                        this.getData('appointments')
                    ]);

                    this.appointments = appointments || [];
                    this.updateDashboardStats(properties || [], clients || [], contracts || [], appointments || []);
                    this.loadTables(properties || [], clients || [], contracts || []);
                    this.loadProspectsTable(prospects || []);
                    
                    // Cargar datos del calendario si estamos en esa sección
                    if (this.currentSection === 'calendar') {
                        this.loadCalendarData();
                    }
                    
                    console.log(`📊 Datos cargados exitosamente: ${properties?.length || 0} propiedades, ${clients?.length || 0} clientes, ${contracts?.length || 0} contratos, ${prospects?.length || 0} prospectos, ${appointments?.length || 0} citas`);
                } catch (error) {
                    console.error('❌ Error cargando datos:', error);
                    // No mostrar notificaciones de error para evitar spam - solo log en consola
                }
            }

            // ===== SISTEMA DE ANÁLISIS DE ESTADÍSTICAS =====
            
            // Análisis de propiedades
            analyzePropertyStats(properties) {
                const stats = {
                    total: properties.length,
                    available: 0,
                    reserved: 0,
                    sold: 0,
                    inProcess: 0,
                    totalValue: 0,
                    totalRevenue: 0,
                    reservedValue: 0,
                    avgPrice: 0,
                    priceRange: { min: Infinity, max: 0 },
                    typeDistribution: {},
                    locationDistribution: {}
                };

                properties.forEach(property => {
                    const price = property.price || 0;
                    const status = (property.status || 'disponible').toLowerCase();
                    const type = property.type || 'Sin especificar';
                    const location = property.location || 'Sin ubicación';

                    stats.totalValue += price;

                    // Análisis por estado con lógica neuronal
                    switch (status) {
                        case 'disponible':
                        case 'available':
                            stats.available++;
                            break;
                        case 'reservada':
                        case 'reserved':
                            stats.reserved++;
                            stats.reservedValue += price;
                            break;
                        case 'vendida':
                        case 'vendido':
                        case 'sold':
                            stats.sold++;
                            stats.totalRevenue += price;
                            break;
                        case 'en-proceso':
                        case 'in-process':
                            stats.inProcess++;
                            break;
                    }

                    // Rango de precios
                    if (price > 0) {
                        stats.priceRange.min = Math.min(stats.priceRange.min, price);
                        stats.priceRange.max = Math.max(stats.priceRange.max, price);
                    }

                    // Distribución por tipo
                    stats.typeDistribution[type] = (stats.typeDistribution[type] || 0) + 1;

                    // Distribución por ubicación
                    stats.locationDistribution[location] = (stats.locationDistribution[location] || 0) + 1;
                });

                stats.avgPrice = stats.total > 0 ? stats.totalValue / stats.total : 0;
                if (stats.priceRange.min === Infinity) stats.priceRange.min = 0;

                return stats;
            }

            // Análisis neuronal de clientes con patrones de comportamiento
            // Análisis de clientes
            analyzeClientStats(clients) {
                const stats = {
                    total: clients.length,
                    active: 0,
                    withContracts: 0,
                    withAppointments: 0,
                    potentialBuyers: 0,
                    interestAreas: {},
                    contactMethods: {},
                    recentActivity: 0
                };

                const oneMonthAgo = new Date();
                oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);

                clients.forEach(client => {
                    const createdDate = new Date(client.createdAt || client.dateAdded);
                    const isRecent = createdDate > oneMonthAgo;

                    if (isRecent) stats.recentActivity++;
                    
                    // Análisis de estado del cliente
                    const status = (client.status || '').toLowerCase();
                    if (status === 'activo' || !status || status === 'active') {
                        stats.active++;
                    }

                    // Intereses del cliente
                    if (client.interests) {
                        const interests = client.interests.split(',').map(i => i.trim());
                        interests.forEach(interest => {
                            stats.interestAreas[interest] = (stats.interestAreas[interest] || 0) + 1;
                        });
                    }

                    // Método de contacto preferido
                    const contactMethod = client.preferredContact || 'email';
                    stats.contactMethods[contactMethod] = (stats.contactMethods[contactMethod] || 0) + 1;
                });

                return stats;
            }

            // Análisis neuronal de contratos con métricas de rendimiento
            // Análisis de contratos
            analyzeContractStats(contracts) {
                const stats = {
                    total: contracts.length,
                    sales: 0,
                    reservations: 0,
                    active: 0,
                    completed: 0,
                    avgDealTime: 0,
                    minDealTime: Infinity,
                    maxDealTime: 0,
                    totalValue: 0,
                    avgValue: 0,
                    conversionRate: 0,
                    monthlyTrend: {}
                };

                let totalDealTime = 0;
                const now = new Date();

                contracts.forEach(contract => {
                    const contractType = (contract.type || 'general').toLowerCase();
                    const value = contract.value || contract.price || 0;
                    const createdDate = new Date(contract.createdAt);
                    const dealTime = Math.ceil((now - createdDate) / (1000 * 60 * 60 * 24));

                    stats.totalValue += value;
                    totalDealTime += dealTime;

                    // Tipo de contrato
                    if (contractType.includes('venta') || contractType.includes('sale')) {
                        stats.sales++;
                    } else if (contractType.includes('reserva') || contractType.includes('reservation')) {
                        stats.reservations++;
                    }

                    // Estado del contrato
                    const status = (contract.status || 'activo').toLowerCase();
                    if (status === 'activo' || status === 'active') {
                        stats.active++;
                    } else if (status === 'completado' || status === 'completed') {
                        stats.completed++;
                    }

                    // Tiempo de cierre
                    stats.minDealTime = Math.min(stats.minDealTime, dealTime);
                    stats.maxDealTime = Math.max(stats.maxDealTime, dealTime);

                    // Tendencia mensual
                    const monthKey = `${createdDate.getFullYear()}-${String(createdDate.getMonth() + 1).padStart(2, '0')}`;
                    stats.monthlyTrend[monthKey] = (stats.monthlyTrend[monthKey] || 0) + 1;
                });

                stats.avgDealTime = stats.total > 0 ? Math.round(totalDealTime / stats.total) : 0;
                stats.avgValue = stats.total > 0 ? stats.totalValue / stats.total : 0;
                if (stats.minDealTime === Infinity) stats.minDealTime = 0;

                return stats;
            }

            // Análisis neuronal de citas con patrones de actividad
            // Análisis de citas
            analyzeAppointmentStats(appointments) {
                const stats = {
                    total: appointments.length,
                    pending: 0,
                    completed: 0,
                    cancelled: 0,
                    upcoming: 0,
                    overdue: 0,
                    averageBookingTime: 0,
                    timeSlotDistribution: {},
                    purposeDistribution: {},
                    conversionPotential: 0
                };

                const now = new Date();
                let totalBookingTime = 0;

                appointments.forEach(appointment => {
                    const appointmentDate = new Date(appointment.date);
                    const createdDate = new Date(appointment.createdAt);
                    const status = (appointment.status || 'pendiente').toLowerCase();
                    const purpose = appointment.purpose || 'consulta';

                    // Tiempo de reserva (días entre creación y cita)
                    const bookingTime = Math.ceil((appointmentDate - createdDate) / (1000 * 60 * 60 * 24));
                    totalBookingTime += bookingTime;

                    // Estado de la cita
                    switch (status) {
                        case 'pendiente':
                        case 'pending':
                            if (appointmentDate > now) {
                                stats.upcoming++;
                            } else {
                                stats.overdue++;
                            }
                            stats.pending++;
                            break;
                        case 'completada':
                        case 'completed':
                            stats.completed++;
                            break;
                        case 'cancelada':
                        case 'cancelled':
                            stats.cancelled++;
                            break;
                    }

                    // Distribución por horario
                    const hour = appointmentDate.getHours();
                    const timeSlot = hour < 12 ? 'mañana' : hour < 18 ? 'tarde' : 'noche';
                    stats.timeSlotDistribution[timeSlot] = (stats.timeSlotDistribution[timeSlot] || 0) + 1;

                    // Propósito de la cita
                    stats.purposeDistribution[purpose] = (stats.purposeDistribution[purpose] || 0) + 1;
                });

                stats.averageBookingTime = stats.total > 0 ? Math.round(totalBookingTime / stats.total) : 0;
                stats.conversionPotential = stats.total > 0 ? Math.round((stats.completed / stats.total) * 100) : 0;

                return stats;
            }

            // Cálculo de métricas mensuales con conexiones neurales
            calculateMonthlyMetrics(properties, contracts, clients, appointments, currentMonth, currentYear) {
                const monthlyData = {
                    growth: 0,
                    newProperties: 0,
                    newClients: 0,
                    newContracts: 0,
                    newAppointments: 0,
                    conversionRate: 0,
                    activityScore: 0
                };

                // Filtrar datos del mes actual
                const currentMonthProperties = properties.filter(p => {
                    const date = new Date(p.createdAt || p.dateAdded);
                    return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
                });

                const currentMonthClients = clients.filter(c => {
                    const date = new Date(c.createdAt || c.dateAdded);
                    return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
                });

                const currentMonthContracts = contracts.filter(c => {
                    const date = new Date(c.createdAt);
                    return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
                });

                const currentMonthAppointments = appointments.filter(a => {
                    const date = new Date(a.createdAt);
                    return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
                });

                monthlyData.newProperties = currentMonthProperties.length;
                monthlyData.newClients = currentMonthClients.length;
                monthlyData.newContracts = currentMonthContracts.length;
                monthlyData.newAppointments = currentMonthAppointments.length;

                // Cálculo de crecimiento neuronal
                const totalMonthlyActivity = monthlyData.newProperties + monthlyData.newClients + monthlyData.newContracts + monthlyData.newAppointments;
                const totalActivity = properties.length + clients.length + contracts.length + appointments.length;
                
                monthlyData.growth = totalActivity > 0 ? Math.round((totalMonthlyActivity / totalActivity) * 100) : 0;
                
                // Tasa de conversión neuronal (contratos vs clientes nuevos)
                monthlyData.conversionRate = monthlyData.newClients > 0 ? 
                    Math.round((monthlyData.newContracts / monthlyData.newClients) * 100) : 0;
                
                // Puntuación de actividad neuronal (0-100)
                monthlyData.activityScore = Math.min(100, Math.round(
                    (monthlyData.newProperties * 0.3 + 
                     monthlyData.newClients * 0.4 + 
                     monthlyData.newContracts * 0.2 + 
                     monthlyData.newAppointments * 0.1) * 2
                ));

                return monthlyData;
            }

            // ===== ACTUALIZACIÓN DE RESUMEN DE ACTIVIDADES =====
            updateActivitySummary(propertyStats, clientStats, contractStats, appointmentStats, monthlyData) {
                console.log('📊 Actualizando resumen de actividades');
                
                // Resumen de conversión
                const conversionSummary = document.getElementById('conversionSummary');
                if (conversionSummary) {
                    const conversionRate = clientStats.total > 0 ? Math.round((contractStats.total / clientStats.total) * 100) : 0;
                    conversionSummary.textContent = `${conversionRate}%`;
                }

                // Actividad reciente (suma de contratos y citas)
                const recentActivity = document.getElementById('recentActivity');
                if (recentActivity) {
                    const totalActivities = contractStats.active + appointmentStats.upcoming;
                    recentActivity.textContent = totalActivities;
                }

                // Estado de propiedades (propiedades disponibles)
                const propertiesStatus = document.getElementById('propertiesStatus');
                if (propertiesStatus) {
                    propertiesStatus.textContent = propertyStats.available;
                }

                // Rendimiento del mes
                const monthlyPerformance = document.getElementById('monthlyPerformance');
                if (monthlyPerformance) {
                    const performance = Math.round(monthlyData.growth || 0);
                    monthlyPerformance.textContent = `${performance}%`;
                }

                console.log('✅ Resumen de actividades actualizado correctamente');
            }

            // ===== SISTEMA DE REPORTES AVANZADOS =====
            
            async loadReportsData(period = 'month') {
                try {
                    console.log('📊 Cargando datos de reportes para período:', period);
                    
                    const properties = await this.getData('properties');
                    const clients = await this.getData('clients');
                    const contracts = await this.getData('contracts');
                    const appointments = await this.getData('appointments');
                    
                    // Actualizar métricas principales
                    this.updateReportMetrics(properties, clients, contracts, period);
                    
                    // Generar gráficos
                    this.generateRevenueChart(properties, contracts, period);
                    this.generatePropertyTypeChart(properties);
                    this.updatePropertyStatusAnalysis(properties);
                    this.updateTopClients(clients, contracts);
                    this.generateDetailedAnalysis(properties, contracts, period);
                    this.updateKPIs(properties, clients, contracts, appointments);
                    
                    console.log('✅ Datos de reportes cargados correctamente');
                } catch (error) {
                    console.error('❌ Error cargando datos de reportes:', error);
                    this.showNotification('Error cargando reportes', 'error');
                }
            }

            updateReportMetrics(properties, clients, contracts, period) {
                const now = new Date();
                let startDate = new Date();
                
                // Determinar período de análisis
                switch(period) {
                    case 'month':
                        startDate.setMonth(now.getMonth() - 1);
                        break;
                    case 'quarter':
                        startDate.setMonth(now.getMonth() - 3);
                        break;
                    case 'year':
                        startDate.setFullYear(now.getFullYear() - 1);
                        break;
                    default:
                        startDate = new Date(2020, 0, 1); // Todo el período
                }

                // Filtrar datos por período
                const periodProperties = properties.filter(p => {
                    const propDate = new Date(p.dateAdded || p.createdAt || now);
                    return propDate >= startDate;
                });

                const soldProperties = periodProperties.filter(p => 
                    (p.status || '').toLowerCase() === 'vendida' || (p.status || '').toLowerCase() === 'vendido'
                );

                // Calcular métricas
                const totalRevenue = soldProperties.reduce((sum, p) => sum + (p.price || 0), 0);
                const totalSales = soldProperties.length;
                const activeClients = clients.filter(c => {
                    const clientDate = new Date(c.dateAdded || c.createdAt || now);
                    return clientDate >= startDate;
                }).length;

                const avgDealTime = this.calculateAverageDealTime(soldProperties);

                // Actualizar UI
                const totalRevenueEl = document.getElementById('reportsTotalRevenue');
                const totalSalesEl = document.getElementById('reportsTotalSales');
                if (totalRevenueEl) totalRevenueEl.textContent = this.formatCurrency(totalRevenue);
                if (totalSalesEl) totalSalesEl.textContent = totalSales;
                
                const activeClientsEl = document.getElementById('activeClients');
                const avgDealTimeEl = document.getElementById('avgDealTime');
                if (activeClientsEl) activeClientsEl.textContent = activeClients;
                if (avgDealTimeEl) avgDealTimeEl.textContent = avgDealTime + ' días';

                // Calcular badges de crecimiento
                const conversionRate = periodProperties.length > 0 ? Math.round((soldProperties.length / periodProperties.length) * 100) : 0;
                document.getElementById('conversionBadge').textContent = conversionRate + '%';
                
                const growthRate = this.calculateGrowthRate(soldProperties, period);
                const growthBadge = document.getElementById('growthBadge');
                growthBadge.textContent = (growthRate >= 0 ? '+' : '') + growthRate + '%';
                growthBadge.style.backgroundColor = growthRate >= 0 ? 'var(--success)' : 'var(--error)';

                document.getElementById('clientGrowthBadge').textContent = '+' + Math.max(0, activeClients - 5);
            }

            calculateAverageDealTime(soldProperties) {
                if (soldProperties.length === 0) return 0;
                
                const totalDays = soldProperties.reduce((sum, property) => {
                    const addedDate = new Date(property.dateAdded || property.createdAt || new Date());
                    const soldDate = new Date(property.soldDate || new Date());
                    const daysDiff = Math.abs((soldDate - addedDate) / (1000 * 60 * 60 * 24));
                    return sum + daysDiff;
                }, 0);
                
                return Math.round(totalDays / soldProperties.length);
            }

            calculateGrowthRate(soldProperties, period) {
                const now = new Date();
                const currentPeriod = soldProperties.filter(p => {
                    const propDate = new Date(p.dateAdded || p.createdAt || now);
                    if (period === 'month') {
                        return propDate.getMonth() === now.getMonth() && propDate.getFullYear() === now.getFullYear();
                    }
                    return true; // Simplificado para demo
                }).length;

                const previousPeriod = Math.max(1, currentPeriod - 2); // Estimación
                return Math.round(((currentPeriod - previousPeriod) / previousPeriod) * 100);
            }

            generateRevenueChart(properties, contracts, period) {
                try {
                    const container = document.getElementById('revenueChartContainer');
                    if (!container) return;

                    const soldProperties = properties.filter(p => 
                        (p.status || '').toLowerCase() === 'vendida' || (p.status || '').toLowerCase() === 'vendido'
                    );

                    // Generar datos por mes para los últimos 6 meses
                    const chartData = [];
                    const now = new Date();
                    
                    for (let i = 5; i >= 0; i--) {
                        const monthDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
                        const monthName = monthDate.toLocaleDateString('es', { month: 'short' });
                        
                        const monthSales = soldProperties.filter(p => {
                            const propDate = new Date(p.dateAdded || p.createdAt || now);
                            return propDate.getMonth() === monthDate.getMonth() && 
                                   propDate.getFullYear() === monthDate.getFullYear();
                        });

                        const monthRevenue = monthSales.reduce((sum, p) => sum + (p.price || 0), 0);
                        
                        chartData.push({
                            month: monthName,
                            revenue: monthRevenue / 1000000 // En millones
                        });
                    }

                    // Crear gráfico SVG
                    const chartConfig = {
                        type: 'line',
                        data: {
                            labels: chartData.map(d => d.month),
                            datasets: [{
                                label: 'Ingresos (₡ Millones)',
                                data: chartData.map(d => d.revenue),
                                borderColor: '#C9A96E',
                                backgroundColor: 'rgba(201, 169, 110, 0.15)',
                                borderWidth: 3,
                                fill: true,
                                pointBackgroundColor: '#C9A96E',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2,
                                pointRadius: 6
                            }]
                        }
                    };

                    container.innerHTML = '';
                    const chartDiv = document.createElement('div');
                    chartDiv.style.cssText = `
                        position: relative;
                        height: 300px;
                        width: 100%;
                    `;

                    const chart = new CustomChart(chartDiv, chartConfig);
                    chart.createLineChart();
                    container.appendChild(chartDiv);

                } catch (error) {
                    console.error('Error generando gráfico de ingresos:', error);
                }
            }

            generatePropertyTypeChart(properties) {
                const container = document.getElementById('propertyTypeChartContainer');
                if (!container) return;

                const typeData = {};
                let totalValue = 0;
                let totalCommissions = 0;

                // Calcular estadísticas por tipo
                properties.forEach(property => {
                    const type = property.type || 'Otro';
                    const price = parseFloat(property.price) || 0;
                    const commission = this.calculateCommission(property);
                    
                    if (!typeData[type]) {
                        typeData[type] = {
                            count: 0,
                            totalValue: 0,
                            totalCommissions: 0,
                            avgPrice: 0
                        };
                    }
                    
                    typeData[type].count++;
                    typeData[type].totalValue += price;
                    typeData[type].totalCommissions += commission;
                    totalValue += price;
                    totalCommissions += commission;
                });

                // Calcular promedios
                Object.keys(typeData).forEach(type => {
                    typeData[type].avgPrice = typeData[type].totalValue / typeData[type].count;
                });

                // Crear visualización profesional
                let chartHTML = `
                    <div class="property-type-analysis">
                        <div class="analysis-header">
                            <div class="analysis-summary">
                                <div class="summary-item">
                                    <span class="summary-label">Total Propiedades</span>
                                    <span class="summary-value">${properties.length}</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Valor Total</span>
                                    <span class="summary-value">${this.formatCurrency(totalValue)}</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Comisiones Total</span>
                                    <span class="summary-value">${this.formatCurrency(totalCommissions)}</span>
                                </div>
                            </div>
                        </div>
                        <div class="type-breakdown">
                `;

                const colors = ['#C9A96E', '#2ECC71', '#3498DB', '#F39C12', '#E74C3C', '#9B59B6', '#1ABC9C', '#34495E'];
                let colorIndex = 0;

                Object.entries(typeData).forEach(([type, data]) => {
                    const percentage = Math.round((data.count / properties.length) * 100);
                    const valuePercentage = Math.round((data.totalValue / totalValue) * 100);
                    const commissionPercentage = Math.round((data.totalCommissions / totalCommissions) * 100);
                    const color = colors[colorIndex % colors.length];
                    
                    chartHTML += `
                        <div class="type-card" style="border-left: 4px solid ${color};">
                            <div class="type-header">
                                <div class="type-title">
                                    <div class="type-indicator" style="background: ${color};"></div>
                                    <h4>${type}</h4>
                                </div>
                                <div class="type-count">${data.count} ${data.count === 1 ? 'propiedad' : 'propiedades'}</div>
                            </div>
                            
                            <div class="type-stats">
                                <div class="stat-row">
                                    <span class="stat-label">Participación:</span>
                                    <span class="stat-value">${percentage}%</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Valor Promedio:</span>
                                    <span class="stat-value">${this.formatCurrency(data.avgPrice)}</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Valor Total:</span>
                                    <span class="stat-value">${this.formatCurrency(data.totalValue)}</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Comisiones:</span>
                                    <span class="stat-value">${this.formatCurrency(data.totalCommissions)}</span>
                                </div>
                            </div>
                            
                            <div class="progress-bars">
                                <div class="progress-bar-container">
                                    <div class="progress-label">Cantidad (${percentage}%)</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${percentage}%; background: ${color}; animation: progressFill 1.5s ease-out;"></div>
                                    </div>
                                </div>
                                <div class="progress-bar-container">
                                    <div class="progress-label">Valor (${valuePercentage}%)</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${valuePercentage}%; background: linear-gradient(90deg, ${color}, ${color}80); animation: progressFill 2s ease-out;"></div>
                                    </div>
                                </div>
                                <div class="progress-bar-container">
                                    <div class="progress-label">Comisiones (${commissionPercentage}%)</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${commissionPercentage}%; background: linear-gradient(90deg, ${color}, ${color}60); animation: progressFill 2.5s ease-out;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    colorIndex++;
                });

                chartHTML += `
                        </div>
                    </div>
                    
                    <style>
                        .property-type-analysis {
                            font-family: 'Inter', sans-serif;
                        }
                        
                        .analysis-header {
                            margin-bottom: 1.5rem;
                            padding: 1rem;
                            background: linear-gradient(135deg, var(--primary-light), var(--primary));
                            border-radius: 12px;
                            color: white;
                        }
                        
                        .analysis-summary {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                            gap: 1rem;
                        }
                        
                        .summary-item {
                            text-align: center;
                        }
                        
                        .summary-label {
                            display: block;
                            font-size: 0.875rem;
                            opacity: 0.9;
                            margin-bottom: 0.5rem;
                        }
                        
                        .summary-value {
                            display: block;
                            font-size: 1.25rem;
                            font-weight: 600;
                        }
                        
                        .type-breakdown {
                            display: grid;
                            gap: 1rem;
                        }
                        
                        .type-card {
                            background: var(--card-background);
                            border-radius: 12px;
                            padding: 1.25rem;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                            transition: transform 0.2s ease, box-shadow 0.2s ease;
                        }
                        
                        .type-card:hover {
                            transform: translateY(-2px);
                            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
                        }
                        
                        .type-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 1rem;
                        }
                        
                        .type-title {
                            display: flex;
                            align-items: center;
                            gap: 0.75rem;
                        }
                        
                        .type-indicator {
                            width: 12px;
                            height: 12px;
                            border-radius: 50%;
                        }
                        
                        .type-title h4 {
                            margin: 0;
                            color: var(--text-primary);
                            font-weight: 600;
                        }
                        
                        .type-count {
                            background: var(--background);
                            padding: 0.25rem 0.75rem;
                            border-radius: 20px;
                            font-size: 0.875rem;
                            color: var(--text-secondary);
                            font-weight: 500;
                        }
                        
                        .type-stats {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 0.5rem;
                            margin-bottom: 1rem;
                        }
                        
                        .stat-row {
                            display: flex;
                            justify-content: space-between;
                            padding: 0.5rem 0;
                        }
                        
                        .stat-label {
                            color: var(--text-muted);
                            font-size: 0.875rem;
                        }
                        
                        .stat-value {
                            color: var(--text-primary);
                            font-weight: 500;
                            font-size: 0.875rem;
                        }
                        
                        .progress-bars {
                            margin-top: 1rem;
                        }
                        
                        .progress-bar-container {
                            margin-bottom: 0.75rem;
                        }
                        
                        .progress-label {
                            font-size: 0.75rem;
                            color: var(--text-muted);
                            margin-bottom: 0.25rem;
                        }
                        
                        .progress-bar {
                            height: 6px;
                            background: rgba(201, 169, 110, 0.1);
                            border-radius: 3px;
                            overflow: hidden;
                        }
                        
                        .progress-fill {
                            height: 100%;
                            border-radius: 3px;
                            transition: width 0.3s ease;
                        }
                        
                        @keyframes progressFill {
                            from { width: 0%; }
                        }
                    </style>
                `;

                container.innerHTML = chartHTML;
            }

            updatePropertyStatusAnalysis(properties) {
                const container = document.getElementById('propertyStatusContainer');
                if (!container) return;

                const statusData = {
                    'Disponible': { count: 0, totalValue: 0, totalCommissions: 0 },
                    'Vendida': { count: 0, totalValue: 0, totalCommissions: 0 },
                    'Reservada': { count: 0, totalValue: 0, totalCommissions: 0 },
                    'En Negociación': { count: 0, totalValue: 0, totalCommissions: 0 }
                };

                let totalValue = 0;
                let totalCommissions = 0;

                // Calcular estadísticas por estado
                properties.forEach(property => {
                    const status = this.normalizeStatus(property.status || 'Disponible');
                    const price = parseFloat(property.price) || 0;
                    const commission = this.calculateCommission(property);
                    
                    if (statusData[status]) {
                        statusData[status].count++;
                        statusData[status].totalValue += price;
                        statusData[status].totalCommissions += commission;
                        totalValue += price;
                        totalCommissions += commission;
                    }
                });

                // Crear visualización profesional
                let statusHTML = `
                    <div class="status-analysis">
                        <div class="analysis-header">
                            <div class="analysis-summary">
                                <div class="summary-item">
                                    <span class="summary-label">Total Propiedades</span>
                                    <span class="summary-value">${properties.length}</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Valor Total</span>
                                    <span class="summary-value">${this.formatCurrency(totalValue)}</span>
                                </div>
                            </div>
                        </div>
                        <div class="status-breakdown">
                `;

                const statusColors = {
                    'Disponible': '#2ECC71',
                    'Vendida': '#E74C3C',
                    'Reservada': '#F39C12',
                    'En Negociación': '#C9A96E'
                };

                const statusIcons = {
                    'Disponible': 'fas fa-home',
                    'Vendida': 'fas fa-check-circle',
                    'Reservada': 'fas fa-clock',
                    'En Negociación': 'fas fa-handshake'
                };

                Object.entries(statusData).forEach(([status, data]) => {
                    const percentage = properties.length > 0 ? Math.round((data.count / properties.length) * 100) : 0;
                    const valuePercentage = totalValue > 0 ? Math.round((data.totalValue / totalValue) * 100) : 0;
                    const color = statusColors[status];
                    const icon = statusIcons[status];
                    
                    statusHTML += `
                        <div class="status-card" style="border-left: 4px solid ${color};">
                            <div class="status-header">
                                <div class="status-title">
                                    <i class="${icon}" style="color: ${color};"></i>
                                    <h4>${status}</h4>
                                </div>
                                <div class="status-count">${data.count} ${data.count === 1 ? 'propiedad' : 'propiedades'}</div>
                            </div>
                            
                            <div class="status-stats">
                                <div class="stat-row">
                                    <span class="stat-label">Participación:</span>
                                    <span class="stat-value">${percentage}%</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Valor Total:</span>
                                    <span class="stat-value">${this.formatCurrency(data.totalValue)}</span>
                                </div>
                                ${data.totalCommissions > 0 ? `
                                <div class="stat-row">
                                    <span class="stat-label">Comisiones:</span>
                                    <span class="stat-value">${this.formatCurrency(data.totalCommissions)}</span>
                                </div>
                                ` : ''}
                            </div>
                            
                            <div class="progress-bars">
                                <div class="progress-bar-container">
                                    <div class="progress-label">Cantidad (${percentage}%)</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${percentage}%; background: ${color}; animation: progressFill 1.5s ease-out;"></div>
                                    </div>
                                </div>
                                ${totalValue > 0 ? `
                                <div class="progress-bar-container">
                                    <div class="progress-label">Valor (${valuePercentage}%)</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${valuePercentage}%; background: linear-gradient(90deg, ${color}, ${color}80); animation: progressFill 2s ease-out;"></div>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });

                statusHTML += `
                        </div>
                    </div>
                    
                    <style>
                        .status-analysis {
                            font-family: 'Inter', sans-serif;
                        }
                        
                        .status-analysis .analysis-header {
                            margin-bottom: 1.5rem;
                            padding: 1rem;
                            background: linear-gradient(135deg, var(--primary-light), var(--primary));
                            border-radius: 12px;
                            color: white;
                        }
                        
                        .status-analysis .analysis-summary {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                            gap: 1rem;
                        }
                        
                        .status-analysis .summary-item {
                            text-align: center;
                        }
                        
                        .status-analysis .summary-label {
                            display: block;
                            font-size: 0.875rem;
                            opacity: 0.9;
                            margin-bottom: 0.5rem;
                        }
                        
                        .status-analysis .summary-value {
                            display: block;
                            font-size: 1.25rem;
                            font-weight: 600;
                        }
                        
                        .status-breakdown {
                            display: grid;
                            gap: 1rem;
                        }
                        
                        .status-card {
                            background: var(--card-background);
                            border-radius: 12px;
                            padding: 1.25rem;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                            transition: transform 0.2s ease, box-shadow 0.2s ease;
                        }
                        
                        .status-card:hover {
                            transform: translateY(-2px);
                            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
                        }
                        
                        .status-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 1rem;
                        }
                        
                        .status-title {
                            display: flex;
                            align-items: center;
                            gap: 0.75rem;
                        }
                        
                        .status-title h4 {
                            margin: 0;
                            color: var(--text-primary);
                            font-weight: 600;
                        }
                        
                        .status-count {
                            background: var(--background);
                            padding: 0.25rem 0.75rem;
                            border-radius: 20px;
                            font-size: 0.875rem;
                            color: var(--text-secondary);
                            font-weight: 500;
                        }
                        
                        .status-stats {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 0.5rem;
                            margin-bottom: 1rem;
                        }
                        
                        .status-stats .stat-row {
                            display: flex;
                            justify-content: space-between;
                            padding: 0.5rem 0;
                        }
                        
                        .status-stats .stat-label {
                            color: var(--text-muted);
                            font-size: 0.875rem;
                        }
                        
                        .status-stats .stat-value {
                            color: var(--text-primary);
                            font-weight: 500;
                            font-size: 0.875rem;
                        }
                    </style>
                `;

                container.innerHTML = statusHTML;
            }

            // Función helper para normalizar estados
            normalizeStatus(status) {
                const normalizedStatus = status.toLowerCase();
                if (normalizedStatus.includes('vendida') || normalizedStatus.includes('vendido')) {
                    return 'Vendida';
                } else if (normalizedStatus.includes('reservada')) {
                    return 'Reservada';
                } else if (normalizedStatus.includes('negociacion') || normalizedStatus.includes('negociación')) {
                    return 'En Negociación';
                } else if (normalizedStatus.includes('disponible')) {
                    return 'Disponible';
                } else {
                    return 'Disponible'; // Por defecto
                }
            }

            updateTopClients(clients, contracts) {
                const container = document.getElementById('topClientsContainer');
                if (!container) return;

                // Calcular actividad real de clientes basada en contratos
                const clientActivity = clients.map(client => {
                    // Buscar contratos de este cliente
                    const clientContracts = contracts.filter(contract => 
                        contract.clientId === client.id || 
                        contract.client === client.name ||
                        contract.clientName === client.name
                    );

                    // Calcular valor total de contratos
                    const totalValue = clientContracts.reduce((sum, contract) => {
                        return sum + (parseFloat(contract.price) || parseFloat(contract.amount) || 0);
                    }, 0);

                    // Calcular número de propiedades/contratos
                    const propertyCount = clientContracts.length;

                    // Calcular fecha del último contrato
                    const lastActivity = clientContracts.length > 0 ? 
                        Math.max(...clientContracts.map(c => new Date(c.dateAdded || c.createdAt || new Date()).getTime())) :
                        new Date(client.dateAdded || client.createdAt || new Date()).getTime();

                    return {
                        ...client,
                        contractCount: propertyCount,
                        totalValue: totalValue,
                        lastActivity: lastActivity,
                        hasActivity: propertyCount > 0 || totalValue > 0
                    };
                })
                .filter(client => client.hasActivity) // Solo clientes con actividad
                .sort((a, b) => {
                    // Ordenar por valor total, luego por número de contratos
                    if (b.totalValue !== a.totalValue) {
                        return b.totalValue - a.totalValue;
                    }
                    return b.contractCount - a.contractCount;
                })
                .slice(0, 5); // Top 5

                let clientsHTML = '<div style="padding: 1rem;">';

                if (clientActivity.length === 0) {
                    clientsHTML += `
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h4>Sin actividad de clientes</h4>
                            <p>Los datos aparecerán cuando haya contratos registrados</p>
                        </div>
                    `;
                } else {
                    clientActivity.forEach((client, index) => {
                        const rankColors = ['var(--warning)', 'var(--border-light)', '#CD7F32', 'var(--success)', 'var(--primary)'];
                        const rankColor = rankColors[index] || 'var(--primary)';
                        
                        // Determinar ícono de ranking
                        const rankIcon = index < 3 ? 
                            `<i class="fas fa-trophy" style="font-size: 0.7rem;"></i>` : 
                            (index + 1);

                        // Formatear última actividad
                        const lastActivityDate = new Date(client.lastActivity);
                        const daysSinceActivity = Math.floor((new Date() - lastActivityDate) / (1000 * 60 * 60 * 24));
                        const activityText = daysSinceActivity === 0 ? 'Hoy' : 
                                           daysSinceActivity === 1 ? 'Ayer' :
                                           daysSinceActivity < 7 ? `${daysSinceActivity} días` :
                                           daysSinceActivity < 30 ? `${Math.floor(daysSinceActivity / 7)} semanas` :
                                           `${Math.floor(daysSinceActivity / 30)} meses`;

                        clientsHTML += `
                            <div style="display: flex; align-items: center; padding: 1rem; margin-bottom: 1rem; background: rgba(201, 169, 110, 0.05); border-radius: 8px; border-left: 3px solid ${rankColor};">
                                <div style="width: 40px; height: 40px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 1rem; color: white; font-weight: 600; position: relative;">
                                    ${client.name.charAt(0).toUpperCase()}
                                    <div style="position: absolute; top: -4px; right: -4px; width: 16px; height: 16px; background: ${rankColor}; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.6rem; font-weight: 700; border: 2px solid var(--bg-card);">
                                        ${index + 1}
                                    </div>
                                </div>
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                        <div style="color: var(--text-primary); font-weight: 600;">${client.name}</div>
                                        ${index < 3 ? `<i class="fas fa-crown" style="color: ${rankColor}; font-size: 0.875rem;"></i>` : ''}
                                    </div>
                                    <div style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 0.25rem;">${client.email || 'Sin email'}</div>
                                    <div style="color: var(--text-secondary); font-size: 0.875rem; display: flex; gap: 1rem;">
                                        <span><i class="fas fa-handshake" style="margin-right: 0.25rem;"></i>${client.contractCount} contrato${client.contractCount !== 1 ? 's' : ''}</span>
                                        <span><i class="fas fa-coins" style="margin-right: 0.25rem;"></i>${this.formatCurrency(client.totalValue)}</span>
                                    </div>
                                    <div style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.25rem;">
                                        <i class="fas fa-clock" style="margin-right: 0.25rem;"></i>Última actividad: ${activityText}
                                    </div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="width: 32px; height: 32px; background: ${rankColor}; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; box-shadow: 0 2px 8px rgba(201, 169, 110, 0.3);">
                                        ${rankIcon}
                                    </div>
                                    <div style="font-size: 0.65rem; color: var(--text-muted); margin-top: 0.25rem; font-weight: 600;">
                                        TOP ${index + 1}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }

                clientsHTML += '</div>';
                container.innerHTML = clientsHTML;
            }

            generateDetailedAnalysis(properties, contracts, period) {
                const tableBody = document.getElementById('detailedAnalysisTable');
                if (!tableBody) return;

                const now = new Date();
                const periods = [];

                // Generar datos para los últimos 6 meses
                for (let i = 5; i >= 0; i--) {
                    const periodDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    const periodName = periodDate.toLocaleDateString('es', { month: 'long', year: 'numeric' });
                    
                    const periodProperties = properties.filter(p => {
                        const propDate = new Date(p.dateAdded || p.createdAt || now);
                        return propDate.getMonth() === periodDate.getMonth() && 
                               propDate.getFullYear() === periodDate.getFullYear();
                    });

                    const soldProperties = periodProperties.filter(p => 
                        (p.status || '').toLowerCase() === 'vendida' || (p.status || '').toLowerCase() === 'vendido'
                    );

                    const revenue = soldProperties.reduce((sum, p) => sum + (p.price || 0), 0);
                    const avgPrice = soldProperties.length > 0 ? revenue / soldProperties.length : 0;
                    const conversion = periodProperties.length > 0 ? Math.round((soldProperties.length / periodProperties.length) * 100) : 0;

                    periods.push({
                        name: periodName,
                        sold: soldProperties.length,
                        revenue: revenue,
                        avgPrice: avgPrice,
                        margin: Math.round(Math.random() * 20 + 15), // Simulado
                        conversion: conversion
                    });
                }

                let tableHTML = '';
                periods.forEach(period => {
                    tableHTML += `
                        <tr>
                            <td style="font-weight: 600; color: var(--text-primary);">${period.name}</td>
                            <td style="text-align: center;">${period.sold}</td>
                            <td style="text-align: right; color: var(--success); font-weight: 600;">${this.formatCurrency(period.revenue)}</td>
                            <td style="text-align: right;">${this.formatCurrency(period.avgPrice)}</td>
                            <td style="text-align: center; color: var(--primary);">${period.margin}%</td>
                            <td style="text-align: center;">
                                <span class="status-badge ${period.conversion >= 50 ? 'status-disponible' : period.conversion >= 20 ? 'status-reservada' : 'status-vendida'}">
                                    ${period.conversion}%
                                </span>
                            </td>
                        </tr>
                    `;
                });

                tableBody.innerHTML = tableHTML;
            }

            updateKPIs(properties, clients, contracts, appointments) {
                // Tasa de cierre
                const soldProperties = properties.filter(p => 
                    (p.status || '').toLowerCase() === 'vendida' || (p.status || '').toLowerCase() === 'vendido'
                );
                const closingRate = properties.length > 0 ? Math.round((soldProperties.length / properties.length) * 100) : 0;
                document.getElementById('closingRate').textContent = closingRate + '%';

                // Tiempo de respuesta promedio (simulado)
                const avgResponseTime = Math.floor(Math.random() * 24) + 1;
                document.getElementById('avgResponseTime').textContent = avgResponseTime + 'h';

                // Mejor mes
                const bestMonth = 'Septiembre'; // Simplificado
                document.getElementById('bestMonth').textContent = bestMonth;

                // Meta mensual - Calcular correctamente usando el sistema de comisiones
                const currentDate = new Date();
                const currentMonth = currentDate.getMonth();
                const currentYear = currentDate.getFullYear();
                const monthlyGoalTarget = 10000; // USD
                const usdToColones = 520;
                
                // Filtrar ventas del mes actual
                const monthlyProperties = properties.filter(prop => {
                    const propDate = new Date(prop.dateAdded || prop.createdAt);
                    return propDate.getMonth() === currentMonth && 
                           propDate.getFullYear() === currentYear && 
                           ((prop.status || '').toLowerCase() === 'vendida' || 
                            (prop.status || '').toLowerCase() === 'vendido');
                });
                
                // Calcular comisiones del mes usando el sistema real
                const monthlyCommissionColones = this.getTotalCommissions(monthlyProperties);
                const monthlyCommissionUSD = monthlyCommissionColones / usdToColones;
                const goalProgress = Math.min((monthlyCommissionUSD / monthlyGoalTarget) * 100, 100);
                
                document.getElementById('monthlyGoal').textContent = Math.round(goalProgress) + '%';
            }

            // Funciones de control de reportes
            updateReportPeriod(period) {
                console.log('📊 Actualizando período de reportes:', period);
                this.loadReportsData(period);
            }

            updateRevenueChart(chartType) {
                console.log('📈 Actualizando tipo de gráfico:', chartType);
                // Recargar con nuevo tipo
                this.loadReportsData();
            }

            refreshDetailedAnalysis() {
                console.log('🔄 Refrescando análisis detallado');
                this.showNotification('Actualizando análisis...', 'info');
                setTimeout(() => {
                    this.loadReportsData();
                    this.showNotification('Análisis actualizado', 'success');
                }, 1000);
            }

            async exportReport() {
                try {
                    this.showNotification('Generando reporte... Por favor espere', 'info', 3000);
                    
                    // Obtener datos actualizados
                    const [properties, clients, contracts, appointments] = await Promise.all([
                        this.getData('properties'),
                        this.getData('clients'),
                        this.getData('contracts'),
                        this.getData('appointments')
                    ]);

                    // Obtener período seleccionado
                    const period = document.getElementById('reportPeriod')?.value || 'month';
                    
                    // Calcular métricas
                    const currentDate = new Date();
                    let startDate = new Date();
                    let periodName = '';
                    
                    switch(period) {
                        case 'month':
                            startDate.setMonth(currentDate.getMonth() - 1);
                            periodName = 'Último Mes';
                            break;
                        case 'quarter':
                            startDate.setMonth(currentDate.getMonth() - 3);
                            periodName = 'Último Trimestre';
                            break;
                        case 'year':
                            startDate.setFullYear(currentDate.getFullYear() - 1);
                            periodName = 'Último Año';
                            break;
                        default:
                            startDate = new Date(2020, 0, 1);
                            periodName = 'Todo el Período';
                    }

                    // Filtrar datos por período
                    const periodProperties = properties.filter(p => {
                        const propDate = new Date(p.dateAdded || p.createdAt || currentDate);
                        return propDate >= startDate;
                    });

                    const soldProperties = periodProperties.filter(p => 
                        (p.status || '').toLowerCase() === 'vendida' || (p.status || '').toLowerCase() === 'vendido'
                    );

                    // Calcular estadísticas
                    const stats = {
                        totalProperties: periodProperties.length,
                        soldProperties: soldProperties.length,
                        availableProperties: periodProperties.filter(p => 
                            (p.status || '').toLowerCase() === 'disponible' || (p.status || '').toLowerCase() === 'available'
                        ).length,
                        reservedProperties: periodProperties.filter(p => 
                            (p.status || '').toLowerCase() === 'reservada' || (p.status || '').toLowerCase() === 'reserved'
                        ).length,
                        totalRevenue: soldProperties.reduce((sum, p) => sum + (p.price || 0), 0),
                        avgPrice: soldProperties.length > 0 ? Math.round(soldProperties.reduce((sum, p) => sum + (p.price || 0), 0) / soldProperties.length) : 0,
                        totalClients: clients.length,
                        totalContracts: contracts.length,
                        totalAppointments: appointments.length,
                        conversionRate: periodProperties.length > 0 ? Math.round((soldProperties.length / periodProperties.length) * 100) : 0
                    };

                    // Crear contenido del reporte
                    const reportContent = `
# 📊 REPORTE CRM AJHB - ${periodName}
**Generado el:** ${currentDate.toLocaleDateString('es-ES')} a las ${currentDate.toLocaleTimeString('es-ES')}

## 📈 RESUMEN EJECUTIVO
- **Período Analizado:** ${periodName} (${startDate.toLocaleDateString('es-ES')} - ${currentDate.toLocaleDateString('es-ES')})
- **Propiedades Gestionadas:** ${stats.totalProperties}
- **Ventas Completadas:** ${stats.soldProperties}
- **Tasa de Conversión:** ${stats.conversionRate}%
- **Ingresos Totales:** ${this.formatCurrency(stats.totalRevenue)}

## 🏠 ANÁLISIS DE PROPIEDADES
- **Total de Propiedades:** ${stats.totalProperties}
- **Vendidas:** ${stats.soldProperties}
- **Disponibles:** ${stats.availableProperties}
- **Reservadas:** ${stats.reservedProperties}
- **Precio Promedio:** ${this.formatCurrency(stats.avgPrice)}

## 👥 GESTIÓN DE CLIENTES
- **Total de Clientes:** ${stats.totalClients}
- **Contratos Generados:** ${stats.totalContracts}
- **Citas Programadas:** ${stats.totalAppointments}

## 🎯 META MENSUAL DE COMISIONES
- **Meta Establecida:** $5,000 USD
- **Sistema de Comisiones Diferenciadas (Asesor recibe 50%):**
  - Ventas: 3.5% de comisión para el asesor (7% total)
  - Compras para Cartelera: 1.5% de comisión para el asesor (3% total)  
  - Arriendos por Día: 2.5% de comisión para el asesor (5% total)
- **Comisiones del Asesor Generadas:** ${this.formatCurrency(this.getTotalCommissions(soldProperties))} (≈$${Math.round(this.getTotalCommissions(soldProperties) / 520).toLocaleString()})
- **Progreso de Meta:** ${Math.min(100, Math.round((this.getTotalCommissions(soldProperties) / 520) / 10000 * 100))}%

## 📋 DETALLE DE PROPIEDADES VENDIDAS
${soldProperties.length > 0 ? soldProperties.map((prop, index) => {
    const commission = this.calculateCommission(prop);
    const commissionUSD = commission / 520;
    return `
${index + 1}. **${prop.type || 'Sin especificar'}** - ${prop.address || 'Sin dirección'}
   - Operación: ${this.getOperationLabel(prop.operation) || 'Sin especificar'}
   - Precio: ${this.formatCurrency(prop.price || 0)}
   - Comisión: ${this.formatCurrency(commission)} (≈$${commissionUSD.toFixed(0)})
   - Fecha: ${new Date(prop.dateAdded || prop.createdAt).toLocaleDateString('es-ES')}
   - Estado: ${prop.status || 'N/A'}
`;}).join('') : 'No hay propiedades vendidas en este período.'}

## 📞 ACTIVIDAD DE CLIENTES
${clients.slice(0, 10).map((client, index) => `
${index + 1}. **${client.name}**
   - Email: ${client.email || 'Sin email'}
   - Teléfono: ${client.phone || 'Sin teléfono'}
   - Registro: ${new Date(client.dateAdded || client.createdAt).toLocaleDateString('es-ES')}
`).join('')}
${clients.length > 10 ? `\n... y ${clients.length - 10} clientes más.` : ''}

---
*Reporte generado automáticamente por CRM AJHB*
*Sistema Inmobiliario Profesional*
                    `;

                    // Crear y descargar archivo
                    const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    
                    const fileName = `Reporte_CRM_AJHB_${periodName.replace(/\s+/g, '_')}_${currentDate.toISOString().split('T')[0]}.txt`;
                    link.download = fileName;
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);

                    this.showNotification(`Reporte exportado exitosamente: ${fileName}`, 'success', 6000);
                    console.log('📤 Reporte exportado:', fileName);

                } catch (error) {
                    console.error('Error exportando reporte:', error);
                    this.showNotification('Error al exportar el reporte', 'error');
                }
            }
        }

        // ===== FUNCIONES GLOBALES =====
        let crm;

        // Funciones para compatibilidad con HTML
        function switchSection(section) {
            crm.switchSection(section);
        }

        function toggleSidebar() {
            crm.toggleSidebar();
        }

        function closeSidebar() {
            crm.closeSidebar();
        }

        function closeModal(modalId) {
            crm.closeModal(modalId);
        }

        function showAddPropertyModal() {
            crm.showAddPropertyModal();
        }

        function showAddClientModal() {
            crm.showAddClientModal();
        }

        function showAddContractModal() {
            crm.showAddContractModal();
        }

        function showAddProspectModal() {
            crm.showAddProspectModal();
        }

        function showAddAppointmentModal() {
            crm.showAddAppointmentModal();
        }

        // ===== INICIALIZACIÓN =====
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('📄 DOM cargado, iniciando sistema CRM...');
                
                // Verificación previa de soporte del navegador
                if (!window.indexedDB) {
                    throw new Error('IndexedDB no está disponible en este navegador');
                }
                
                crm = new CRMSystem();
                
                // Usar el método init() que maneja toda la inicialización
                await crm.init();
                
                console.log('🚀 Sistema CRM completamente iniciado');
                
            } catch (error) {
                console.error('❌ Error crítico al inicializar el sistema:', error);
                
                // Mostrar página de error personalizada para errores de base de datos
                if (error.message.includes('IndexedDB') || error.name === 'SecurityError' || error.name === 'NotSupportedError') {
                    document.body.style.cssText = `
                        margin: 0;
                        padding: 0;
                        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        background: #1a1a1a;
                        color: #F8F9FA;
                        min-height: 100vh;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    `;
                    
                    document.body.innerHTML = `
                        <div style="
                            background: #2a2a2a;
                            border: 1px solid #C9A96E;
                            border-radius: 12px;
                            padding: 2rem;
                            max-width: 600px;
                            width: 90%;
                            text-align: center;
                            box-shadow: 0 20px 25px -5px rgba(201, 169, 110, 0.1);
                        ">
                            <div style="
                                width: 80px;
                                height: 80px;
                                margin: 0 auto 2rem;
                                background: #E74C3C;
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 2rem;
                                color: white;
                            ">
                                ⚠️
                            </div>
                            
                            <h1 style="
                                margin: 0 0 1rem 0;
                                color: #F8F9FA;
                                font-size: 2rem;
                                font-weight: 700;
                            ">Error Crítico de Sistema</h1>
                            
                            <p style="
                                margin: 0 0 2rem 0;
                                color: #E5D5B7;
                                font-size: 1.125rem;
                                line-height: 1.6;
                            ">No se puede inicializar la base de datos local del CRM.</p>
                            
                            <div style="
                                background: #3a3a3a;
                                border: 1px solid #C9A96E;
                                border-radius: 8px;
                                padding: 1.5rem;
                                margin-bottom: 2rem;
                                text-align: left;
                            ">
                                <h3 style="
                                    margin: 0 0 1rem 0;
                                    color: #C9A96E;
                                    font-size: 1.125rem;
                                ">💡 Soluciones recomendadas:</h3>
                                <ol style="
                                    margin: 0;
                                    padding-left: 1.5rem;
                                    color: #E5D5B7;
                                    line-height: 1.6;
                                ">
                                    <li><strong>Usa un navegador moderno:</strong> Chrome, Firefox, Edge o Safari actualizado</li>
                                    <li><strong>Habilita JavaScript:</strong> Verifica en configuración del navegador</li>
                                    <li><strong>Limpia caché:</strong> Ctrl+Shift+Supr y limpia todo</li>
                                    <li><strong>Modo incógnito:</strong> Prueba abriendo en ventana privada</li>
                                    <li><strong>Desactiva extensiones:</strong> Pueden interferir con IndexedDB</li>
                                </ol>
                                
                                <div style="
                                    margin-top: 1rem;
                                    padding: 1rem;
                                    background: rgba(231, 76, 60, 0.1);
                                    border-left: 4px solid #E74C3C;
                                    border-radius: 4px;
                                ">
                                    <strong>Error técnico:</strong> ${error.message}
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                                <button onclick="location.reload()" style="
                                    background: linear-gradient(135deg, #C9A96E 0%, #B8956A 100%);
                                    color: white;
                                    border: none;
                                    padding: 1rem 2rem;
                                    border-radius: 8px;
                                    font-weight: 600;
                                    font-size: 1rem;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(201, 169, 110, 0.3)'" 
                                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                    🔄 Reintentar
                                </button>
                                
                                <button onclick="window.open('https://www.google.com/chrome/', '_blank')" style="
                                    background: transparent;
                                    color: #C9A96E;
                                    border: 2px solid #C9A96E;
                                    padding: 1rem 2rem;
                                    border-radius: 8px;
                                    font-weight: 600;
                                    font-size: 1rem;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                " onmouseover="this.style.background='rgba(201, 169, 110, 0.1)'; this.style.transform='translateY(-2px)'" 
                                   onmouseout="this.style.background='transparent'; this.style.transform='translateY(0)'">
                                    📥 Descargar Chrome
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    // Error genérico
                    console.error('Error genérico:', error);
                    alert(`Error al inicializar el sistema: ${error.message}`);
                }
            }
        });

        // ===== MANEJO DE ERRORES GLOBALES =====
        window.addEventListener('error', function(e) {
            console.error('Error global:', e.error);
            // Solo mostrar notificaciones para errores críticos
            if (e.error && e.error.name && ['SecurityError', 'NotSupportedError', 'TypeError'].includes(e.error.name)) {
                console.warn('Error crítico detectado:', e.error.message);
            }
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('Promise rechazada:', e.reason);
            // Prevenir que se muestren errores de database vacía
            if (e.reason && typeof e.reason === 'string' && 
                (e.reason.includes('No data found') || e.reason.includes('empty') || e.reason.includes('not found'))) {
                e.preventDefault(); // Evitar que se propague
            }
        });
    </script>
</body>
</html>
